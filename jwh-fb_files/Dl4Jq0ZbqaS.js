/*1314726037,169776317*/

if (window.CavalryLogger) { CavalryLogger.start_js(["s70w1"]); }

function BuddyListNub(){this.parent.construct(this);}Class.extend(BuddyListNub,'NubController');copy_properties(BuddyListNub,{ITEM_HEIGHT:32,TYPEAHEAD_MIN_FRIENDS:10,TYPEAHEAD_MIN_FRIENDS_FLMODE:20});BuddyListNub.prototype={init:function(b,a,d){this.parent.init(b);this.root=b;this.buddyList=a;this.typeahead=d;this.button=DOM.find(b,'a.fbNubButton');this.label=DOM.find(b,'span.label');if(ChatConfig.get('sidebar')){this.body=DOM.scry(b,'div.fbNubFlyoutBody')[0];var c=DOM.find(b,'div.fbNubFlyoutTitlebar');Toggler.createInstance(c).setSticky(false);a.setScrollContainer(this.body);}else this.throbber=DOM.scry(b,'img.throbber')[0];a.subscribe('content-changed',this.flyoutContentChanged.bind(this));Arbiter.subscribe('buddylist/count-changed',this._updateCount.bind(this));Arbiter.subscribe('chat/connect',this._handleConnect.bind(this));Arbiter.subscribe('chat/visibility-changed',this._handleVisibility.bind(this));Event.listen(b,'keydown',this._onKeyDown.bind(this));Event.listen(this.button,'click',this.onButtonClick.bind(this));d.subscribe(['respond','reset'],function(e,f){if(this._isOpen){if(f&&f.value&&f.value===d.getCore().getValue()&&d.getView().isVisible()){if(ChatConfig.get('sidebar'))Dock.setUseMaxHeight(this.root,false);this.buddyList.hide();}else{if(ChatConfig.get('sidebar'))Dock.setUseMaxHeight(this.root,true);this.buddyList.show();}this.flyoutContentChanged();}}.bind(this));this.subscribe('show',this.onShow.bind(this));this.subscribe('hide',this.onHide.bind(this));this.subscribe('resize',this.onResize.bind(this));if(ChatConfig.get('sidebar')){Arbiter.subscribe('sidebar/show',this.hide.bind(this));}else{Arbiter.subscribe('chat-options/initialized',function(e,f){this.setSticky(!!f.getSetting('sticky_buddylist'));}.bind(this));Arbiter.subscribe('chat/option-changed',function(e,f){f.name==='sticky_buddylist'&&this.setSticky(!!f.value);}.bind(this));presence.registerStateStorer(this._storeState.bind(this));presence.registerStateLoader(this._loadState.bind(this));this._loadState(presence.state);}Arbiter.inform('buddylist-nub/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);},getButton:function(){return this.button;},getRoot:function(){return this.root;},getSticky:function(){return !!this._sticky;},_handleConnect:function(a){this._setLabel(_tx("Chat"),true);},_handleVisibility:function(){var a=Chat.isOnline();if(!a){this._setLabel(_tx("{Chat} (Offline)",{Chat:_tx("Chat")}));this.hide();}else this._setLabel(_tx("Chat"));CSS.conditionClass(presence.holder,'offline',!a);},_loadState:function(b){var a=!!b.blo;if(!presence.poppedOut)if(a){this.show();}else this.hide();},onButtonClick:function(){if(CSS.shown(this.typeahead.getElement())){var a=this.subscribe('show',function(){this.typeahead.getCore().getElement().focus();}.bind(this));this.unsubscribe.bind(this,a).defer();}},onHide:function(){this._isOpen=false;this.buddyList.subscribe('initialized',function(){this.buddyList.hide();}.bind(this));this.typeahead.getCore().reset();presence.doSync();},_onKeyDown:function(event){var a=Event.getKeyCode(event);if(a===KEYS.ESC&&!CSS.hasClass(this.root,'menuOpened')){this.hide();return false;}},onResize:function(){if(ChatConfig.get('sidebar')){var a=Vector2.getElementDimensions(this.body).y-5;this.buddyList.setNumTopFriends(Math.floor(a/BuddyListNub.ITEM_HEIGHT));}},onShow:function(){this._isOpen=true;Chat.goOnline(function(){this.buddyList.subscribe('initialized',function(){if(ChatConfig.get('sidebar'))Dock.setUseMaxHeight(this.root,true);this.buddyList.show();}.bind(this));presence.doSync();}.bind(this));},_setLabel:function(a,c){var b=this.label.cloneNode(true);DOM.setContent(b,a);DOM.replace(this.label,b);this.label=b;this.throbber&&CSS.conditionShow(this.throbber,!!c);},setSticky:function(a){if(!this._toggler)this._toggler=Toggler.createInstance(this.root);this._toggler.setSticky(a);this._sticky=a;},_storeState:function(a){a.blo=this._isOpen?1:0;return a;},_updateCount:function(){if(!Chat.isOnline())return;var a=AvailableList.getAvailableIDs().filter(function(d){return AvailableList.get(d)===AvailableList.ACTIVE;}).length;var b=_tx("{Chat} {number-available}",{Chat:_tx("Chat"),'number-available':['<span class="count">','(<strong>',a,'</strong>)','</span>'].join('')});this._setLabel(HTML(b));var c=this.buddyList.flMode?BuddyListNub.TYPEAHEAD_MIN_FRIENDS_FLMODE:BuddyListNub.TYPEAHEAD_MIN_FRIENDS;CSS.conditionShow(this.typeahead.getElement(),a>=c);}};
function ChatTabActions(a){this._container=a;this._actions={};this._actionOrder=[];this._visibilityChanged=false;this._anyVisible=false;this.actionClass='action';}copy_properties(ChatTabActions.prototype,{anyVisible:function(){return this._anyVisible;},appendAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.push(c);return this;},prependAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.unshift(c);return this;},removeAction:function(a){delete this._actions[a];return this;},setVisible:function(b,c){var a=this._actions[b];if(a&&a.visible!=c){a.visible=c;this._visibilityChanged=true;}return this;},refresh:function(){if(this._visibilityChanged){this._render();this._visibilityChanged=false;return true;}return false;},_render:function(){DOM.empty(this._container);var c=this._actions;var b=this._actionOrder;this._anyVisible=false;var d=[];for(var e=0;e<b.length;++e){var a=c[b[e]];if(a.visible){if(this._anyVisible)d.push($N('span',{className:'divider'},HTML(' &middot; ')));d.push(a.create_element());this._anyVisible=true;}}DOM.appendContent(this._container,d);this._container.style.display=this._anyVisible?'block':'none';},_addAction:function(c,b,a){if(typeof b=='string'){var d=b;b=function(){return $N('a',{className:this.actionClass,href:'#'},d);}.bind(this);}this._actions[c]={create_element:function(){var e=b();Event.listen(e,'click',a);return e;},visible:false};this._visibilityChanged=true;}});
var ChatUserInfoManager=window.ChatUserInfoManager||(function(){var a=new Arbiter();var b={};var k=[];var f=false;var h=false;function c(){if(!k.length||f)return;f=true;e.defer();}function d(m,l){a.inform('fetch');new AsyncRequest().setURI(m).setData(l).setHandler(function(n){j(n,l.ids);}).setErrorHandler(i).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}function e(){var l=k;k=[];d('/ajax/chat/user_info.php',{ids:l});}function g(){f=false;c();}function j(o,n){var p=n?Object.from(n):{};for(var m in o.payload){var r=o.payload[m];r.type='friend';ChatUserInfos[m]=r;var l=b[m];if(l){delete b[m];l.forEach(function(s){try{s(r,m);}catch(t){}});}delete p[m];}for(var q in p)delete b[q];g();a.inform('updated');}function i(){g();}return copy_properties(a,{get:function(m,l){l=l||bagofholding;if(ChatUserInfos[m]){l(ChatUserInfos[m],m);}else{if(!b[m]){b[m]=[];k.push(m);c();}b[m].push(l);}},hasAll:function(){return h;},fetchAll:function(){if(!h){d('/ajax/chat/user_info_all.php',{viewer:Env.user});h=true;}}});})();
LogMessageType={VIDEO_CALL:0,THREAD_NAME:4,THREAD_IMAGE:5};
function TypingIndicator(a,b,d,c){this.id=a;this.input=b;this.source=d;this.callback=null;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('typ'),this.onTyping.bind(this));this.remoteState=TypingDetector.INACTIVE;this.notifyTimer=null;c=c||{};this.notifyDelay=c.notifyDelay||this.notifyDelay;this._typingDetector=new TypingDetector(b);this._typingDetector.init(c);this._typingDetector.subscribe('change',this._stateChange.bind(this));}copy_properties(TypingIndicator.prototype,{notifyDelay:1000,setIgnoreEnter:function(a){var b=a?[KEYS.RETURN]:[];this._typingDetector.setIgnoreKeys(b);},resetState:function(){presence.debug('typing: ** RESET **');this.remoteState=TypingIndicator.INACTIVE;this._typingDetector.reset();clearTimeout(this.notifyTimer);this.notifyTimer=null;},_stateChange:function(a,b){if(b==TypingDetector.ACTIVE)presence.debug('typing:'+this.currentState+' -> '+b);if(b!=TypingDetector.QUITTING){clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.shield(this,b).defer(this.notifyDelay);}else this._notifyState(b,true);},_notifyState:function(d,c){var e=this.id;var a=this._isUserOnWeb(e);if(a&&d!=this.remoteState){this.remoteState=d;presence.debug('typing: notifyState('+d+')');if(!channelManager.iframeEverLoaded)return;var b={typ:d,to:e,source:this.source};new AsyncRequest().setHandler(this._onTypResponse.bind(this,e)).setErrorHandler(bagofholding).setData(b).setURI('/ajax/messaging/typ.php').setAllowCrossPageTransition(true).setOption('asynchronous',!c).send();}},_isUserOnWeb:function(b){var a=AvailableList.get(b);return a==AvailableList.ACTIVE||a==AvailableList.IDLE;},_onTypResponse:function(c,b){var a=b.getPayload()||{};if(a.offline){AvailableList.set(c,AvailableList.OFFLINE);}else if(a.mobile)AvailableList.set(c,AvailableList.MOBILE);},setCallback:function(a){this.callback=a;},onTyping:function(b,a){this.callback&&this.callback(a.obj);}});
function ChatThreadTab(a,e,f,b,d,c){this.parent.construct(this,a,e,f,b,d,c);}Class.extend(ChatThreadTab,'ChatTab');ChatThreadTab.prototype={rendererName:'chat-thread-tab',msgGroupRendererName:'chat-msg-thread-with-tooltip',hasThread:true,_lastStatusUpdateTime:0,_participantStatuses:null,_toolbarUpdateTimeoutID:null,getPostType:function(){return 'thread';},getAvailability:function(){return AvailableList.ACTIVE;},_handleStatusChange:function(){var a=false;if(this._participantStatuses===null){a=true;}else for(var c in this._participantStatuses)if(this._participantStatuses[c]!=AvailableList.get(c)){a=true;break;}if(a){var b=Math.floor(ChatConfig.get('chat_tab_user_status_update_variation_range_ms')*Math.random());this._toolbarUpdateTimeoutID=setTimeout(this._sendToolbarUpdateRequest.bind(this),b,false);}},close:function(){this.parent.close();if(this._toolbarUpdateTimeoutID)clearTimeout(this._toolbarUpdateTimeoutID);},_sendToolbarUpdateRequest:function(){this._toolbarUpdateTimeoutID=null;var a=(new Date()).getTime();if(a-this._lastStatusUpdateTime>ChatConfig.get('chat_tab_user_status_update_min_interval_ms'))new AsyncRequest().setData({id:this.id,has_thread:this.getHasThread()}).setURI('/ajax/chat/multichat/update_toolbar.php').send();},setParticipantStatuses:function(a){this._participantStatuses=a;},refreshStatusUpdateTime:function(){this._lastStatusUpdateTime=(new Date()).getTime();},addRecipients:function(b){this.parent.addRecipients(b);if(!this.getHasThread())for(var a=0;a<b.length;a++)this.pendingNewRecipients.push(b[a]);return this;},showSendAsMessageLinks:bagofholding,getSendData:function(a){send_data=this.parent.getSendData(a);if(this.pendingNewRecipients.length>0||!this.hasThread){send_data.new_thread=true;if(this.pendingNewRecipients.length>0)send_data.new_recips=this.pendingNewRecipients;}return send_data;},reloadHistoryOnRestart:function(){return this.getHasThread();},isCanonical:function(){return false;},_buildUI:function(){var c=this.parent._buildUI();var b=XHPTemplate.getNode(c,'dropdown');if(b){var a=XHPTemplate.getNode(c,'addToThreadLink');if(a)this._handlers.push(Event.listen(a,'click',this.showAddFriendFromIcon.bind(this)));var d=XHPTemplate.getNode(c,'unsubscribeLink');if(d)this._handlers.push(Event.listen(d,'click',this.unsubscribeFromThread.bind(this)));}return c;},unsubscribeFromThread:function(){if(this.getHasThread())Messaging.unsubscribeFromThread(this.id);this.chatDisplay.closeTab(this.id);},showAddFriendFromIcon:function(){this.showAddFriend();return false;},_messagingMarkThreadAsRead:function(a){Messaging.markAsRead(a);},getConversationURI:bagof(''),getProfileURI:function(){return Messaging.getInboxThreadURI(this.id);},setHasThread:function(a){this.hasThread=a;if(!a)this.historyLoaded=true;this.setShowConversationLink(a);},setShowConversationLink:function(b){var a=XHPTemplate.getNode(this.tabHandle,'conversationLink');if(a)if(b){CSS.show(a);}else CSS.hide(a);},getHasThread:function(){return this.hasThread;}};
function ChatGroupTab(a,b,d,f,e,c){this.parent.construct(this,a,b,d,d,e,c);this._facepileHandlers=[];}Class.extend(ChatGroupTab,'ChatTab');ChatGroupTab.prototype={rendererName:'chat-group-tab',msgGroupRendererName:'chat-msg-group-with-tooltip',getPostType:function(){return 'group';},focus:function(c,a,b){this.parent.focus(c,a,b);this._setUpdateFacepiles(true);},unfocus:function(){this.parent.unfocus();this._setUpdateFacepiles(false);},close:function(){this.parent.close();this._setUpdateFacepiles(false);this._removeFacepileHandlers();},_facepilesToken:null,_lastUpdateRequestTimeMS:0,_memberStatuses:null,_setUpdateFacepiles:function(a){if(a){if(!this._facepilesToken){this._facepilesToken=setInterval(this._sendFacepileRequest.bind(this),ChatConfig.get('group_chat_facepile_update_interval_ms'),false);this._sendFacepileRequest();}}else if(this._facepilesToken){clearInterval(this._facepilesToken);this._facepilesToken=null;}},_resetUpdateFacepiles:function(){this._setUpdateFacepiles(false);this._setUpdateFacepiles(true);},_sendFacepileRequest:function(){this._lastUpdateRequestTimeMS=(new Date()).getTime();new AsyncRequest().setData({id:this.id}).setURI('/ajax/groups/chat/update_facepiles.php').setHandler(this._renderFacepile.bind(this)).send();},_renderFacepile:function(b){this._removeFacepileHandlers();var a=b.getPayload();this._updateMemberStatuses(a.statuses);if(a.response_html)DOM.setContent(this.chatInfo,HTML(a.response_html));if(a.facepile_click_info)a.facepile_click_info.each(function(d){var c=DOM.scry($(d.id),'a');if(c.length)this._facepileHandlers.push(Event.listen(c[0],"click",function(){chatDisplay.focusTab(d.uid,true,d.name,d.firstName);return false;}));}.bind(this));this.handleResize();},_updateMemberStatuses:function(a){this._memberStatuses=a;},_removeFacepileHandlers:function(){while(this._facepileHandlers.length)this._facepileHandlers.pop().remove();},showSendAsMessageLinks:bagofholding,playSound:bagofholding,_buildUI:function(){var d=this.parent._buildUI();var c=XHPTemplate.getNode(d,'reportLink');if(c)CSS.addClass(c,'hidden_elem');this.chatInfo=XHPTemplate.getNode(d,'facepileHolder');var a=XHPTemplate.getNode(d,'dropdown');if(a){var b=XHPTemplate.getNode(d,'muteGroupLink');if(b)b.setAttribute('href',URI(b.href).addQueryData({id:this.id}));}},isCanonical:function(){return false;},getAvailability:function(){return AvailableList.ACTIVE;},_handleStatusChange:function(){if(this.focused){var c=Object.keys(this._memberStatuses);var a=false;for(var b=0;b<c.length;b++)if(this._memberStatuses[c[b]]!=AvailableList.get(c[b])){a=true;break;}var d=(new Date()).getTime();if(a&&d-this._lastUpdateRequestTimeMS>ChatConfig.get('chat_tab_user_status_update_min_interval_ms'))this._resetUpdateFacepiles();}},mentionsUser:function(a){if(a.from==presence.user)return false;var b=a.msg.text;if(presence.alias!==""&&b.indexOf(presence.alias)!=-1)return true;if(presence.firstName!==""&&b.toLowerCase().indexOf(presence.firstName.toLowerCase())!=-1)return true;return false;},newMsg:function(a){if(this.mentionsUser(a))this.parent.playSound();this.parent.newMsg(a);},getConversationURI:bagof(''),getProfileURI:function(){return URI(env_get('www_base')).setPath('/').setQueryData({sk:'group_'+this.id});}};
function ChatTab(a,c,e,b,g,d){this.inDock=!presence.inPopoutWindow;this.chatDisplay=a;this.id=c;this.name=e;this.tabRef='chatDisplay.tabs['+this.id+']';this.firstName=b;this.tabDisabled=false;this.numMissed=g||0;this.missedTime=d;this.focused=false;this.lastLogItem=null;this.historyLoaded=false;this.pendingSentMsgs=[];this.failedSentMsgs=[];this.historyRequestID=0;this.bounceAnimation=null;this.pendingNewRecipients=[];this.allRecipients=[];this.minTextHeight=presence.inPopoutWindow?this.minTextHeightPopout:this.minTextHeightPopin;this.lastMessageAt=null;this._handlers=[];this._subscriptions=[];this._buildUI();this.loadData();this.timeBuilt=new Date();this._handleStatusChange(true);this._textareaListener=null;this.isWindowFocused=true;this.resetAutoCloseTimeout(true);this._handlers.push(Event.listen(window,'blur',this._onWindowBlur.bind(this)),Event.listen(window,'focus',this._onWindowFocus.bind(this)));this._subscriptions.push(Arbiter.subscribe(['chat/visibility-changed','buddylist/availability-changed'],this._handleStatusChange.shield(this)));this._enableJSLoggerDump();if(ChatConfig.get('blackbird')){this._blacklistSheetOpen=false;PresencePrivacy.subscribe('privacy-changed',this._handleStatusChange.shield(this));}if(this.inDock){var f=new NubController();f.init(this.tabHandle);f.subscribe('show',function(){if(this.chatDisplay.focused!=this.id)this.chatDisplay.focusTab(this.id);}.bind(this));f.subscribe('hide',function(){if(this.focused)this.chatDisplay.unfocus();}.bind(this));f.subscribe('resize',this.scrollToBottom.bind(this));}this._subscriptions.push(Arbiter.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this)));this._messagingToken=MessagingEvents.subscribe('read',function(h,i){if(i.chat_ids&&i.chat_ids.contains(this.id)){this._clearMessagingMarkAsRead();if(i.mark_as_read)this._markRead();}}.bind(this));Sound.init();}Class.mixin(ChatTab,'Arbiter',{currentMsgGroup:null,rendererName:'chat-tab',msgGroupRendererName:'chat-msg-group',pendingToLogCompareWindow:60000,resendDelay:5000,handleWidth:150,popinWidth:258,popinHeight:250,popoutWidthOffset:180,flPopoutWidthOffset:200,minTextHeightPopin:13,minTextHeightPopout:32,maxTextHeight:77,msgBunchTime:300000,maxHandleLen:16,maxTitleLen:20,bounceDuration:50,_ACTION_LOG_SUBSCRIBE:1,_ACTION_LOG_UNSUBSCRIBE:2,_getJSLogger:function(){if(!ChatTab._jslogger)ChatTab._jslogger=new JSLogger('chat_tab');return ChatTab._jslogger;},_enableJSLoggerDump:function(){this._subscriptions.push(Arbiter.subscribe('jslogger/dump',function(f,a){var d=['id','name','inDock','numMissed','focused','lastLogItem','historyLoaded','pendingSentMsgs','failedSentMsgs','timeBuilt','isWindowFocused','allRecipients','focused'];var b={};var e=this;var c=a.other_uids||[];c.push(this.id);a.other_uids=c;d.forEach(function(g){b[g]=e[g];});b.selfAvailableListDebugInfo=AvailableList.getDebugInfo(presence.user);b.otherAvailableListDebugInfo=AvailableList.getDebugInfo(this.id);a[this.id]={tab_info:b};}.bind(this)));},_onWindowFocus:function(event){this.isWindowFocused=true;if(this.focused)this._markRead();},_onWindowBlur:function(event){this.isWindowFocused=false;},isTabVisible:function(){return this.focused&&(presence.inPopoutWindow||!presence.poppedOut);},start:function(){this._popSendQueue();},restart:function(){if(this.reloadHistoryOnRestart())if(this.focused){this.getHistory(true);}else this.historyLoaded=false;this.handleResize.bind(this).defer();},reloadHistoryOnRestart:function(){return true;},loadData:function(){if(this.chatDisplay.histories[this.id])this._setHistory(this.chatDisplay.histories[this.id]);},_onHistoryInitialHandler:function(a,b){if(a!=this.historyRequestID){presence.debug("tabs: got old history async, ignoring");return false;}return null;},_onHistoryResponse:function(a,l){var b=l.getPayload();var n=b.userInfo;var h=b.history;this._getJSLogger().log('history_send_responded',{request_id:this.historyRequestID,from_restart:a});if(n)Chat.setUserInfo(this.id,n,b.fls);if(!h)return;var k=false;if(this.pendingSentMsgs.length>0&&h.length>0){var j=this.pendingSentMsgs[0];var c;for(c=h.length-1;c>=0;c--){var g=h[c];if(g.to!=this.chatDisplay.user){var m=Math.abs(j.time-g.time);if(m<this.pendingToLogCompareWindow&&j.text==g.msg.text){this._setMsgInfoMarkup(j.msgID,'');this.pendingSentMsgs.shift();this._popSendQueue();k=true;break;}}}var e=h[h.length-1].time;for(c=0;c<this.pendingSentMsgs.length;c++){j=this.pendingSentMsgs[c];if(j.time<e)j.time=(++e);}}var i=this.chatDisplay.histories[this.id];if(i)if(h.length>0){var d=h[h.length-1];var f=d.time;for(var c=0;c<i.length;c++){var g=i[c];if(g.time>f)h.push(g);}}else h=i;this._setHistory(h);this.chatDisplay.histories[this.id]=h;if(a)if(!k)this._popSendQueue();},getHistory:function(a){var b=++(this.historyRequestID);this._getJSLogger().log('history_sent',{request_id:b,from_restart:a});new AsyncRequest().setInitialHandler(this._onHistoryInitialHandler.bind(this,b)).setHandler(this._onHistoryResponse.bind(this,a)).setErrorHandler(bagofholding).setMethod('GET').setReadOnly(true).setOption('suppressErrorAlerts',true).setData({type:this.getPostType(),id:this.id}).setURI('/ajax/chat/history.php').setAllowCrossPageTransition(true).send();},getPostType:function(){return 'friend';},_setHistory:function(d){this.lastLogItem=null;DOM.empty(this.chatConvContent);var f=0;var i=[];Array.prototype.push.apply(i,this.failedSentMsgs);Array.prototype.push.apply(i,this.pendingSentMsgs);var e=0;for(var a=0;a<d.length;a++){var b=d[a];var c=this.getMessageTypeInfo(b.type);if(c.unknown)continue;for(;f<i.length;f++){var g=i[f];var h=this.getMessageTypeInfo(g.type);if(g.time>e&&g.time<=b.time){if(h.visible)this.renderMsg(presence.user,this.id,g.time,g,g.msgID,g.isError,g.infoMarkup);}else break;}if(c.msg){this.renderMsg(b.from,b.to,b.time,b.msg,b.msgId);}else if(c.logMessage){this._renderLogMessage(b);}else if(c.actionLog)this._renderActionLogMessage(b.actor,b.new_recipients,b.action,b.time);this.lastLogItem=b;e=b.time;}for(;f<i.length;f++){var g=i[f];if(this.getMessageTypeInfo(g.type).visible){this.renderMsg(presence.user,this.id,g.time,g,g.msgID,g.isError,g.infoMarkup);this.lastLogItem={type:g.type,from:presence.user,to:this.id,time:g.time,msg:g};}}this.scrollToBottom();this.historyLoaded=true;},addRecipients:function(b){for(var a=0;a<b.length;a++)this.allRecipients.push(b[a]);return this;},setRecipients:function(a){this.allRecipients=a;return this;},getRecipients:function(){return this.allRecipients;},newActionLogMsg:function(c){var d=c.time||presence.getTime();var b={type:'actionlog',action:c.actionType,time:c.timestampMsec,actor:c.actorInfo,new_recipients:c.newRecipientsInfo};var a=this.isUserScrolled();this._renderActionLogMessage(c.actorInfo,c.newRecipientsInfo,c.actionType,c.timestampMsec);!a&&this.scrollToBottom();this.lastLogItem=b;this.chatDisplay.addToHistory(this.id,b);},_renderActionLogMessage:function(b,e,i,g){var a=this.chatDisplay.templates['chat-msg-event'].render();var c=XHPTemplate.getNode(a,'icon');var d=XHPTemplate.getNode(a,'message');var h=XHPTemplate.getNode(a,'timestamp');var f=this.chatDisplay.renderServerTime(g);DOM.setContent(h,f);this._checkDateBreak(g);switch(i){case this._ACTION_LOG_SUBSCRIBE:if(!e||e.length===0)return;CSS.addClass(c,'addActionIcon');DOM.setContent(d,HTML(this._getSubscribeMessage(this.chatDisplay.user,b,e)));break;case this._ACTION_LOG_UNSUBSCRIBE:CSS.addClass(c,'leaveActionIcon');DOM.setContent(d,HTML(this._getUnsubscribeMessage(this.chatDisplay.user,b)));break;default:return;}DOM.appendContent(this.chatConvContent,a);this.currentMsgGroup=null;},_getSubscribeMessage:function(c,a,b){var d=this._indexOfUser(c,b);if(a.fbid&&a.fbid==c){switch(b.length){case 1:return _tx("You added {subscriber1}.",{subscriber1:this._getLinkifiedName(c,b[0])});case 2:return _tx("You added {subscriber1} and {subscriber2}.",{subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1])});case 3:return _tx("You added {subscriber1}, {subscriber2} and {subscriber3}.",{subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),subscriber3:this._getLinkifiedName(c,b[2])});default:return _tx("You added {subscriber1}, {subscriber2} and {more_people}.",{subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),more_people:b.length-2});}}else if(d!=-1){b.splice(d,1);switch(b.length){case 0:return _tx("{actor} added you.",{actor:this._getLinkifiedName(c,a)});case 1:return _tx("{actor} added you and {subscriber2}.",{actor:this._getLinkifiedName(c,a),subscriber2:this._getLinkifiedName(c,b[0])});case 2:return _tx("{actor} added you, {subscriber2} and {subscriber3}.",{actor:this._getLinkifiedName(c,a),subscriber2:this._getLinkifiedName(c,b[0]),subscriber3:this._getLinkifiedName(c,b[1])});default:return _tx("{actor} added you, {subscriber2} and {more_people}.",{actor:this._getLinkifiedName(c,a),subscriber2:this._getLinkifiedName(c,b[0]),more_people:b.length-1});}}else switch(b.length){case 1:return _tx("{actor} added {subscriber1}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0])});case 2:return _tx("{actor} added {subscriber1} and {subscriber2}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1])});case 3:return _tx("{actor} added {subscriber1}, {subscriber2} and {subscriber3}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),subscriber3:this._getLinkifiedName(c,b[2])});default:return _tx("{actor} added {subscriber1}, {subscriber2} and {more_people}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),more_people:b.length-2});}},_indexOfUser:function(b,c){for(var a=0;a<c.length;a++)if(c[a].fbid&&c[a].fbid==b)return a;return -1;},_getUnsubscribeMessage:function(b,a){if(a.fbid&&a.fbid==b){return _tx("You left the conversation.");}else return _tx("{actor} left the conversation.",{actor:this._getLinkifiedName(b,a)});},_getLinkifiedName:function(b,a){if(!a.fbid){return a.name;}else return presence.renderLink(a.href,a.name);},clearHistory:function(){new AsyncRequest().setHandler(bagofholding).setErrorHandler(bagofholding).setData({clear_history_id:this.id}).setURI(this.chatDisplay.settingsURL).setAllowCrossPageTransition(true).send();this.failedSentMsgs=[];this.pendingSentMsgs=[];this._setHistory(this.chatDisplay.histories[this.id]=[]);},reportLinkAction:function(){Bootloader.loadComponents('dialog',(function(){var a=URI(this.chatDisplay.reportURL).addQueryData({id:this.id}).addQueryData({src:'top_report_link'});Dialog.bootstrap(a.toString(),null,false);}).bind(this));},_isCurrentPendingSend:function(a){return (this.pendingSentMsgs.length>0&&a==this.pendingSentMsgs[0].msgID);},_onSendServerDialogCancel:function(a){if(!this._isCurrentPendingSend(a))return;this.failedSentMsgs.push(this.pendingSentMsgs.shift());this._popSendQueue();},_onSendResponse:function(a,d){var b=d.getPayload();if(this._isCurrentPendingSend(a)){var c=this.pendingSentMsgs[0];c.asyncSuccess=true;this._getJSLogger().log('message_send_succeeded',{msg_id:c.msgID});if(b&&b.show_video_callout)Bootloader.loadComponents('VideoChatPlugin',function(){if(VideoChatPlugin.isSupported())this.showVideoCallout();}.bind(this));}else this._getJSLogger().log('message_send_succeeded',{msg_id:a});if(b&&b.warning){var e=this._renderMsgWarning(('title' in b.warning?b.warning.title+'<br />':'')+b.warning.body);this._setMsgInfoMarkup(a,e,'msg_warning');}},showVideoCallout:function(a){var c=DOM.scry(this.tabHandle,'.video');var b={recipient_id:this.id,alt:!!a};if(c.length==1)new AsyncRequest().setData(b).setRelativeTo(c[0]).setURI('/ajax/chat/video/callout.php').setAllowCrossPageTransition(true).send();},showOrcaCallout:function(b){var c=DOM.scry(this.tabHandle,'.titlebar');if(c.length>0){var a={sender_id:b};new AsyncRequest().setData(a).setRelativeTo(c[0]).setURI('/ajax/chat/orca/callout.php').setAllowCrossPageTransition(true).send();}},_onSendTransportError:function(a,b){this._getJSLogger().log('message_send_transport_failed',{msg_id:a});if(!this._isCurrentPendingSend(a))return;if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a).defer(this.resendDelay,false);},_onSendError:function(c,e){this._getJSLogger().log('message_send_failed',{msg_id:c});if(!this._isCurrentPendingSend(c))return;var d=e.getPayload();var b=e.getError();var a=presence.getErrorDescription(e);if(b==1356003||b==1356022){this.showSendAsMessageLinks();}else if(b==1356002){chatOptions.setVisibility(false);presence.doSync();}else if(b==1356008){a=d.error.title;ErrorDialog.show(d.error.title,d.error.body);}else if(b==1356038){ErrorDialog.show(e.errorSummary,e.errorDescription);}else if(b==1356026){a=d.errorText;(new Function(d.do_onload)).apply();}this._sendErrorAll(a);},showSendAsMessageLinks:function(){AvailableList.set(this.id,AvailableList.OFFLINE);for(var b=0;b<this.pendingSentMsgs.length;b++){var e=this.pendingSentMsgs[b];var f=ge('msg_'+this.id+'_'+e.msgID);if(f){var a='rel="dialog"';var g=new URI(this.chatDisplay.messageURL).addQueryData({id:this.id,message:e.text}).toString();var c=presence.renderLink(g,_tx("send as a message"),a);var d=_tx("{message} ({=send as a message})",{message:this._renderMsgHtmlize(e.text),'=send as a message':c});DOM.setContent(f,HTML(d));}}},_renderMsgWarning:function(b){var a=this.chatDisplay.templates['chat-msg-warning'].render();DOM.setContent(XHPTemplate.getNode(a,'message'),b);return a;},_renderMsgError:function(a){var b=this.chatDisplay.templates['chat-msg-error'].render();DOM.setContent(XHPTemplate.getNode(b,'message'),a);return b;},_sendErrorAll:function(a){var b=this._renderMsgError(a);var c=true;while(this.pendingSentMsgs.length){var d=this.pendingSentMsgs.shift();d.isError=true;if(c)d.infoMarkup=b;this._setMsgInfoMarkup(d.msgID,b,'msg_error');this.failedSentMsgs.push(d);c=false;b='';}},_createMessage:function(e,c){var b=(new Date()).getTime()+':'+(rand32()+1);var f=presence.getTime();var a=new Date().getTime();if(this.lastLogItem&&f<this.lastLogItem.time)f=this.lastLogItem.time+1;var d={text:e,msgID:b,type:c,created:a,time:f,asyncSuccess:false,isError:false,errorMarkup:''};return d;},_flushSmallQueue:function(){if(this.pendingSentMsgs.length==1){var a=this.pendingSentMsgs[0];if(channelManager.iframeEverLoaded){this._sendMessage(a);}else if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a.msgID).defer(this.resendDelay,false);}},_updateChatActivity:function(b,a){this.lastLogItem={type:b.type,from:presence.user,to:this.id,time:b.time,msg:a};this.chatDisplay.chatActivityTime=(new Date()).getTime();presence.doSync();},sendInput:function(){var d=this.chatInput.value;if(/^\s*$/.test(d||''))return;this.chatInput.value='';var c=this._createMessage(d,'msg');this.pendingSentMsgs.push(c);this._flushSmallQueue();var b={text:d};var a=this.isUserScrolled();this.renderMsg(presence.user,this.id,c.time,b,c.msgID);!a&&this.scrollToBottom();this._updateChatActivity(c,b);this.typingIndicator&&this.typingIndicator.resetState();},_sendMessage:function(b){b.time=presence.getTime();if(this.lastLogItem&&b.time<this.lastLogItem.time)b.time=this.lastLogItem.time+1;clearTimeout(this.resendTimeout);this.resendTimeout=null;var c=this.getSendData(b);channelManager.expectResponse();this._getJSLogger().log('message_sent',{msg_id:c.msgID});Arbiter.inform('chat/message-sent',c);var a=b.msgID;new AsyncRequest().setServerDialogCancelHandler(this._onSendServerDialogCancel.bind(this,a)).setHandler(this._onSendResponse.bind(this,a)).setErrorHandler(this._onSendError.bind(this,a)).setTransportErrorHandler(this._onSendTransportError.bind(this,a)).setData(c).setURI('/ajax/chat/send.php').setAllowCrossPageTransition(true).send();this.pendingNewRecipients=[];},getSendData:function(e){var c=this.chatDisplay.histories[this.id];var d=null;var a=this.getAvailability();var h=a==AvailableList.OFFLINE;var g=a==AvailableList.IDLE;var f={msg_id:e.msgID,client_time:e.time,to:this.id,num_tabs:this.chatDisplay.numTabs,pvs_time:d,msg_text:e.text,to_offline:h,to_idle:g,popped_out:presence.inPopoutWindow};if(h){var b=AvailableList.getDebugInfo(this.id);f.overlay=b.overlay;f.overlayTime=b.overlayTime;f.presence=b.presence;f.presenceTime=presence.getTime();f.clock=(new Date()).getTime();}if(ChatConfig.get('sidebar')){f.sidebar_launched=true;if(window.ChatSidebar){f.sidebar_enabled=ChatSidebar.isEnabled();f.sidebar_capable=ChatSidebar.isViewportCapable();f.sidebar_visible=ChatSidebar.isVisible();}}return f;},_popSendQueue:function(){if(this.pendingSentMsgs.length==0)return;var a=this.pendingSentMsgs[0];if(channelManager.iframeEverLoaded){this._sendMessage(a);}else if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a.msgID).defer(this.resendDelay,false);},_resendMessage:function(a){clearTimeout(this.resendTimeout);this.resendTimeout=null;if(this._isCurrentPendingSend(a))if(channelManager.iframeEverLoaded){this._sendMessage(this.pendingSentMsgs[0]);}else this.resendTimeout=this._resendMessage.bind(this,a).defer(this.resendDelay,false);},_setMsgInfoMarkup:function(d,c,a){var b=ge('msg_'+this.id+'_'+d);if(!b)return;DOM.insertAfter(b,c);a&&CSS.addClass(b,a);this.scrollToBottom();},tabHitAreaOnClick:function(){if(this.suppressHeaderCollapse)return;if(presence.inPopoutWindow){this.chatDisplay.focusTab(this.id,true,this.name,this.firstName);}else this.chatDisplay.toggleTab(this.id,true,this.name,this.firstName);this.chatDisplay.doStopBlinking();},tabXOnClick:function(a){this.chatDisplay.closeTab(this.id);this.chatDisplay.doStopBlinking();$E(a).kill();return false;},headerLinkMouseOver:function(){CSS.addClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=true;},headerLinkMouseOut:function(){CSS.removeClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=false;},chatConvOnMouseDown:function(event){if(event.button!=0)return;this.chatDisplay.doStopBlinking();},chatConvOnMouseUp:function(){if(DOM.getSelection()=='')this.focusChatInput(true);},focusChatInput:function(a){if(this.isTabVisible())if(a||this.canStealFocus())this.chatInput.focus();},canStealFocus:function(){if(undefined!=document.activeElement){var a=document.activeElement;if(a){var b='INPUT'==a.nodeName||'TEXTAREA'==a.nodeName||('DIV'==a.nodeName&&a.contentEditable=="true");return !b;}}return false;},displayPrivacyLinkInGearMenu:function(){var a;if(PresencePrivacy.allows(this.id)){ChatUserInfoManager.get(this.id,function(b){a=_tx("Go unavailable to {name}",{name:b.firstName});});}else ChatUserInfoManager.get(this.id,function(b){a=_tx("Go available to {name}",{name:b.firstName});});DOM.setContent(XHPTemplate.getNode(this.tabHandle,'privacyLink'),a);},togglePrivacy:function(){if(!ChatConfig.get('blackbird'))return;var a=PresencePrivacy.allows(this.id);var b=a?PresencePrivacy.disallow(this.id):PresencePrivacy.allow(this.id);if(!a)this.closeSheet();this.displayPrivacyLinkInGearMenu();return b;},showAddFriendFromActionMenu:function(){this.showAddFriend();return true;},showAddFriend:function(){var a={canonical:this.isCanonical(),id:this.id};if(this.isCanonical()){a.recipient_id=this.id;}else{a.thread_id=this.id;a.recipients=this.getRecipients();}new AsyncRequest().setURI('/ajax/chat/show_add_friends.php').setData(a).setHandler(bagofholding).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_buildUI:function(){var m=this.chatDisplay.templates[this.rendererName].render();this._updateNubName(m);var o=XHPTemplate.getNode(m,'titlebarText');DOM.setContent(o,this.name);this._sheetEl=XHPTemplate.getNode(m,'sheet');var b=XHPTemplate.getNode(m,'chatConv');var f=XHPTemplate.getNode(m,'closeButton');var c=XHPTemplate.getNode(m,'input');this._handlers.push(Event.listen(b,'mousedown',this.chatConvOnMouseDown.bind(this)),Event.listen(b,'mouseup',this.chatConvOnMouseUp.bind(this)),Event.listen(f,'click',this.tabXOnClick.bind(this)),Event.listen(c,'keydown',this.inputKeyDown.bind(this)),Event.listen(c,'click',this.chatDisplay.doStopBlinking.bind(this.chatDisplay)));var i=XHPTemplate.getNode(m,'maximizeButton');if(i)this._handlers.push(Event.listen(i,'click',this.maximizeOnClick.bind(this)));ChatQuietLinks.silence(m);this.tabHandle=m;this.statusEl=XHPTemplate.getNode(m,'status');this.tabCount=XHPTemplate.getNode(m,'numMessages');this.chatWrapper=XHPTemplate.getNode(m,'chatWrapper');this.chatConv=b;this.chatConvContent=XHPTemplate.getNode(m,'conversation');this.chatInput=c;var d=ge('fbDockChatTabs');DOM.prependContent(d,this.tabHandle);if(ChatConfig.get('typing_notifications')){this.typingIndicator=new TypingIndicator(this.id,c,'chat');var p=XHPTemplate.getNode(m,'typingIndicator');if(p){var j;ChatUserInfoManager.get(this.id,function(r){j=_tx("{name} is typing...",{name:r.firstName});DOM.setContent(p,j);});}}this._updateNumMissedDisplay();this.videoCallLink=XHPTemplate.getNode(m,'videoCallLink');if(this.videoCallLink){this._handlers.push(Event.listen(this.videoCallLink,'click',function(){var r=this.getAvailability();if(this._isVideoCallAvail(r)){VideoEvents.inform(VideoEvents.START_CALL_UI,{idTarget:this.id});this.focused&&this.chatDisplay.unfocus();}return false;}.bind(this)));this._callIncomingToken=VideoEvents.subscribe(VideoEvents.CALL_INCOMING,function(r,s){if(s.idTarget==this.id&&this.focused&&/^\s*$/.test(this.chatInput.value||''))this.chatDisplay.unfocus();}.bind(this));}if(ChatConfig.get('vibes.panda_check')){var q=XHPTemplate.getNode(m,'vibesPandaButton');if(q)Bootloader.loadComponents('VibesPanda',function(){var r=new PandaConstructor(this.id,q,true);this._handlers.push(Event.listen(q,'click',r.click.bind(r)));}.bind(this));}var h=XHPTemplate.getNode(m,'dropdown');if(h){Toggler.createInstance(h).setSticky(false);var g=XHPTemplate.getNode(m,'conversationLink');if(g)if(this.isCanonical()){g.href=Messaging.getUserThreadURI(this.id);}else g.href=Messaging.getInboxThreadURI(this.id);var l=XHPTemplate.getNode(m,'reportSpamLink');if(l)this._handlers.push(Event.listen(l,'click',this.reportLinkAction.bind(this)));var e=XHPTemplate.getNode(m,'clearWindowLink');if(e)this._handlers.push(Event.listen(e,'click',this.clearHistory.bind(this)));var a=XHPTemplate.getNode(m,'addFriendLink');if(a)this._handlers.push(Event.listen(a,'click',this.showAddFriendFromActionMenu.bind(this)));if(ChatConfig.get('blackbird')){var k=XHPTemplate.getNode(m,'privacyLink');if(k)this._handlers.push(Event.listen(k,'click',this.togglePrivacy.bind(this)));}}var n=XHPTemplate.getNode(m,'titlebarCloseButton');this._handlers.push(Event.listen(n,'click',this.tabXOnClick.bind(this)));return m;},isCanonical:function(){return true;},_updateNubName:function(a){DOM.setContent(XHPTemplate.getNode(a,'name'),this.name);},maximizeOnClick:function(){var a=this.getConversationURI();if(a){goURI(a);this.focused&&this.chatDisplay.unfocus();}return false;},getConversationURI:function(){return Messaging.getUserThreadURI(this.id);},getProfileURI:function(){return URI(env_get('www_base')).setPath('/profile.php').setQueryData({id:this.id});},show:function(){CSS.show(this.tabHandle);},hide:function(){CSS.hide(this.tabHandle);},inputKeyDown:function(event){this.chatDisplay.doStopBlinking();if(!this._textareaListener){var c=DataStore.get(this.chatInput,'DOMControl');this._textareaListener=c.subscribe('resize',this.handleResize.bind(this));}switch(event.keyCode){case KEYS.RETURN:if(!event.shiftKey){this.sendInput();event.kill();return;}break;case KEYS.ESC:this.chatDisplay.closeTab(this.id);return event.kill();case KEYS.TAB:var b=event.shiftKey;var d=presence.inPopoutWindow;var a=this.chatDisplay.getNextTabId(this.id,b,d);if((typeof a=="string")|(a>0)){this.chatDisplay.focusTab(a,true);return event.kill();}break;}},updateName:function(a){this.name=a;this._updateNubName(this.tabHandle);},trimName:function(a){var b=this.name;if(b.length>a)b=b.substring(0,a-2)+'...';return b;},_handleStatusChange:function(e){var d=Chat.isOnline();var a=d?this.getAvailability():AvailableList.OFFLINE;var b=(this._availability!==a);var f=false;if(ChatConfig.get('blackbird')){f=(this._allows!==PresencePrivacy.allows(this.id));this._allows=PresencePrivacy.allows(this.id);if(f)this.displayPrivacyLinkInGearMenu();}if(!b&&!f)return;this._availability=a;var g;var c=ChatConfig.get('blackbird')&&!PresencePrivacy.allows(this.id);if(!e||chatDisplay.loadedInitialTabs)ChatUserInfoManager.get(this.id,function(l){if(d)if(a===AvailableList.ACTIVE){var k=(new Date()).getTime()-this.timeBuilt.getTime();var h=ChatConfig.get('available_sheet_min_tab_age_ms');if(!e&&k>h){g=_tx("{name} is now available.",{name:l.firstName});}else g=null;}else if(a===AvailableList.OFFLINE||a==AvailableList.MOBILE)if(ChatConfig.get('titan')){var j='offline';if(c){j='blocked';}else if(a==AvailableList.MOBILE&&ChatConfig.get('orca_ui'))j='mobile';switch(l.gender){case GenderConst.FEMALE_SINGULAR:case GenderConst.FEMALE_SINGULAR_GUESS:switch(j){case 'offline':g=_tx("{name} is unavailable, but you can still send her a message.",{name:l.firstName});break;case 'mobile':g=_tx("Your messages will be sent to {name}'s phone.",{name:l.firstName});break;case 'blocked':g=_tx("You are unavailable to {name}. Chats will be sent as messages.",{name:l.firstName});break;}break;case GenderConst.MALE_SINGULAR:case GenderConst.MALE_SINGULAR_GUESS:switch(j){case 'offline':g=_tx("{name} is unavailable, but you can still send him a message.",{name:l.firstName});break;case 'mobile':g=_tx("Your messages will be sent to {name}'s phone.",{name:l.firstName});break;case 'blocked':g=_tx("You are unavailable to {name}. Chats will be sent as messages.",{name:l.firstName});break;}break;default:switch(j){case 'offline':g=_tx("{name} is unavailable, but you can still send them a message.",{name:l.firstName});break;case 'mobile':g=_tx("Your messages will be sent to {name}'s phone.",{name:l.firstName});break;case 'blocked':g=_tx("You are unavailable to {name}. Chats will be sent as messages.",{name:l.firstName});break;}break;}}else g=_tx("{name} is offline.",{name:l.firstName});if(g){var i=this.chatDisplay.templates['chat-sheet-notice'].render();DOM.setContent(XHPTemplate.getNode(i,'text'),g);if(c){this._blackSheetOpen=true;this._appendGoOnlineLink(i);}if(e){this.setSheet(i,c);}else if(this._blackSheetOpen&&!c){this._blackSheetOpen=false;this.closeSheet(this.openSheet.bind(this,i));}else this.openSheet(i,c);}else this.closeSheet();}.bind(this));if(d&&a!=AvailableList.ACTIVE){if(presence.inPopoutWindow)CSS.removeClass(this.popoutTab,'typing');CSS.removeClass(this.tabHandle,'typing');}if(d&&(a||!PresencePrivacy.allows(this.id))){this._enableTab(a);}else this._disableTab();this._updateVideoCallLink(a);},_appendGoOnlineLink:function(b){var d=$N('a',{href:'#',classname:'unlistLink'},_tx("Go available."));Event.listen(d,'click',(function(){this.togglePrivacy();return false;}).bind(this));var c=XHPTemplate.getNode(b,'text');DOM.appendContent(c,d);DOM.appendContent(c,$N('br'));var a=$N('a',{href:'#'},_tx("Close"));Event.listen(a,'click',(function(){this.closeSheet();return false;}).bind(this));DOM.appendContent(c,a);},_isVideoCallAvail:function(a){return a==AvailableList.ACTIVE||a==AvailableList.IDLE;},_updateVideoCallLink:function(a){if(this.videoCallLink)if(this._isVideoCallAvail(a)){TooltipLink.setTooltipText(this.videoCallLink,_tx("Start a video call"));}else{TooltipLink.setTooltipText(this.videoCallLink,_tx("{firstname} is currently unavailable for video calling",{firstname:this.firstName}));this._hideVideoCallouts();}},_enableTab:function(a){this.tabDisabled=false;var d=a==AvailableList.IDLE;var e=a==AvailableList.MOBILE;var b=a==AvailableList.ACTIVE;var c=ChatConfig.get('blackbird')&&!PresencePrivacy.allows(this.id);if(presence.inPopoutWindow){CSS.removeClass(this.popoutTab,'disabled');CSS.conditionClass(this.popoutTab,'idle',d);CSS.conditionClass(this.popoutTab,'active',b);CSS.conditionClass(this.popoutTab,'mobile',e&&!c);CSS.conditionClass(this.popoutTab,'blocked',c);}CSS.removeClass(this.tabHandle,'disabled');CSS.conditionClass(this.tabHandle,'idle',d);CSS.conditionClass(this.tabHandle,'mobile',e&&!c);CSS.conditionClass(this.tabHandle,'active',b);CSS.conditionClass(this.tabHandle,'blocked',c);},_disableTab:function(){this.tabDisabled=true;if(presence.inPopoutWindow){CSS.addClass(this.popoutTab,'disabled');CSS.removeClass(this.popoutTab,'idle');CSS.removeClass(this.popoutTab,'active');CSS.removeClass(this.popoutTab,'mobile');CSS.removeClass(this.popoutTab,'blocked');}CSS.addClass(this.tabHandle,'disabled');CSS.removeClass(this.tabHandle,'idle');CSS.removeClass(this.tabHandle,'active');CSS.removeClass(this.tabHandle,'mobile');CSS.removeClass(this.tabHandle,'blocked');this._hideCallouts();},_hideCallouts:function(){this._hideVideoCallouts();var c=DOM.scry(document,'div.multiChatCallout');for(var b=0;b<c.length;b++)DOM.remove(c[b]);var d=DOM.scry(document,'div.orcaCallout');for(var a=0;a<d.length;a++)DOM.remove(d[a]);},_hideVideoCallouts:function(){var b=DOM.scry(document,'div.videoChatCallout');for(var a=0;a<b.length;a++)DOM.remove(b[a]);},handleResize:function(){var a=this.isUserScrolled();Dock._resizeNubFlyout(this.tabHandle);!a&&this.scrollToBottom();},resizeSheet:function(){if(!this._sheetEl||!this.focused||!this._sheetOpen)return;var a=Vector2.getElementDimensions(this.chatConvContent);a.setElementWidth(this._sheetEl);},setSheet:function(a,b){if(!this._sheetEl)return;clearTimeout(this._sheetCloseTimeout);DOM.setContent(this._sheetEl,a);CSS.setStyle(this._sheetEl,'bottom','0px');CSS.show(this._sheetEl);this._sheetOpen=true;this.resizeSheet();if(!b)this._sheetCloseTimeout=this.closeSheet.shield(this).defer(5000,false);this._sheetKeepOpen=!!b;},openSheet:function(b,d,a){if(!this._sheetEl)return;if(this._sheetOpen){var e=$N('div',{className:'hidden_elem'},b);DOM.appendContent(this._sheetEl,e);if(this._sheetKeepOpen&&!d)return;b=$A(e.childNodes);this.closeSheet(this.openSheet.bind(this,b,d,a));return;}this.inform('sheet/open');if(!this.focused){this.setSheet(b,d);a&&a();this.closeSheet();return;}CSS.setStyle(this._sheetEl,'visibility','hidden');this.setSheet(b,d);var c=Vector2.getElementDimensions(this._sheetEl).y;CSS.addClass(this.tabHandle,'sheetSlide');CSS.setStyle(this._sheetEl,'bottom',c+'px');CSS.setStyle(this._sheetEl,'visibility','');this._sheetAnimation=animation(this._sheetEl).to('bottom',0).duration(150).ease(animation.ease.both).ondone(function(){CSS.removeClass(this.tabHandle,'sheetSlide');this._sheetAnimation=null;a&&a();}.bind(this)).go();},closeSheet:function(a){if(!this._sheetEl)return;clearTimeout(this._sheetCloseTimeout);if(!this._sheetOpen){a&&a();return;}this.inform('sheet/close');this._sheetOpen=this._sheetKeepOpen=false;if(!this.focused){CSS.hide(this._sheetEl);a&&a();return;}this._sheetAnimation&&this._sheetAnimation.stop();CSS.addClass(this.tabHandle,'sheetSlide');this._sheetAnimation=animation(this._sheetEl).to('bottom',Vector2.getElementDimensions(this._sheetEl).y+'px').duration(100).ease(animation.ease.begin).ondone(function(){CSS.hide(this._sheetEl);CSS.removeClass(this.tabHandle,'sheetSlide');this._sheetAnimation=null;a&&a();}.bind(this)).go();},isUserScrolled:function(){return (this.chatConv.scrollHeight>this.chatConv.scrollTop+this.chatConv.clientHeight);},scrollToBottom:function(){if(!this.focused)return;this.chatConv.scrollTop=this.chatConv.scrollHeight;this.resizeSheet();},unfocus:function(){if(!this.focused)return;this.focused=false;this.resetAutoCloseTimeout(true);if(this.inDock){Dock.hide(this.tabHandle);}else CSS.removeClass(this.tabHandle,'focused');this._hideCallouts();this.inform('unfocus');},focus:function(c,a,b){if(!this.focused){this.focused=true;this.clearAutoCloseTimeout();this._isFragileMode=false;this._markRead();if(this.inDock){Dock.show(this.tabHandle);}else CSS.addClass(this.tabHandle,'focused');if(!this.historyLoaded)this.getHistory(false);}if(!c)this._onFocusUIActions(b);this.inform('focus');},_onFocusUIActions:function(a){this.handleResize();this.scrollToBottom();this.focusChatInput(a);},_startBounce:function(){var a=-8;this.bounceAnimation=animation(this.tabCount).to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-12).duration(this.bounceDuration).checkpoint().to('top',-10).duration(this.bounceDuration).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().go();},_stopBounce:function(){if(this.bounceAnimation){this.bounceAnimation.stop();this.bounceAnimation=null;}},close:function(){if(this.inDock)Dock.unregisterNubController(this.tabHandle);while(this._handlers.length)this._handlers.pop().remove();this._subscriptions.each(Arbiter.unsubscribe);MessagingEvents.unsubscribe(this._messagingToken);this._callIncomingToken&&VideoEvents.unsubscribe(this._callIncomingToken);if(this._textareaListener){var a=DataStore.get(this.chatInput,'DOMControl');a.unsubscribe(this._textareaListener);delete this._textareaListener;this._textareaListener=null;}this.clearAutoCloseTimeout();this.tabHandle.parentNode.removeChild(this.tabHandle);this._hideCallouts();},newTyping:function(d){var b=d.from;var g=d.to;var h=d.st;var a=d.fl;var e=d.offline;var c=d.from_mobile;if(!ChatConfig.get('typing_notifications')||new Date()-this.lastMessageAt<this.typingIndicator.notifyDelay)return;presence.debug('typing from '+b+': '+h);var f=h==TypingDetector.TYPING&&this.numMissed===0&&!e;if(g!=this.id){if(presence.inPopoutWindow)CSS.conditionClass(this.popoutTab,'typing',f);CSS.conditionClass(this.tabHandle,'typing',f);if(!c)AvailableList.set(this.id,AvailableList.ACTIVE,a);}},newMsg:function(e){var a=e.from;var i=e.to;var j=e.type;var c=e.msg;var h=c.time;var d=c.msgID;if(this.autoCloseTimeoutID)this.resetAutoCloseTimeout(false);this.lastMessageAt=new Date();var f=this.chatDisplay.addToHistory(this.id,e);if(a!=this.chatDisplay.user){var g=this.chatDisplay.isSquelched()||this.chatDisplay.isSquelchedTab(this.id);this._isFragileMode=false;if(g){this._markRead(h);}else{if(this.focused){this._markRead(h);if(!this.isWindowFocused)this.playSound();}else this._markUnread(h);this._messagingMarkAsRead();}if(presence.inPopoutWindow)CSS.removeClass(this.popoutTab,'typing');CSS.removeClass(this.tabHandle,'typing');}else{this._markRead();if(this._removeDuplicatePendingMessage(d))f=false;}f=this.getMessageTypeInfo(j).visible&&f;if(f){var b=this.isUserScrolled();this.renderMsg(a,i,h,c,d);!b&&this.scrollToBottom();this.lastLogItem=e;}},_removeDuplicatePendingMessage:function(b){for(var a=0;a<this.pendingSentMsgs.length;a++)if(b==this.pendingSentMsgs[a].msgID){var c=this.pendingSentMsgs.splice(a,1);this._popSendQueue();this.chatDisplay.reportLatency(new Date().getTime()-c[0].created);return true;}return false;},getInputElem:function(){return this.chatInput;},_messagingMarkAsRead:function(){if(!ChatConfig.get('titan'))return;this._clearMessagingMarkAsRead();var a=chatOptions.getSetting('idle_cutoff');if(a&&UserActivity.isActive(a)){this._messagingMarkThreadAsRead(this.id);}else this._pendingMessagingMarkAsRead=UserActivity.subscribe(this._messagingMarkAsRead.bind(this));},_messagingMarkThreadAsRead:function(a){Messaging.markUserThreadAsRead(a);},_clearMessagingMarkAsRead:function(){if(this._pendingMessagingMarkAsRead){UserActivity.unsubscribe(this._pendingMessagingMarkAsRead);delete this._pendingMessagingMarkAsRead;}},_markRead:function(){this._updateNumMissed(0);this._stopBounce();},_markUnread:function(a){this._updateNumMissed(this.numMissed+1,a);this._startBounce();this.playSound();},squelch:function(){this._markRead();},_updateNumMissed:function(a,b){if(a==this.numMissed||(b&&b<=this.missedTime))return;if(a>99)a=99;this.numMissed=a;this.missedTime=b;this._updateNumMissedDisplay();},_updateNumMissedDisplay:function(){DOM.setContent(this.tabCount,this.numMissed);if(this.inDock)window.chatTabSlider&&chatTabSlider.updateMissedCount();CSS.conditionClass(this.tabHandle,'highlight',this.numMissed>0);CSS.conditionShow(this.tabCount,this.numMissed>0);},_checkDateBreak:function(d){var c=new Date();c.setTime(d);var b=new Date();if(this.lastLogItem)b.setTime(this.lastLogItem.time);var a=null;if(!this.lastLogItem||c.getDate()!==b.getDate()||c.getMonth()!==b.getMonth()){a=this.chatDisplay.templates['chat-msg-date-break'].render();DOM.setContent(a,renderDate(c,!presence.inPopoutWindow));DOM.appendContent(this.chatConvContent,a);this.currentMsgGroup=null;}},_renderLogMessage:function(a){if(presence.inPopoutWindow)return;var c=this.chatDisplay.templates['chat-msg-event'].render();var d=XHPTemplate.getNode(c,'timestamp');var b=this.chatDisplay.renderServerTime(a.time);DOM.setContent(d,b);this._checkDateBreak(a.time);switch(a.log_type){case LogMessageType.VIDEO_CALL:this._renderVideoMsg(c,a.videoMsg,a.params);break;case LogMessageType.THREAD_NAME:this._renderThreadNameMsg(c,a);break;case LogMessageType.THREAD_IMAGE:this._renderThreadImageMsg(c,a);break;}},_renderVideoMsg:function(c,a,b){ChatUserInfoManager.get(this.id,function(d){this._renderVideoMsgWithName(c,a,b,d.firstName);}.bind(this));},_renderVideoMsgWithName:function(h,f,g,b){var d=XHPTemplate.getNode(h,'icon');CSS.addClass(d,'videoCallIcon');var e=XHPTemplate.getNode(h,'message');var a=true;if(f=='missed-call'){Bootloader.loadComponents('VideoChatPlugin',function(){DOM.setContent(e,_tx("You missed a call from {firstname}.",{firstname:b}));if(ChatConfig.get('video.can_call',false)&&VideoChatPlugin.isSupported()){var j=$N('a',{href:'#',className:'callBackLink'},_tx("Call Back"));j.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(j,'click',(function(){VideoEvents.inform(VideoEvents.START_CALL_UI,{idTarget:this.id});return false;}).bind(this));DOM.appendContent(e,j);}DOM.appendContent(this.chatConvContent,h);}.bind(this));a=false;}else{var c=f=='caller-history'||(f=='connected-call'&&g.to==presence.user);var i=c?_tx("You called {firstname}.",{firstname:b}):_tx("{firstname} called you.",{firstname:b});DOM.setContent(e,HTML(i));}a&&DOM.appendContent(this.chatConvContent,h);this.currentMsgGroup=null;},_renderThreadNameMsg:function(f,e){var b=XHPTemplate.getNode(f,'icon');b.src='/images/messaging/read/system_messages/edit-name.png';var a=this._getLinkifiedName(this.chatDisplay.user,e.actor_info);var d=null;if(e.cleared){d=_tx("{actor} removed the conversation name.",{actor:a});}else{var g='<b>'+e.thread_name+'</b>';d=_tx("{actor} named the conversation: {name}.",{actor:a,name:g});}var c=XHPTemplate.getNode(f,'message');DOM.setContent(c,HTML(d));DOM.appendContent(this.chatConvContent,f);},_renderThreadImageMsg:function(f,e){var b=XHPTemplate.getNode(f,'icon');b.src='/images/messaging/read/system_messages/change-picture.png';var a=this._getLinkifiedName(this.chatDisplay.user,e.actor_info);var d=null;if(e.cleared){d=_tx("{actor} removed the conversation picture.",{actor:a});}else d=_tx("{actor} changed the conversation picture.",{actor:a});var c=XHPTemplate.getNode(f,'message');DOM.setContent(c,HTML(d));DOM.appendContent(this.chatConvContent,f);},renderMsg:function(g,w,v,m,p,i,d){this._checkDateBreak(v);var k=this.chatDisplay.templates['chat-msg'].render();k.id='msg_'+this.id+'_'+p;CSS.addClass(k,is_rtl(m.text)?'direction_rtl':'direction_ltr');var h=m.text.substr(0,4)=='?OTR';var s=false;CSS.conditionClass(k,'cyphertext',h);if(h){DOM.setContent(k,_tx("[encrypted message]"));}else{var n=[];var o=m.text;var u;var q;var j;if(m.spoof){q=new RegExp('^\\s*<([^<>]+?)>\\s+');j=o.match(q);if(j){o=o.substr(j[0].length);d=this._renderMsgWarning(j[1]);}if(m.subject){j=m.subject.match(q);if(j){m.subject=m.subject.substr(j[0].length);d=this._renderMsgWarning(j[1]);}}}if(m.subject){var t=this.chatDisplay.templates['chat-msg-subject'].render();DOM.setContent(t,m.subject);DOM.appendContent(k,t);this.currentMsgGroup=null;}if(m.truncated||m.forward||m.attachment){q=new RegExp('(?:\\.{3}\\s+)?'+'(?:<([^<>]+?)>\\s+)?'+'(?:<([^<>]+?)>\\s+)?'+'(\\S+)\\s*$');j=o.match(q);if(j){o=o.substr(0,o.lastIndexOf(j[0]));var u=j[3];if(m.truncated){n.push(HTML('&hellip; '));var l=$N('a',{href:u,className:'more'},_tx("See all"));n.push(l);}if(m.forward){var f=this.chatDisplay.templates['chat-msg-forward'].render();f.href=u;var e=XHPTemplate.getNode(f,'label');DOM.setContent(e,j[1]);n.push($N('div',f));s=true;}if(m.attachment){var b=this.chatDisplay.templates['chat-msg-attachment'].render();b.href=u;var a=XHPTemplate.getNode(b,'label');DOM.setContent(a,j[2]||j[1]);n.push($N('div',b));s=true;}}}if(!s&&URLScraper.match(o))s=true;if(!this.chatDisplay.user||this.chatDisplay.user==g)s=false;n.unshift(HTML(this._renderMsgHtmlize(o)));DOM.appendContent(k,n);}var c=this.getCurrentMsgGroup(g,w,v);if(s&&ChatConfig.get('report')){CSS.show(XHPTemplate.getNode(c,'reportLinkWithDot'));var r=URI(this.chatDisplay.reportURL).addQueryData({id:g}).addQueryData({src:'timestamp_report_link'});reportLink=XHPTemplate.getNode(c,'reportLink');reportLink.setAttribute('href',r);}this.addMessageToGroup(k,c);d&&this.addMessageToGroup(d,c);},_renderMsgHtmlize:function(a){return html_hyperlink(a||'',Emote.htmlEmote,null,true);},newVideoMsg:function(d,b){this.clearAutoCloseTimeout();var c=b.time||presence.getTime();var a={type:'logmessage',log_type:LogMessageType.VIDEO_CALL,videoMsg:d,time:c,params:b};if(d==='missed-call')if(this.focused){this._markRead(c);this._messagingMarkAsRead();if(!this.isWindowFocused)this.playSound();}else this._markUnread(c);this.newLogMessage(a);},newLogMessage:function(b){var a=this.isUserScrolled();this._renderLogMessage(b);!a&&this.scrollToBottom();this.lastLogItem=b;this.chatDisplay.addToHistory(this.id,b);},playSound:function(){if(ChatConfig.get('sound_enabled')&&chatOptions.getSetting('sound'))Sound.play('/sound/pling.mp3',true);},getMessageTypeInfo:function(a){if(a=='logmessage'){return {visible:true,user:false,preserveHistory:true,logMessage:true};}else if(a=='actionlog'){return {visible:true,user:false,preserveHistory:false,actionLog:true};}else return {visible:true,user:true,preserveHistory:false,msg:true};},addMessageToGroup:function(b,a){DOM.appendContent(XHPTemplate.getNode(a,'messages'),b);},getCurrentMsgGroup:function(a,i,g){if(!this.currentMsgGroup||!this.lastLogItem||this.lastLogItem.from!=a||(g-this.lastLogItem.time)>this.msgBunchTime){var c=this.chatDisplay.templates[this.msgGroupRendererName].render();var d=XHPTemplate.getNode(c,'profileLink');var e=XHPTemplate.getNode(c,'profilePhoto');var f=function(j){if(CSS.hasClass(d,'profileTooltipLink')){TooltipLink.setTooltipText(d,j);}else if(j){e.setAttribute('title',j);}else e.removeAttribute('title');};var b=a==this.chatDisplay.user;!b&&f('');ChatUserInfoManager.get(a,function(k){e.src=k.thumbSrc;if(k.exist){var j=env_get('www_base');if(k.vanity){j+=k.vanity;}else j+='profile.php?id='+a;d.setAttribute('href',j);}!b&&f(k.name);});var h=this.chatDisplay.renderServerTime(g);DOM.setContent(XHPTemplate.getNode(c,'timestamp'),h);DOM.appendContent(this.chatConvContent,c);this.currentMsgGroup=c;}return this.currentMsgGroup;},getAvailability:function(){return AvailableList.get(this.id);},getTabDOM:function(){return this.tabHandle;},_isFragileMode:false,setFragileMode:function(){this._isFragileMode=true;this._subscriptions.push(Arbiter.subscribe('page_transition',this._removeFragileTab.bind(this)));},_removeFragileTab:function(){if(!this._isFragileMode)return;this.chatDisplay.closeTab(this.id);},resetAutoCloseTimeout:function(a){if(this.getPostType()=='group')return;if(this.autoCloseTimeoutID)clearTimeout(this.autoCloseTimeoutID);var b=ChatConfig.get('tab_auto_close_timeout_ms');var c=Math.floor(ChatConfig.get('tab_auto_close_timeout_variation_range_ms')*Math.random());this.autoCloseTimeoutID=setTimeout(this._autoCloseTab.shield(this),b+c,false);if(a)this.staleTime=(new Date()).getTime();},clearAutoCloseTimeout:function(){if(this.getPostType()=='group')return;if(this.autoCloseTimeoutID){clearTimeout(this.autoCloseTimeoutID);delete this.autoCloseTimeoutID;}this.staleTime=null;},_autoCloseTab:function(){if(!this.staleTime)this.staleTime=(new Date()).getTime();if(ChatConfig.get('tab_auto_close_enabled')&&!this.focused&&this.chatDisplay.isUserIdle()&&!this.chatDisplay.inNLatestActiveTabs(this.id,ChatConfig.get('tab_auto_close_min_tab_count'))){this.chatDisplay.closeTab(this.id);delete this.autoCloseTimeoutID;}else this.resetAutoCloseTimeout(false);}});function renderDate(a,e){if(e){var f=new Date();f.setHours(0);f.setMinutes(0);f.setSeconds(0);f.setMilliseconds(0);var b=24*60*60*1000;var c=f.getTime()-a.getTime();if(c<=0){return _tx("Today");}else if(c<b)return _tx("Yesterday");}var d='';switch(a.getMonth()){case 0:d=_tx("January");break;case 1:d=_tx("February");break;case 2:d=_tx("March");break;case 3:d=_tx("April");break;case 4:d=_tx("May");break;case 5:d=_tx("June");break;case 6:d=_tx("July");break;case 7:d=_tx("August");break;case 8:d=_tx("September");break;case 9:d=_tx("October");break;case 10:d=_tx("November");break;case 11:d=_tx("December");break;}return _tx("{month} {date}",{month:d,date:a.getDate()});}onloadRegister(function(){if(ua.firefox()){var a=function(){return CSS.getStyle(document.body,'overflowX')+' '+CSS.getStyle(document.body,'overflowY');};var b=a();document.body.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.body&&(event.attrName==='class'||event.attrName==='style')){var c=a();if(c!==b){b=c;Arbiter.inform('overflow-applied-to-body');}}},false);}});
function ChatDisplayInterim(e,c,a,d,b,f){this.histories=e;this.user=presence.user;var g=env_get('www_base');this.messageURL=g+'ajax/messaging/composer.php';this.settingsURL='/ajax/chat/settings.php';this.tabsURL='/ajax/chat/tabs.php';this.visibilityURL='/ajax/chat/visibility.php';this.reportURL='/ajax/chat/report.php';this.templates=f;this.controllers=copy_properties({friend:'ChatTab',group:'ChatGroupTab',thread:'ChatThreadTab'},b);this.renderServerTime=ChatConfig.get('24h_times')?this._renderServerTime24hr:this._renderServerTime12hr;this.jabberSquelchInterval=300000;this._squelchUntil=null;this._squelchedIds={};this._reportedLatencies=0;this._jslog=new JSLogger('chat_display');this._init(a,d);}ChatDisplayInterim.prototype={maxNumTabs:20,_init:function(a,b){this.loaded=false;this.tabs={};this.tabList=[];this.numTabs=0;this.lastFocused=null;this.newMsgNames=[];this.newMsgNamesIndex=0;this.blinkingTimer=null;this.chatActivityTime=0;this.uiChangeTime=0;this.uiCookieCacheTime=(Env.rep_lag+presence.sitevars.CHAT_UI_COOKIE_CACHE_WINDOW)*1000;this.initialFocusedChat=b;this.initialActiveChats=a;presence.registerStateStorer(this._store.bind(this));presence.registerStateLoader(this._load.bind(this));var c=['unfocus_chat','focus_chat','close_chat','group_msg','thread_msg','msg','typ','video','chat_event','buddylist_overlay','start_multichat','show_multichat_callout','update_multichat_participants'].map(PresenceMessage.getArbiterMessageType);Arbiter.subscribe(c,this._handlePresenceMessage.bind(this));Arbiter.subscribe(PresenceMessage.STARTED,this.start.bind(this));Arbiter.subscribe(PresenceMessage.SHUTDOWN,this.shutdown.bind(this));Arbiter.subscribe(PresenceMessage.RESTARTED,this.restart.bind(this));Arbiter.subscribe(PresenceMessage.WINDOW_RESIZED,this.handleResize.bind(this));Arbiter.subscribe(channel.ON_INVALID_HISTORY,this.handleInvalidHistory.bind(this));Arbiter.subscribe(channel.ON_CONNECT,function(e,d){(d<=1?this.start():this.restart());}.bind(this));Arbiter.subscribe(channel.ON_SHUTDOWN,this.shutdown.bind(this));Event.listen(window,'focus',this.onWindowFocus.bind(this));Event.listen(window,'blur',this.onWindowBlur.bind(this));Arbiter.subscribe('chat/visibility-changed',this._handleVisibilityChange.shield(this));Arbiter.subscribe('time_check',function(d,e){if(this.focused&&e>30000){this._jslog.log('time_check_refresh');this.tabs[this.focused].getHistory();}}.bind(this));},_jslog:new JSLogger('chat_display'),_handleVisibilityChange:function(){var a=Chat.isOnline();if(!a)this.closeAllTabs();},onWindowFocus:function(){this.isWindowFocused=true;this.doStopBlinking();},onWindowBlur:function(){this.isWindowFocused=false;},start:function(){for(var a in this.tabs)this.tabs[a].start();},shutdown:function(){this._stopBlinking();},restart:function(){for(var a in this.tabs)this.tabs[a].restart();},loadInitialUserInfo:function(c,d,a,b,e){if(ChatUserInfos[c])return;ChatUserInfos[c]={name:d,firstName:a,thumbSrc:'',gender:b||GenderConst.UNKNOWN,type:e||'friend'};},_loadInitialTabs:function(a,c,h){for(var d=0,f=a.length;d<f;d++){var k=a[d];var e=k.i;if(this.tabs[e]||this.isSquelchedTab(e))continue;var i,b,l;if(e in ChatUserInfos){i=ChatUserInfos[e].name;b=ChatUserInfos[e].firstName;l=ChatUserInfos[e].type;}else{i=k.n;if(!i){this._jslog.log('tab_load_failure_no_name',{tab_id:e});continue;}b=k.fn||getFirstName(i);l=k.type||'friend';}var j=k.m||0;var g=k.t||0;this.createTab(l,e,i,b,j,g);}if(h)h.each(function(m){if(m.tb&&m.tt){var o=m.i;var n=this.tabs[o];if(n){this.updateMultichatToolbar(o,n.name,m.tb,m.tt,m.memberstatuses);n.setHasThread(!m.nothread);}}}.bind(this));if(presence.inPopoutWindow&&!c&&a.length)c=a[0].i;if(c&&(c!=this.focused)&&!this.isSquelchedTab(c))this._focusTab.bind(this,c).defer();window.chatTabSlider&&chatTabSlider.addTab();this.loadedInitialTabs=true;presence.doSync();},load:function(){Arbiter.subscribe('available-list/initialized',function(){this._load(presence.state);Arbiter.inform('chat-display/loaded',this,Arbiter.BEHAVIOR_PERSISTENT);}.bind(this));},loadTabFragile:function(b,d,a,e){if(presence.isOnline()){if(!this.tabs[b]){var c={i:b,n:d,fn:a,type:e};this._loadInitialTabs([c]);this.tabs[b].setFragileMode();this._jslog.log('load_fragile',c);}}else this._jslog.log('no_load_fragile_offline');},_load:function(f){var c=false;if(f){if(this.blinkingTimer&&f.sb)this._stopBlinking();this._squelchUntil=f.sq;this.chatActivityTime=verifyNumber(f.ct)*1000;this.uiChangeTime=Math.max(this.uiChangeTime,verifyNumber(f.uct)*1000);if(!this.loaded){var d=presence.getTime();if(d-this.uiChangeTime<this.uiCookieCacheTime||ChatConfig.get('chat_client_tabs')){presence.debug('chatDisplay: loading tabs from cookie cache');if(f.t){var e=(d-f.ut>60*60*1000);for(var a=0,b=f.t.length;a<b;a++)if(e)f.t[a].m=0;}this._loadInitialTabs(f.t,f.f,this.initialActiveChats);c=true;}}}if(!this.loaded&&!c){presence.debug('chatDisplay: loading tabs from server state');this._loadInitialTabs(this.initialActiveChats,this.initialFocusedChat,this.initialActiveChats);this.initialFocusedChat=this.initialActiveChats=false;}this.loaded=true;},_store:function(d){d.ct=Math.floor(this.chatActivityTime*.001);d.sb=(this.blinkingTimer==null)?1:0;var e=this.getSquelchUntil();if(e!==null)d.sq=e;d.t=[];d.f=null;d.uct=0;var c=presence.getTime();if(c-this.uiChangeTime<this.uiCookieCacheTime||ChatConfig.get('chat_save_client_tabs')){for(var a=0,b=this.tabList.length;a<b;a++){var g=this.tabList[a];var f={i:g.id};if(g.numMissed)f.m=g.numMissed;d.t.push(f);}d.f=this.focused;d.uct=Math.floor(this.uiChangeTime*.001);}return d;},handleResize:function(){if(!this.focused)return;var a=this.tabs[this.focused];a.handleResize();},handleInvalidHistory:function(){var a=this.focused&&this.tabs[this.focused];if(a)a.getHistory(true);},_sendTabStateChange:function(a){a.window_id=presence.windowID;new AsyncRequest().setURI(this.tabsURL).setData(a).setHandler(this._onCheckTabStateChangeResponse.bind(this,a)).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_sendDeferredTabStateChange:function(a){clearTimeout(this._deferredTabStateChange);this._deferredTabStateChange=this._sendTabStateChange.bind(this,a).defer();},_onCheckTabStateChangeResponse:function(b,d){var a=(b&&b.focus_chat)||null;var e=a&&AvailableList.get(a);var c=d.getPayload();if(c&&c.overlay){AvailableList.addLegacyOverlay(c.overlay);if(e&&!AvailableList.get(a))presence.error("presence:ol_on_to_off:id="+a);}},reloadTabs:function(){for(var a in this.tabs)this.tabs[a].loadData();},_closeTab:function(a){if(!this.tabs[a])return;var c=this.tabList.indexOf(this.tabs[a]);if(this.focused==a)if(presence.inPopoutWindow){var b=this.tabList.length;var d=this.tabList[((c+(c?-1:1))+b)%b].id;if(d!=a){this.focusTab(d);}else this.focused=null;}else this.focused=null;this.tabs[a].close();this.tabList.splice(c,1);delete this.tabs[a];this.numTabs--;Arbiter.inform('chat/conversation-closed',{id:a});window.chatTabSlider&&chatTabSlider.close();},uiChanged:function(){this.uiChangeTime=presence.getTime();presence.doSync();},closeTab:function(a){this._closeTab(a);this._sendTabStateChange({close_chat:a});this.uiChanged();this.doStopBlinking();},closeAllTabs:function(){for(var a in this.tabs)this._closeTab(a);this.uiChanged();this.doStopBlinking();},_unfocus:function(b){var a=this.focused;if(!a||(b&&a!=b))return false;this.focused=null;if(presence.inPopoutWindow)this.tabs[a].deselectPopoutChat();this.tabs[a].unfocus();Arbiter.inform('chat/conversation-unfocused',{id:a,conversation:this.tabs[a]});return true;},unfocus:function(a,b){if(this._unfocus(a)&&b!==false){this._sendDeferredTabStateChange({unfocus_chat:1});this.uiChanged();this.doStopBlinking();}this.lastFocused=null;},unfocusNoSync:function(){this._unfocus();},refocus:function(){if(!this.lastFocused||!this.tabs[this.lastFocused])return null;this._focusTab(this.lastFocused);},_focusTab:function(d,b,e,a,f){if(!this.tabs[d]){if(!e)if(ChatUserInfos[d]&&ChatUserInfos[d].name){e=ChatUserInfos[d].name;a=ChatUserInfos[d].firstName;}else{presence.warn("chat:tab creation aborted:couldn't create tab "+d+" since no name is specified");return null;}if(!a)a=e;if(!f)if(ChatUserInfos[d]&&ChatUserInfos[d].type){f=ChatUserInfos[d].type;}else f='friend';this.createTab(f,d,e,a);window.chatTabSlider&&chatTabSlider.addTab(d);}window.chatTabSlider&&chatTabSlider.gotoTab(d);if(this.focused!=d){if(this.focused){this.tabs[this.focused].unfocus();if(presence.inPopoutWindow)this.tabs[this.focused].deselectPopoutChat();}this.focused=d;this.lastFocused=d;}var c=!presence.inPopoutWindow&&presence.poppedOut;this.tabs[d].focus(c,this.loaded,b);if(presence.inPopoutWindow)this.tabs[d].selectPopoutChat();Arbiter.inform('chat/conversation-focused',{id:d,conversation:this.tabs[d]});return this.tabs[d];},focusTab:function(c,b,d,a,e){presence.pauseSync();this._focusTab(c,b,d,a,e);this._sendDeferredTabStateChange({focus_chat:c});this.uiChanged();this.chatActivityTime=(new Date()).getTime();this.doStopBlinking();presence.resumeSync();},toggleTab:function(c,b,d,a){if(this.focused==c){this.unfocus();}else this.focusTab(c,b,d,a);},getNextTabId:function(a,e,f){if(!(a in this.tabs))return -1;var c=this.tabList.indexOf(this.tabs[a]);if(!presence.inPopoutWindow)e=!e;if(!f)if((c===0&&e)||(c===this.tabList.length-1&&!e))return 0;var d=a;if(c>=0){if(e){c--;}else c++;var b=this.tabList.length;d=this.tabList[(c+b)%b].id;}return d;},_handleBlinking:function(a,c){var b=(a==this.user);if(b){this.doStopBlinking(true);}else if(this.isWindowFocused){setTimeout(this.doStopBlinking.bind(this,true),500,false);}else{this.newMsgNames.push(c);if(!this.blinkingTimer)this.blinkingTimer=this._doBlink.bind(this).defer(3000,false);}},_doBlink:function(){clearTimeout(this.blinkingTimer);if(this._isBlinking){DocumentTitle.set(DocumentTitle.get());this._isBlinking=false;}else{if(this.newMsgNames&&this.newMsgNames.length>0){if(this.newMsgNamesIndex>=this.newMsgNames.length)this.newMsgNamesIndex=0;var a=this.newMsgNames[this.newMsgNamesIndex++];if(a.groupMsg){DocumentTitle.set(_tx("{senderName} messaged {groupName}",{senderName:a.fromName,groupName:a.toName}),true);}else DocumentTitle.set(_tx("{name} messaged you",{name:a.fromName}),true);}else DocumentTitle.set(_tx("New message!"),true);this._isBlinking=true;}this.blinkingTimer=this._doBlink.bind(this).defer(1500,false);},doStopBlinking:function(a){if(this.blinkingTimer||a){this._stopBlinking();presence.doSync();}},_stopBlinking:function(){if(this.blinkingTimer){if(this._isBlinking)this._doBlink();clearTimeout(this.blinkingTimer);this.blinkingTimer=null;this.newMsgNames=[];this.newMsgNamesIndex=0;}},_isChatMessage:function(a){return a.type=='msg'||a.type=='group_msg'||a.type=='thread_msg';},_handlePresenceMessage:function(o,a){if(!Chat.isOnline())return;var i=a.obj;if(i.window_id==presence.windowID)return;var f=null;if(i.from==this.user){f=i.id||i.to;var e=!!i.csid;this.setSquelched(e);if(e)this._closeTab(f);}else f=i.id||i.from;var m=this.tabs[f];var n=(ChatUserInfos[f]&&ChatUserInfos[f].type)||i.tab_type||'friend';var k=this.isSquelched();var l=this.isSquelchedTab(f);switch(i.type){case 'unfocus_chat':this._unfocus();break;case 'focus_chat':if(!k&&!l)this._focusTab(f,undefined,undefined,undefined,n);break;case 'close_chat':this._closeTab(f);break;case 'thread_msg':case 'group_msg':case 'msg':var c=(i.from==this.user);var h=false;var g,b,d;if(n=='group'){g=i.to_name;b=g;d=GenderConst.UNKNOWN_PLURAL;}else if(c){g=i.to_name;b=i.to_first_name?i.to_first_name:getFirstName(g);d=i.to_gender;}else{g=i.from_name;b=i.from_first_name?i.from_first_name:getFirstName(g);d=i.from_gender;}this.loadInitialUserInfo(f,g,b,d,n);if(!c&&n=='friend'&&!i.sender_offline)AvailableList.set(f,AvailableList.ACTIVE,i.fl);if(!k&&!l&&!c&&!m){m=this.createTab(n,f,g,b);h=true;window.chatTabSlider&&chatTabSlider.addTab(f);}i.time=i.msg.time;if(m)m.newMsg(i);if(h)if(!this.focused){this.focusTab(f);}else m.getHistory();if(m){if(!c&&i.show_orca_callout)m.showOrcaCallout(i.from);if(i.type=='thread_msg'){m.setHasThread(true);this.updateMultichatToolbar(f,i.nub_name,i.titlebar,i.tooltip,i.statuses);this.setTabRecipients(f,i.recipients);}if(presence.inPopoutWindow||!presence.poppedOut)this._handleBlinking(i.from,{toName:i.to_first_name?i.to_first_name:getFirstName(i.to_name),fromName:i.from_first_name?i.from_first_name:getFirstName(i.from_name),groupMsg:i.type=='group_msg'});}break;case 'typ':if(!k||this.focused==f)m&&m.newTyping(i);break;case 'video':this._newVideoMessage(i);break;case 'chat_event':this._newChatEventMessage(i);break;case 'buddylist_overlay':for(var j in i.overlay)ChatUserInfoManager.get(j,function(){var p={};p[j]=i.overlay[j];AvailableList.addLegacyOverlay(p);});break;case 'start_multichat':this.createMultichatTab(f,i.recipients,i.nub_name,i.titlebar,i.tooltip,false,i.statuses);break;case 'show_multichat_callout':this.showMultichatCallout(f);break;case 'update_multichat_participants':this.updateMultichatToolbar(f,i.nub_name,i.titlebar,i.tooltip,i.statuses);this.setTabRecipients(f,i.recipients);if(typeof i.actionType!='undefined')m&&m.newActionLogMsg(i);break;default:break;}},_newVideoMessage:function(a){Arbiter.subscribe('video-chat/initialized',function(c,b){var e=a.from;var f=a.message_type;var g=a.parameters;var d=a.fl;b.handleMessage(e,f,g);if(e!=this.user&&f==b.START_SESSION){this.loadInitialUserInfo(e,g.name,g.firstName,g.gender,'friend');AvailableList.set(e,AvailableList.ACTIVE,d);}}.bind(this));},_newChatEventMessage:function(a){if(presence.inPopoutWindow)return;if(a.log_type==LogMessageType.VIDEO_CALL){this._handleVideoEvent(a.from,a.event_name,a.parameters||{});}else{var b=this.tabs[a.to];b&&b.newLogMessage(a);}},_handleVideoEvent:function(b,a,c){if(!ChatConfig.get('video.can_be_called',false))return;var d=this.tabs[b];switch(a){case 'missed-call':ChatUserInfoManager.get(b,function(e){if(!d)d=this.createTab('friend',b,e.name,e.firstName);if(!this.focused)this._focusTab(b);d.newVideoMsg(a,c);}.bind(this));break;case 'connected-call':if(b==this.user)d=this.tabs[c.to];d&&d.newVideoMsg(a,c);break;}},_getBucketDescription:function(d){var a=[500,1000,2000,3000,5000];var b=["half_s","1s","2s","3s","5s"];for(var c=0;c<a.length;c++)if(d<a[c])return b[c];return "over_5s";},reportLatency:function(b){if(this._reportedLatencies<5){var a=this._getBucketDescription(b);presence.warn("presence:latency_"+a+":delay="+b+",sent="+this._reportedLatencies);this._reportedLatencies++;}},getHistory:function(b,a){a=a||false;if(!this.histories[b]&&a)this.histories[b]=[];return this.histories[b];},addToHistory:function(e,g){var b=this.getHistory(e,true);var h=true;var f=null;for(var d=b.length-1;d>=0;d--)if(this._isChatMessage(b[d])){f=b[d];break;}if(f&&g.time<=f.time){var a=false;for(d=0;d<b.length;d++)if(this._isChatMessage(b[d])&&g.time==b[d].time){a=true;break;}if(a){presence.warn('tabs: already had this msg');return;}for(d=b.length-1;d>=0;d--){var c=b[d];if(this._isChatMessage(c)&&(c.to!=g.to||(!c.time||c.time<g.time)))break;}presence.warn('tabs: merging new msg due to out-of-order server timestamp');if(d==b.length-1){b.push(g);}else{b.splice(d+1,0,g);var i=this.tabs[e];if(i)i._setHistory(b);h=false;}}else this.histories[e].push(g);return h;},_renderServerTime12hr:function(d){var e=new Date();e.setTime(d+presence.timeSkew);var b=e.getHours();var a='am';if(b>=12){a='pm';b-=12;}if(b==0)b=12;var c=e.getMinutes();if(c<10)c='0'+c;var f=b+':'+c+a;return f;},_renderServerTime24hr:function(c){var d=new Date();d.setTime(c+presence.timeSkew);var a=d.getHours();if(a<10)a='0'+a;var b=d.getMinutes();if(b<10)b='0'+b;var e=a+':'+b;return e;},setSquelched:function(c){if(c){var a=(new Date()).valueOf();var b=a+this.jabberSquelchInterval;this._squelchUntil=b;presence.doSync();this.clearHistory();}else if(this._squelchUntil){this._squelchUntil=null;presence.doSync();}},isSquelched:function(){return this.getSquelchUntil()!==null;},setSquelchedTab:function(a,b){if(b){this._squelchedIds[a]=true;this.tabs[a]&&this.tabs[a].squelch();this.clearHistory(a);}else delete this._squelchedIds[a];},clearHistory:function(a){if(a){this.histories[a]&&delete this.histories[a];}else this.histories={};},isSquelchedTab:function(a){return a in this._squelchedIds;},getSquelchUntil:function(){if(this._squelchUntil===null)return null;var a=(new Date()).valueOf();var b=a+(this.jabberSquelchInterval+5000);if(b<this._squelchUntil){this.setSquelched(false);return null;}else if(a<this._squelchUntil){return this._squelchUntil;}else{this.setSquelched(false);return null;}},_enforceTabLimit:function(){var a=0;while(this.numTabs>this.maxNumTabs&&a<this.numTabs-1)if(this.tabList[a].focused||this.tabList[a].numMissed){++a;}else this.closeTab(this.tabList[a].id);},createMultichatTab:function(e,c,b,f,g,a,d){if(typeof this.tabs[e]=='undefined')this.createTab('thread',e,b,b,0,0);this.tabs[e].setHasThread(a);this.tabs[e].addRecipients(c);this.focusTab(e,true,b,b,'thread');this.updateMultichatToolbar(e,b,f,g,d);},showMultichatCallout:function(b){if(this.tabs[b]){var a=DOM.scry(this.tabs[b].tabHandle,'a.addToThread');if(a.length==1)new AsyncRequest().setData({thread_id:b}).setRelativeTo(a[0]).setURI('/ajax/chat/multichat/callout.php').setAllowCrossPageTransition(true).send();}},setTabRecipients:function(b,a){if(this.tabs[b])this.tabs[b].setRecipients(a);},updateMultichatToolbar:function(f,c,g,h,d){var e=this.tabs[f];if(e){var b=DOM.find(e.getTabDOM(),'div.titlebarLabel');DOM.setContent(b,g);TooltipLink.setTooltipText(b.firstChild,h);var a=XHPTemplate.getNode(e.getTabDOM(),'fbDockChatTab');if(a)TooltipLink.setTooltipText(a.firstChild,h);e.updateName(c);if(d){e.refreshStatusUpdateTime();e.setParticipantStatuses(d);}}},createTab:function(h,c,e,b,f,d){var a=window[this.controllers[h]];var g=new a(this,c,e,b,f,d);this.tabs[c]=g;this.tabList.push(g);this.numTabs++;Arbiter.inform('chat/conversation-opened',{id:c,conversation:g});this._enforceTabLimit();return g;},inNLatestActiveTabs:function(c,b){var d=keys(this.tabs);d.sort(function(e,f){return this.tabs[e].staleTime-this.tabs[f].staleTime;}.bind(this));for(var a=d.length-b;a<d.length;a++)if(d[a]==c)return true;return false;},isUserIdle:function(){var a=chatOptions.getSetting('idle_cutoff');return (AvailableList.isUserIdle()&&(!a||!UserActivity.isActive(a)));}};function ChatDisplay(d,a,c,b,e){this.parent.construct(this,d,false,a,c,b,e);}Class.extend(ChatDisplay,'ChatDisplayInterim');
function ChatBuddyList(){this.user=presence.user;this.buddyListID=ChatBuddyList.ID++;this.errorMode=false;this.shouldShowLoading=false;this.sortedList=[];this.flMode=false;this.flData={};this.otherFriendsFlid='-1';this.botsFlid='-2';this.showingErrorMessage=false;this.flSortableGroup=null;this.reorderingLists=false;this.flOpts={};this.externalFlids=[];this.updateOverlay={};}copy_properties(ChatBuddyList,{ID:0,OVERLAY_ONLINE:0,OVERLAY_IDLE:1,OVERLAY_OFFLINE:-1,OVERLAY_MOBILE:2,DEFAULT_OPTS:{fullDisplay:true,excludeIds:{}},MAX_BUDDY_NAME_LENGTH:20});Class.mixin(ChatBuddyList,'Arbiter',{_lastRenderRev:null,_lastSortRev:null,_showTime:null,init:function(d,c,b,a){this.root=d;this.flMode=b;this.flData=a;this.shouldShowLoading=c;this._log=EagleEye.createLogger('chat-buddylist',.1);this._init();Arbiter.subscribe(['buddylist/availability-changed','buddylist/updated'],this._render.bind(this));Arbiter.subscribe('buddylist/update-error',this._showLoadError.bind(this));Arbiter.subscribe('buddylist/fl-changed',this._handleFlChange.bind(this));},initError:function(a){this.root=a;this.errorMode=true;this._init();},_init:function(){this.loaded=false;this._isVisible=false;this.updateDiff=0;this.rendered=false;this.showingError=false;this.contentDiv=DOM.find(this.root,'div.content');this.buddyListError=DOM.find(this.root,'div.status');Arbiter.subscribe(PresenceMessage.getArbiterMessageType('fl_settings'),this._handleFLMessage.bind(this));Arbiter.subscribe('chat/connect',this._showLoading.bind(this));this.setCompactDisplay(chatOptions.getSetting('compact_buddylist'));Arbiter.subscribe('chat/option-changed',this._updateSetting.bind(this));Arbiter.inform('buddylist/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);this.inform('initialized',this,Arbiter.BEHAVIOR_PERSISTENT);},setCompactDisplay:function(a){this.isCompactDisplay=a;if(this.isCompactDisplay){this.itemHeight=18;}else this.itemHeight=22;if(this.rendered)this._render();},_handleFLMessage:function(c,a){var b=a.obj;if(b.fl_mode)this._updateNames(b.fl_data);},_updateNames:function(b){for(var a in this.flData)if(typeof b[a]!='undefined'&&b[a].n!=this.flData[a].n){flname=b[a].n;elem=ge(this._getFriendListNameId(a));if(elem)DOM.setContent(elem,flname);}},_flChanged:function(b,a){return (b!=this.flMode||!are_equal(a,this.flData));},_onFlChange:function(d,c){this._dirtyRendering();if(!this.rendered){this.flMode=d;this.flData=c;return;}var g=[];var h=[];var f=[];var e=[];if(this.flMode&&this.flMode==d){var b=this._groupAvailableListByFl(true);for(var a in c)if(typeof this.flData[a]=='undefined'){if(c[a].h)continue;g.push(a);f.push(a);}else if(this.flData[a].h!=c[a].h){if(c[a].h){h.push(a);}else{g.push(a);if(c[a].o)f.push(a);}}else if(this.flData[a].o!=c[a].o)if(c[a].o){f.push(a);}else e.push(a);for(var a in this.flData)if(typeof c[a]=='undefined')h.push(a);this.flMode=d;if(h.length!=0)this._removeFlidsFromBuddyList(h,b);if(e.length!=0)this._goOfflineToLists(e,true);this.flData=c;if(g.length!=0)this._addFlidsToDOM(g,b);if(f.length!=0)this._goOnlineToLists(f,true);}else if(this.flMode&&this.flMode!=d){var b=this._groupAvailableListByFl(true);h=keys(this.flData);this.flMode=d;this.flData=c;this._addFlidsToDOM([null]);this._removeFlidsFromBuddyList(h,b);}else if(!this.flMode&&this.flMode!=d){for(var a in c){if(c[a].h)continue;g.push(a);if(c[a].o)f.push(a);}this.flMode=d;this.flData=c;this._removeFlidsFromDOM([null]);if(g.length>0)this._addFlidsToDOM(g);if(f.length>0)this._goOnlineToLists.bind(this,f,true).defer();}this._render();},_addFlidsToDOM:function(e,f){f=f||this._groupAvailableListByFl(true);var a=this._getRenderedFriendLists();var c=a[0];var h=$('fbChatBuddyListParent');for(var g=0;g<e.length;g++){var d=e[g];if(this.flMode&&d){var b=DOM.create('div',{id:this._getFriendListId(d),className:this._getFriendListItemClasses(d,f)});DOM.setContent(b,HTML(this._renderFriendListHeader(d)));DOM.appendContent(b,HTML(this._renderFriendListContent(d,[])));if(c==d){DOM.prependContent(h,b);}else{var j=a.indexOf(d);var i=a[j-1];DOM.insertAfter(ge(this._getFriendListId(i)),b);}this._addFlSortable(d);}else DOM.prependContent(h,HTML(this._renderFriendListContent(null,[])));}this._addFriendListListeners(e);},_removeFlidsFromDOM:function(b){for(var c=0;c<b.length;c++){var a=b[c];if(a){if(ge(this._getFriendListId(a))){DOM.remove($(this._getFriendListId(a)));this._removeFlSortable(a);}}else{DOM.remove($(this._getAvailableMarkerId(a)));DOM.remove($(this._getIdleMarkerId(a)));}}},contentChanged:function(){this.inform('content-changed');},show:function(){if(this._isVisible)return;this._showTime=this._showTime||new Date();AvailableList.update();this._isVisible=true;if(!this.rendered){this.shouldShowLoading=true;this._firstRender();if(AvailableList.haveFullList)this._render.bind(this).defer();}CSS.show(this.root);},hide:function(){if(!this._isVisible)return;this._showTime=null;this._isVisible=false;this.exitReorderingFlMode();CSS.hide(this.root);},_getUserFlid:function(c,a){if(a===null||a===undefined){var b=this._getUserFlids(c);a=b[0];}return a;},_getSortedList:function(){if(this._lastSortRev!=AvailableList.getRev()){this.sortedList=this._sort(AvailableList.getAvailableIDs());this._lastSortRev=AvailableList.getRev();}return this.sortedList;},getSortedListUI:function(a){if(!a&&this.flMode){var b=this._groupAvailableListByFl(true);var c=[];for(var a in b)c=c.concat(b[a]);var d={};return c.filter(function(e){return !d[e]&&(d[e]=true);});}return this._getSortedList();},getFriendLists:function(){var a={};copy_properties(a,this.flData);delete a[this.otherFriendsFlid];delete a[this.botsFlid];return a;},_getRenderedFriendLists:function(){var b=[];for(var a in this.flData)if(!this.flData[a].h)b.push(a);return b;},_getFriendListsInChat:function(){var a=this._getRenderedFriendLists();a.remove(this.otherFriendsFlid);a.remove(this.botsFlid);return a;},updateUserInfos:function(a){copy_properties(ChatUserInfos,a);},_sort:function(b){var a=this._compareFunction.bind(this);b.sort(a);return b;},_compareFunction:function(a,d,b,e){if(typeof b=='undefined')b=AvailableList.isIdle(a);if(typeof e=='undefined')e=AvailableList.isIdle(d);if(b^e)return b?1:-1;var c=ChatUserInfos[a].name.toLowerCase();var f=ChatUserInfos[d].name.toLowerCase();return (c<f)?-1:1;},itemOnClick:function(c){var b=DataStore.get(c,'id');var a=DataStore.get(c,'flid');presence.pauseSync();Chat.openTab(b,null,null,'buddylist');if(!this.isSticky())Chat.closeBuddyList();this.inform('buddylist/buddy-clicked',{flid:a,id:b});presence.resumeSync();},_renderItem:function(c,a,d){var i=ChatUserInfos[c];var f=i.name;var h=i.thumbSrc;var e=['<a',' href="#"',' id="',this._getBuddyListItemId(c,a),'"',' class="clearfix friend',(d?' idle':''),'"',' title="',f,'"',' data-id="',parseInt(c,10),'"',' data-flid="',a,'"','>'];var b=!this.isCompactDisplay;var g=this._getFlOpts(a);b&=g.fullDisplay;if(b)e=e.concat('<img src="',h,'" />');e=e.concat('<span id="',this._getBuddyListItemNameId(c,a),'">',htmlize(f),'</span>','</a>');return e.join('');},_groupAvailableListByFl:function(c,a){if(!this.flMode||!this.flData)return null;c=c||false;a=a||false;var e={};for(var b in this.flData)e[b]=[];if(a)return e;var d=c?this._getSortedList():AvailableList.getAvailableIDs();d.forEach(function(h){var g=FriendLists.get(h);if(g)for(var i=0;i<g.length;++i){var f=g[i];e[f]&&e[f].push(h);}});return e;},_listNameInUse:function(b){for(var a in this.flData)if(this.flData[a].n==b)return true;return false;},createFriendList:function(b){if(this._listNameInUse(b)){ErrorDialog.show(_tx("An error occurred."),_tx("You cannot have two lists with the same name. Please create a unique name for this list."));return;}var a={create:b};this._saveBuddyListSetting(a,function(){for(var c in this.flData)if(this.flData[c].n==b){this.scrollIntoView($(this._getFriendListId(c)));Arbiter.inform('friend-list/new',{flid:c,fl_name:b});break;}}.bind(this));},handleFlInChat:function(b,a){if(b){this._unHideFriendListFromChat(a);}else this._hideFriendListFromChat(a);},_unHideFriendListFromChat:function(b){var d=this._getFriendListsInChat().length==0;var c=[b];var a={unhide_from_chat:1,flids:c};this.flData[b].h=0;this._saveBuddyListSetting(a,function(){this._showEmptyListMomentarily(b);this.scrollIntoView($(this._getFriendListId(b)));}.bind(this));if(d){this._onFlChange(true,this.flData);}else this._addFlidsToDOM(c);},_hideFriendListFromChat:function(b){var d=this._getFriendListsInChat().length==1;var c=[b];var a={hide_from_chat:1,flids:c};this.flData[b].h=1;this._saveBuddyListSetting(a);if(d){this._onFlChange(false,this.flData);}else this._removeFlidsFromBuddyList(c);},_friendListHandleSwitchThrown:function(b){var a=this.flData[b].o;if(a){this._goOfflineToLists([b]);}else this._goOnlineToLists([b]);},_friendListHandleSwitchMouseDown:function(b){var a=Event.listen(document,'mouseup',function(){a.remove();this._friendListHandleSwitchThrown(b);}.bind(this));},_friendListHandleMouseOver:function(a){if(this.reorderingLists)return;CSS.addClass($(this._getFriendListId(a)),'hover');},_friendListHandleMouseOut:function(a){CSS.removeClass($(this._getFriendListId(a)),'hover');},_saveBuddyListSetting:function(b,a){b.user=this.user;a=a||bagofholding;new AsyncRequest().setData(b).setURI('/ajax/chat/buddy_list_settings.php').setHandler(this._onBuddyListSettingSave.bind(this,a)).setAllowCrossPageTransition(true).send();},_goOnlineToLists:function(a,b){b=b||false;this._handleFlVisibilityChange(a,1);this._saveBuddyListSetting({online_to_list:1,flids:a,read_only:b,notify_ids:Chat.getActiveFriendChats()});},_handleFlVisibilityChange:function(d,f,a){for(var e=0;e<d.length;e++){var c=d[e];var b=ge(this._getFriendListId(c));if(!b)continue;this.flData[c].o=f;if(f){CSS.addClass(b,'online');CSS.removeClass(b,'offline');if(c==this.otherFriendsFlid)this._showEmptyListMomentarily(c);}else{CSS.addClass(b,'offline');CSS.removeClass(b,'online');}var g=DOM.scry(b,'div.titletip strong')[0];g&&DOM.setContent(g,this._getFriendListTooltipText(c));a&&a(c);}},_showEmptyListMomentarily:function(b){this.shownEmptyFlids=this.shownEmptyFlids||{};this.shownEmptyFlids[b]=1;var a=ge(this._getFriendListId(b));if(a)CSS.addClass(a,'show_empty_list');(function(){delete this.shownEmptyFlids[b];var c=ge(this._getFriendListId(b));if(c)CSS.removeClass(c,'show_empty_list');}).bind(this).defer(8000,false);},_goOfflineToLists:function(a,c){c=c||false;var b=this._groupAvailableListByFl();this._handleFlVisibilityChange(a,0);if(!c)this._saveBuddyListSetting({offline_to_list:1,flids:a,notify_ids:Chat.getActiveFriendChats()});},_removeFlidsFromBuddyList:function(a,b){this._removeFlidsFromDOM(a);},_onBuddyListSettingSave:function(b,a){var d=a.getPayload();if(d){d.userInfos&&this.updateUserInfos(d.userInfos);d.availableList&&AvailableList.addLegacyAvailableList(d.availableList);if(d.flData){var c;if(typeof d.flMode!='undefined'){c=d.flMode;}else c=true;this._onFlChange(c,d.flData);this._resetFlidClasses();}b&&b();}},_resetFlidClasses:function(){if(!this.flMode)return;var c=this._groupAvailableListByFl();for(var b in this.flData){var a=ge(this._getFriendListId(b));if(a)CSS.setClass(a,this._getFriendListItemClasses(b,c));}},_getFriendListItemClasses:function(b,e){var d=this.flData[b].o;var c=this.flData[b].h;var a=['friend_list'];if(d){a.push('online');}else a.push('offline');if(!c&&this.shownEmptyFlids&&this.shownEmptyFlids[b])a.push('show_empty_list');if(b==this.otherFriendsFlid){a.push('compact_friend_list');a.push('other_friends_list');}if(this.reorderingLists&&(b==this.otherFriendsFlid||b==this.botsFlid))a.push('suppress');return a.join(' ');},_renderFriendListHeader:function(c){var b=this.flData[c].n;var e=this.flData[c].o;var a='';var f=typeof this.flData[c].s!='undefined';if(!f&&c!=this.otherFriendsFlid)var a='<a href="/friends/ajax/edit_list.php?list_id='+c+'" '+'rel="dialog-post">'+_tx("edit")+'</a>';var d=['<div class="friendlist_name">','<span class="title"><a href="#" id="'+this._getFriendListNameId(c)+'">',htmlize(b),'</a></span>','<span class="edit_link">',a,'</span>','</div>'];if(!f)d.push('<div class="switch"><a class="online_status" ','>','<div class="titletip"><strong>',this._getFriendListTooltipText(c),'</strong></div>','</a>','</div>');return d.join('');},_getFriendListTooltipText:function(a){return this.flData[a].o?_tx("Go offline"):_tx("Go online");},registerExternalFriendList:function(b){if(!this.rendered)this._firstRender();var a='xfl_'+this.externalFlids.length;this.externalFlids.push(a);this.flOpts[a]=b;return a;},_renderFriendListContent:function(a,i){var l;var d=this.flMode&&a;if(d){l=['<div id="',this._getFriendListContainerId(a),'"','class="friend_list_container">'];}else l=[];l.push('<div id="',this._getAvailableMarkerId(a),'" class="suppress"></div>');var g=[];var b=false,c=false;for(var k=0;k<i.length;k++){var e=i[k];var f=this._isIdle(e);var j=[this._renderItem(e,a,f)];if(f){b=true;g=g.concat(j);}else{c=true;l=l.concat(j);}}var h=(b&&c)?'':' hide_idle_marker';l.push('<div id="',this._getIdleMarkerId(a),'" class="subheader',h,'"></div>');l=l.concat(g);if(d)l.push('</div>');return l.join('');},_isIdle:function(a){return AvailableList.isIdle(a);},_addFriendListListeners:function(c){if(!this.flMode)return;c=c||this._getRenderedFriendLists();for(var d=0;d<c.length;d++){var b=c[d];if(typeof this.flData[b].s!='undefined')continue;var a=$(this._getFriendListId(b));Event.listen(a,'mouseover',this._friendListHandleMouseOver.bind(this,b));Event.listen(a,'mouseout',this._friendListHandleMouseOut.bind(this,b));var e=DOM.find(a,'a.online_status');Event.listen(e,'mousedown',this._friendListHandleSwitchMouseDown.bind(this,b));}},_renderBuddyContent:function(){var a=(AvailableList.getCount()?'hide_empty_item':'');var g=['<div class="subgroup">','<div id="fbChatBuddyListParent" class="list_select">','<div id="',this._getBuddyListEmptyItemId(),'" class="info_text ',a,'">',_tx("No one is available to chat."),'</div>'];var c;var d={};if(this.flMode){c=keys(this.flData);d=this._groupAvailableListByFl(true);}else c=[null];for(var e=0;e<c.length;++e){var b=c[e];var f=[];if(this.flMode&&b){if(this.flData[b].h)continue;g.push('<div id="',this._getFriendListId(b),'"','class="',this._getFriendListItemClasses(b,d),'">',this._renderFriendListHeader(b));f=d[b];}else f=this._getSortedList();g.push(this._renderFriendListContent(b,f));if(this.flMode&&b)g.push('</div>');}g.concat(['</div>','</div>']);return g.join('');},_render:function(){if(!this._isVisible||this._lastRenderRev==AvailableList.getRev())return;this._lastRenderRev=AvailableList.getRev();this._getSortedList();CSS.conditionClass(this.contentDiv,'compact',this.isCompactDisplay);DOM.setContent(this.contentDiv,HTML(this._renderBuddyContent()));if(this.rendered){this._hideError();this._addFriendListListeners();}if(this.errorMode)this._showLoadError();if(this.shouldShowLoading){this._showLoading();this.shouldShowLoading=false;}else if(this._showTime){var a=new Date()-this._showTime;this._showTime=null;this._log({buddy_list_open:a});}},_firstRender:function(){this._render();this.rendered=true;Event.listen(this.contentDiv,'click',function(event){var a=Parent.byClass(event.getTarget(),'friend');a&&this.itemOnClick(a);}.bind(this));},updateItemDisplay:function(d){var a=AvailableList.get(d);if(!a)return;var g=this._getUserFlids(d);for(var c=0;c<g.length;c++){var b=g[c];var f=ge(this._getBuddyListItemId(d,b));if(!f)return;var e=a==AvailableList.IDLE;f=HTML(this._renderItem(d,b,e)).getRootNode();}},_showLoadError:function(){this._showError(_tx("Could not load available friends."));},_showLoading:function(){this._showError(_tx("Loading..."));},_hideError:function(){this.showingError=false;CSS.removeClass(this.root,'error');this.contentChanged();},_showError:function(a){this._dirtyRendering();this.showingError=true;DOM.setContent(this.buddyListError,HTML(a));CSS.addClass(this.root,'error');this.contentChanged();},isSticky:function(){return chatOptions.getSetting('sticky_buddylist');},enterErrorMode:function(a){this.exitErrorMode();this.exitReorderingFlMode();this.showingErrorMessage=true;var b=$N('div',{id:'error_fl_alert'},[$N('span',{className:'helper_text'},a),$N('input',{type:'button',className:'inputbutton',value:_tx("OK"),onclick:this.exitErrorMode.bind(this)})]);DOM.insertBefore(b,this.contentDiv);},exitErrorMode:function(){if(this.showingErrorMessage){DOM.remove($('error_fl_alert'));this.showingErrorMessage=false;}return false;},enterReorderingFlMode:function(){if(this.reorderingLists)return;Bootloader.loadComponents('sort',function(){this.exitErrorMode();this.reorderingLists=true;CSS.addClass(this.root,'reorder_fl');var a=this._getRenderedFriendLists();this.flSortableGroup=new SortableGroup();for(var c=0;c<a.length;c++){var b=a[c];if(b==this.otherFriendsFlid||b==this.botsFlid){CSS.addClass(this._getFriendListId(b),'suppress');}else this._addFlSortable(b);}var d=$N('div',{id:'reorder_fl_alert'},[$N('span',{className:'helper_text'},_tx("Drag lists to re-order.")),$N('input',{type:'button',className:'inputbutton',value:_tx("Finished re-ordering"),onclick:this.exitReorderingFlMode.bind(this)})]);DOM.insertBefore(d,this.contentDiv);this.inform('reorder-mode/enter');this.contentChanged();}.bind(this));},exitReorderingFlMode:function(){if(!this.reorderingLists)return;this._reorderFlids();DOM.remove($('reorder_fl_alert'));CSS.removeClass(this.root,'reorder_fl');var a=this._getRenderedFriendLists();for(var c=0;c<a.length;c++){var b=a[c];if(b==this.otherFriendsFlid||b==this.botsFlid){CSS.removeClass(this._getFriendListId(b),'suppress');}else this._removeFlSortable(b);}this.reorderingLists=false;this.flSortableGroup.destroy();this.flSortableGroup=null;this.inform('reorder-mode/exit');this.contentChanged();},_addFlSortable:function(a){if(this.flSortableGroup!=null)this.flSortableGroup.addSortable(a,$(this._getFriendListId(a)));},_removeFlSortable:function(a){if(this.flSortableGroup!=null)this.flSortableGroup.removeSortable(a);},_reorderFlids:function(){var a={reorder:1,flids:this.flSortableGroup.getOrder()};this._saveBuddyListSetting(a);},_getGlobalFlids:function(a){var b=this.flMode&&this.flData?keys(this.flData):[null];return a?b:b.concat(this.externalFlids);},_getUserFlids:function(d,a,b){var c=(a&&a.fl)?a.fl:FriendLists.get(d);if(!b)c=this._addExternalFlids(d,c);return c;},_addExternalFlids:function(d,b){b=b?$A(b):[];for(var c=0;c<this.externalFlids.length;c++){var a=this.externalFlids[c];var e=this._getFlOpts(a);if(!e.excludeIds[d])b.push(a);}return b;},_getFlOpts:function(a){return this.flOpts[a]||ChatBuddyList.DEFAULT_OPTS;},_getAvailableMarkerId:function(a){return this._encodeFlid('buddy_list_avail_marker',a);},_getIdleMarkerId:function(a){return this._encodeFlid('buddy_list_idle_marker',a);},_getBuddyListItemId:function(b,a){return this._encodeFlid('buddy_list_item_'+b,a);},_getBuddyListItemNameId:function(b,a){return this._encodeFlid('buddy_list_item_name_'+b,a);},_getBuddyListEmptyItemId:function(){return 'buddy_list_empty_item';},_encodeFlid:function(a,b){return (b?(b+'_'+a):a)+'_'+this.buddyListID;},_getFriendListId:function(a){return this._encodeFlid('friend_list_item',a);},_getFriendListNameId:function(a){return this._encodeFlid('friend_list_name',a);},_getFriendListContainerId:function(a){return this._encodeFlid('friend_list_container',a);},debugPrintUpdateOverlay:function(){var b=this.updateOverlay;for(var a in b);},_updateSetting:function(a,b){this._dirtyRendering();switch(b.name){case 'compact_buddylist':this.setCompactDisplay(b.value);break;}this._render();},_dirtyRendering:function(){this._lastRenderRev=null;},_handleFlChange:function(a,c){var d=c.flMode;var b=c.flData;if(this._flChanged(d,b))this._onFlChange(d,b);},scrollIntoView:function(a){var b=a.offsetParent;var d=Rect(a);var c=d.boundWithin(Rect(b)).getPositionVector();d.getPositionVector().sub(c).scrollElementBy(b);}});
function ChatOrderedList(a){this._root=a;this._items={};this._isVisible=false;this._numTopFriends=5;}Class.mixin(ChatOrderedList,'Arbiter',{init:function(a){this._template=a;Event.listen(this._root,'click',this._onClick.bind(this));OrderedFriendsList.subscribe('initialized',this.update.shield(this));Arbiter.subscribe(['available-list/initialized','buddylist/availability-changed'],this.update.shield(this));if(ChatConfig.get('blackbird'))PresencePrivacy.subscribe('privacy-changed',this.update.shield(this));this.inform('initialized',this,Arbiter.BEHAVIOR_PERSISTENT);this._inited=true;this.render();},_getAvailableList:function(){return AvailableList.getAvailableIDs().filter(function(a){return AvailableList.get(a)===AvailableList.ACTIVE;});},_getListItem:function(b){var c=this._items[b];if(c){var a=AvailableList.get(b);CSS.conditionClass(c,'active',a===AvailableList.ACTIVE);CSS.conditionClass(c,'idle',a===AvailableList.IDLE);CSS.conditionClass(c,'mobile',a===AvailableList.MOBILE);if(ChatConfig.get('blackbird'))CSS.conditionClass(c,'invis',!PresencePrivacy.allows(b));}return c;},getSortedList:function(c){var k=OrderedFriendsList.getList();if(ChatConfig.get('blackbird'))k=k.filter(function(n){return PresencePrivacy.get(n)!==PresencePrivacy.BLACKLISTED;});var g=[];if(Chat.isOnline()){var j=ChatConfig.get('ordered_list.top_friends',0);var b=ChatConfig.get('titan')?ChatConfig.get('ordered_list.available_target',0):ChatConfig.get('ordered_list.available_target_non_titan',1);var m=Math.floor(this._numTopFriends*b);var l=[];for(var d=0,f=k.length;d<f&&m>0;d++){var e=k[d];var a=AvailableList.get(e)===AvailableList.ACTIVE;if(a||d<j){g.push(e);a&&m--;}else l.push(e);}if(d<f)Array.prototype.push.apply(l,k.slice(d));if(g.length<this._numTopFriends)Array.prototype.push.apply(g,l);}else g=k;g=g.slice(0,this._numTopFriends);if(ChatConfig.get('sidebar_online_friends')&&g.length===this._numTopFriends){var h=Object.from(g);var i=this._getAvailableList().filter(function(n){return !(n in h);}).length;i&&g.splice(-1);}g.sort(this._sort.bind(this));return g;},hide:function(){if(!this._isVisible)return;this._isVisible=false;CSS.hide(this._root);},_onClick:function(event){var e=event.getTarget();var b=Parent.byTag(e,'li');if(b){var a=DataStore.get(b,'id');if(a){var d='ordered_list';var c=b;while(b.previousSibling){b=b.previousSibling;if(CSS.hasClass(b,'separator')){d='more_online_friends';break;}}ChatUserInfoManager.get(a,function(f){Chat.openTab(a,f.name,'friend',d);});Chat.goOnline();}else if(CSS.hasClass(b,'separator')&&Parent.byClass(e,'inner'))this.scrollTo(b);return false;}},setNumTopFriends:function(a){if(a!==this._numTopFriends){this._numTopFriends=a;this.render();}},_sort:function(a,d){if(ChatConfig.get('blackbird')){var b=this._sortByAllowed(a,d);if(b!==0)return b;}var c=this._sortAlphabetical(a,d);if(c!==0)return c;return OrderedFriendsList.compare(a,d);},_sortByAllowed:function(a,d){var b=PresencePrivacy.allows(a);var c=PresencePrivacy.allows(d);if(b!==c)return b?-1:1;return 0;},_sortAlphabetical:function(a,b){var c=((ChatUserInfos[a]||{}).name||'~').toLowerCase();var d=((ChatUserInfos[b]||{}).name||'~').toLowerCase();if(c!==d)return c<d?-1:1;return 0;},_sortMobile:function(a,c){var b=AvailableList.get(a)===AvailableList.MOBILE;var d=AvailableList.get(c)===AvailableList.MOBILE;if(b^d)return d?-1:1;return this._sortAlphabetical(a,c);},render:function(){if(!this._inited||!this._isVisible||!OrderedFriendsList.isReady())return;clearTimeout(this._renderTimeout);var i=function(l){clearTimeout(this._renderTimeout);this._renderTimeout=this.render.bind(this).defer();}.bind(this);var j=this.getSortedList();var e=[];var c;var d;for(var b=0,g=j.length;b<g;b++){c=j[b];d=this._getListItem(c);if(d){e.push(d);}else this._renderListItem(c,i);}if(ChatConfig.get('sidebar_online_friends')){var a=this._getAvailableList();var k=Object.from(j);a=a.filter(function(l){return !(l in k);});a.sort(this._sortMobile.bind(this));if(a.length&&e.length)e.push(HTML('<li class="separator">'+'<div class="outer">'+'<div class="inner">'+'<span class="text">'+_tx("{MORE ONLINE FRIENDS} ({=count})",{'MORE ONLINE FRIENDS':_tx("MORE ONLINE FRIENDS"),'=count':a.length})+'</span>'+'<div class="dive"><span class="bar"></span></div>'+'</div>'+'</div>'+'</li>'));for(var f=0,h=a.length;f<h;f++){c=a[f];d=this._getListItem(c);if(d){e.push(d);}else this._renderListItem(c,i);}}if(e.length)DOM.setContent(this._root,e);},_renderListItem:function(b,a){ChatUserInfoManager.get(b,function(f){var c=this._template.render();ChatQuietLinks.silence(c);var e=XHPTemplate.getNode(c,'profile-photo');e.setAttribute('src',f.thumbSrc);var d=XHPTemplate.getNode(c,'name');DOM.setContent(d,f.name);DataStore.set(c,'id',b);this._items[b]=c;a&&a(c);}.bind(this));},show:function(){if(this._isVisible)return;this._isVisible=true;CSS.show(this._root);this.render();},update:function(){this.render();},setScrollContainer:function(a){if(DOM.contains(a,this._root))this._scrollContainer=a;},scrollTo:function(c){if(!this._scrollContainer)return;var e=this._scrollContainer.scrollHeight;var a=this._scrollContainer.clientHeight;var d=this._scrollContainer.scrollTop;var f=Math.min(c.offsetTop,e-a);if(d!==f){var b=Math.abs(f-d)/this._scrollContainer.clientHeight*500;animation(this._scrollContainer).to('scrollTop',f).ease(animation.ease.end).duration(b).go();}}});
function ChatSidebarDropdown(){}ChatSidebarDropdown.prototype={init:function(a){this._root=a;Selector.listen(a,'select',this._onSelect.bind(this));Selector.listen(a,'toggle',this._onToggle.bind(this));Arbiter.subscribe('chat/option-changed',this._onOptionChanged.bind(this));Arbiter.subscribe(['chat-options/initialized','chat/visibility-changed'],this._onVisibilityChanged.shield(this));},changeSetting:function(b,c){if(this._pendingChange)return false;this._pendingChange=true;var a={};a[b]=c;chatOptions.setSetting(b,c);new AsyncRequest(chatDisplay.settingsURL).setHandler(this._onChangeSettingResponse.bind(this,b,c)).setErrorHandler(this._onChangeSettingError.bind(this,b,c)).setFinallyHandler(this._onChangeFinally.bind(this)).setData(a).setAllowCrossPageTransition(true).send();},_conditionEnabled:function(c,a){var b=Selector.getOption(this._root,c);b&&Selector.setOptionEnabled(b,a);},_onChangeSettingResponse:function(a,c,b){presence.doSync();},_onChangeSettingError:function(a,c,b){chatOptions.setSetting(a,!c);},_onChangeFinally:function(){this._pendingChange=false;},_onOptionChanged:function(a,b){var c=b.name;var e=b.value;if(c==='sound'){var d=Selector.getOption(this._root,c);if(e!==Selector.isOptionSelected(d))Selector.setSelected(this._root,c,e);}},_onSelect:function(b){if(this._pendingChange)return false;var a=Selector.getOptionValue(b.option);switch(a){case 'popout':return this.popout();case 'sidebar':return this.toggleSidebar();}},_onToggle:function(a){if(this._pendingChange)return false;var b=Selector.getOptionValue(a.option);var c=Selector.isOptionSelected(a.option);switch(b){case 'visibility':chatOptions.toggleVisibility();break;case 'sound':this.changeSetting(b,c);break;}Selector.toggle(this._root);},_onVisibilityChanged:function(){var a=Chat.isOnline();var b=Selector.getOption(this._root,'visibility');if(a!==Selector.isOptionSelected(b))Selector.setSelected(this._root,'visibility',a);},_setRanking:function(a){data={sidebar_ranking:a};new AsyncRequest(chatDisplay.settingsURL).setData(data).send();},popout:function(){presence.popout();Selector.toggle(this._root);return false;},toggleSidebar:function(){Chat.toggleSidebar();Selector.toggle(this._root);return false;}};
function ChatTabSlider(){this.handleWidth=210;this.animationTime=210;this._init();}ChatTabSlider.prototype={_init:function(){this.org_s=0;this.numToShow=0;this.numShift=1;this.shiftByNumTabs=false;this.timer=null;this.skipAnimation=false;this.chatWidth=null;var a=$('fbDockChatTabSlider');this.chat=ge('fbDockChatTabsWrapper');this.chatTabBar=ge('fbDockChatTabs');this.nextTab=DOM.find(a,'div.next');Event.listen(this.nextTab,'click',this.next.bind(this));this.prevTab=DOM.find(a,'div.previous');Event.listen(this.prevTab,'click',this.prev.bind(this));this.nextCounter=DOM.find(this.nextTab,'span.numTabs');this.prevCounter=DOM.find(this.prevTab,'span.numTabs');this.numMissedNextCounter=DOM.find(this.nextTab,'span.numMessages');this.numMissedPrevCounter=DOM.find(this.prevTab,'span.numMessages');Toggler.createInstance(this.chatTabBar);this.numNext=0;this.numPrev=0;this.prevTabs={};this.nextTabs={};presence.registerStateLoader(this._load.bind(this));presence.registerStateStorer(this._store.bind(this));Event.listen(window,'resize',this._resize.bind(this));},load:function(){this._load(presence.state);this._resize();},_load:function(a){var b=0;if(a)b=(a.s?a.s:b);this._setPos(b);},_store:function(a){a.s=this._s;return a;},_calculate:function(){this._setMaxWidth();if(presence.poppedOut){this.numToShow=chatDisplay.numTabs;}else{this.numToShow=parseInt(this.maxWidth/this.handleWidth);this.numToShow=this.numToShow>0?this.numToShow:1;}if(this.shiftByNumTabs)this.numShift=this.numToShow;if(this._s!=null)this._setPos(this._s);},_setMaxWidth:function(){var b=document.body.clientWidth;var a=Parent.byClass(this.chat,'fbDock').firstChild;for(;a;a=a.nextSibling)b-=a.clientWidth;b+=this.chat.clientWidth;this.maxWidth=b-70;},_setPos:function(a){if(a<0)a=0;this._s=a;this._e=this._s+this.numToShow;},_doSync:function(){var a=(this.org_s!=this._s);this.org_s=0;if(a)presence.doSync();},_build:function(){if(presence.poppedOut)return;var a=(this.numToShow>=chatDisplay.numTabs)?true:false;this.setVisibleTabs(a);if(a){this.resetCounters();}else this.updateCounters();this.updateMissedCount();},_resize:function(){this.org_s=this._s;this._calculate();this._build();this._doSync();if(chatDisplay.lastFocused!=null)this.gotoTab(chatDisplay.lastFocused);},addTab:function(a){this._build();},gotoTab:function(a){if(!(a in chatDisplay.tabs))return;var b=chatDisplay.tabList.indexOf(chatDisplay.tabs[a]);if(!this._inRange(b)){var c=(b-this.numToShow)+1;this._setPos(c);this._build();}},close:function(){this._setPos(((this.numPrev>0||this.numNext>0)&&this._s>0)?this._s-1:0);this._calculate();this._build();},setVisibleTabs:function(a){var d=chatDisplay.tabList;for(var b=0,c=d.length;b<c;++b)if(this._inRange(b,d[b].id)||a){d[b].show();}else d[b].hide();},_inRange:function(c,b){var d,a=false;if(c>=this._s){d=true;delete this.prevTabs[b];}else this.prevTabs[b]=b;if(c<this._e){a=true;delete this.nextTabs[b];}else this.nextTabs[b]=b;return (d&&a);},updateMissedCount:function(){var c=0;var b=0;for(var a in this.prevTabs)c+=chatDisplay.tabs[a]?chatDisplay.tabs[a].numMissed:0;this.numMissedPrevCounter.innerHTML=c;CSS.conditionClass(this.numMissedPrevCounter,'hidden_elem',!c);for(var a in this.nextTabs)b+=chatDisplay.tabs[a]?chatDisplay.tabs[a].numMissed:0;this.numMissedNextCounter.innerHTML=b;CSS.conditionClass(this.numMissedNextCounter,'hidden_elem',!b);},updateCounters:function(){this.numNext=chatDisplay.numTabs-this._e;this.numPrev=this._s;if(this.numNext<=0){this.numNext=0;CSS.addClass(this.nextTab,'disabled');}else CSS.removeClass(this.nextTab,'disabled');if(this.numPrev<=0){this.numPrev=0;CSS.addClass(this.prevTab,'disabled');}else CSS.removeClass(this.prevTab,'disabled');if(this.numPrev>0||this.numNext>0){CSS.show(this.nextTab);CSS.show(this.prevTab);}else{CSS.hide(this.nextTab);CSS.hide(this.prevTab);}this.nextCounter.innerHTML=this.numNext;this.prevCounter.innerHTML=this.numPrev;},resetCounters:function(){this._setPos(0);this.updateCounters();},shift:function(a){this.org_s=this._s;chatDisplay.unfocusNoSync();this._shift.bind(this,a).defer();},_shift:function(a){this._setPos(this._s<0?0:this._s+a);this._slide(a);if(this.timer||this.skipAnimation){this._slideReset();this.skipAnimation=true;var b=setTimeout(function(){this.skipAnimation=false;}.bind(this),500);}else this.timer=setTimeout(function(){this._slideReset();}.bind(this),this.animationTime);},_slide:function(a){this._slideSetup(false);this.setVisibleTabs(true);this.slideInc=(a*(this.handleWidth));this.leftPos=-(a)*(this.numNext*(this.slideInc));this.chatTabBar.style.left=this.leftPos+'px';animation(this.chatTabBar).by('left',this.slideInc).duration(this.animationTime-10).go();},_slideSetup:function(a){this.chat.style.position=a?'':'relative';this.chat.style.overflow=a?'visible':'hidden';if(!this.chatWidth)this.chatWidth=this.chatTabBar.clientWidth;if(a)this.chatWidth=null;this.chat.style.width=a?'':this.chatWidth+'px';this.chatTabBar.style.width=a?'':chatDisplay.numTabs*this.handleWidth+'px';this.chatTabBar.style.position=a?'':'absolute';},_slideReset:function(){clearTimeout(this.timer);this.timer=null;this._slideSetup(true);this._build();var a=chatDisplay.lastFocused;if(a){var b=chatDisplay.tabList.indexOf(chatDisplay.tabs[a]);if(this._inRange(b)){chatDisplay.refocus();}else chatDisplay.lastFocused=null;}this._doSync();},next:function(){this.numNext&&this.shift(this.numShift);return false;},prev:function(){this.numPrev&&this.shift(-this.numShift);return false;}};
var VideoChatPlugin=function(){};Function.mixin(VideoChatPlugin,'Arbiter',{INSTALL_TYPES:{JAVA:0,MANUAL:1},isSupported:function(){var b=ua.windows()&&((ua.ie()>=7&&!ua.ie64())||ua.firefox()>=3.6||ua.chrome()>=5);var a=ua.osx()&&(ua.firefox()>=3.6||ua.chrome()>=5||ua.safari()>=500);return (b||a);},notifyFromApplet:function(b,a){Arbiter.inform(String(b),{args:String(a)});},isInstalled:function(){var a=false;if(VideoChatPlugin.isSupported())if(VideoChatPlugin.usesActiveX()){var c=null;try{c=new ActiveXObject('SkypeLimited.SkypeWebPlugin');a=!!c;}catch(b){}c=null;}else a=VideoChatPlugin._getInstalledVersion();return a;},usesActiveX:function(){return ua.ie()&&ua.windows()&&!ua.opera();},setLogger:function(a){VideoChatPlugin.log=a||bagofholding;},embed:function(a){Bootloader.loadComponents('VideoChatPluginCore',function(){VideoChatPlugin.embed(a);});},remove:bagofholding,_getInstalledVersion:function(){if(!navigator)return null;navigator.plugins.refresh(false);mimeHandler=navigator.mimeTypes['application/skypesdk-plugin'];return mimeHandler&&mimeHandler.enabledPlugin;}});
var VideoChatView={RINGTONE_PATH:'/sound/bling.mp3',WINDOW_NAME_COOKIE_KEY:'vcpwn',TARGET_ID_COOKIE_KEY:'vctid',inIncomingCall:false,inOutgoingCall:false,inManualInstall:false,tokens:[],init:function(){VideoChatView.subscribe(VideoEvents.CALL_INCOMING,VideoChatView._onIncomingCall);VideoChatView.subscribe(VideoEvents.START_CALL_UI,function(a,b){if(!VideoChatView.inOutgoingCall){VideoChatView.inOutgoingCall=true;if(VideoChatPlugin.isInstalled()){VideoChatView.onOutgoingCall(b.idTarget);}else VideoChatView._invokeCore('promptInstall',b.idTarget);}});if(VideoChatPlugin.isSupported())CSS.addClass(document.documentElement,'videoCallEnabled');onbeforeunloadRegister(function(){if((VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall)&&!VideoChatView.inManualInstall)return _tx("Leaving this page will end your call.");});onleaveRegister(function(){if(VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall){VideoEvents.inform(VideoEvents.CANCEL_CALL,{cause:'leave:page'});VideoChatView.inIncomingCall=false;VideoChatView.inOutgoingCall=false;}});VideoChatView._checkPriorState();},subscribe:function(b,a){VideoChatView.tokens.push(VideoEvents.subscribe(b,a));},onProfileButtonClick:function(a){VideoChatView._invokeCore('onProfileButtonClick',a);},unload:function(){while(VideoChatView.tokens.length)VideoEvents.unsubscribe(VideoChatView.tokens.pop());},mightReloadPostInstall:function(){return ua.windows();},_showDialog:function(b,a){new Dialog().setAllowCrossPageTransition(true).setTop(a?85:125).setFixed(true).setAsync(new AsyncRequest(b)).show();},_onIncomingCall:function(a,b){VideoChatView.inIncomingCall=true;VideoChatView._showDialog(URI('/ajax/chat/video/incoming_call.php').setQueryData({idTarget:b.idTarget,callId:b.callId}),true);},onOutgoingCall:function(a){VideoChatView.inOutgoingCall=true;VideoChatView._showDialog('/ajax/chat/video/outgoing_call.php?idTarget='+a);},_checkPriorState:function(){if(VideoChatView.mightReloadPostInstall()){var a=getCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);if(a){clearCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);var b=getCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(b){clearCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(VideoChatPlugin.isInstalled())VideoChatView.onOutgoingCall(b);}}}},_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatViewCore',function(){VideoChatView.initCore();VideoChatView[b].apply(VideoChatView,a);});}};
var VideoChat={init:function(){VideoEvents.subscribe(VideoEvents.START_CALL_UI,function(){return VideoChat.onStartCallUI();});VideoEvents.subscribe(VideoEvents.START_CALL,function(a,b){VideoChat._invokeCore('onStartCall',b.idTarget);});VideoChatView.init();Arbiter.inform('video-chat/initialized',this,Arbiter.BEHAVIOR_STATE);},handleMessage:function(b,a,c){VideoChat._invokeCore('handleMessage',b,a,c);},onStartCallUI:bagofholding,_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatCore',function(){VideoChat.initCore();VideoChat[b].apply(VideoChat,a);});}};