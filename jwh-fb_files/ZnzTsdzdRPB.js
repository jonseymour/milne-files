/*1313383348,169775557*/

if (window.CavalryLogger) { CavalryLogger.start_js(["lR53h"]); }

var Live={logAll:false,startup:function(){Live.startup=bagofholding;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('live'),Live.handleMessage.bind(Live));},lookupLiveNode:function(b,a){var c=DOM.scry(document.body,'.live_'+b+'_'+a);c.forEach(function(e){if(DataStore.get(e,'seqnum')===undefined){var d=JSON.parse(e.getAttribute('data-live'));DataStore.set(e,'seqnum',d.seq);}});return c;},handleMessage:function(d,a){var b=a.obj;var c=this._processMessage.bind(this).curry(b.fbid,b.assoc,b);c(false);onpagecacheRegister(c.curry(true));},_processMessage:function(b,a,c,d){var e=this.lookupLiveNode(b,a);if(!e)return false;e.forEach(function(k){var j={getRelativeTo:function(){return k;}};if(c.expseq){var h=DataStore.get(k,'seqnum');var f=DataStore.get(k,'message_buffer');if(f===undefined){f={};DataStore.set(k,'message_buffer',f);}var g={obj:c};f[c.expseq]=g;if(c.expseq!=h){Live.log('mismatch',c.fbid,c.expseq,h);return false;}while(true){h=DataStore.get(k,'seqnum');var i=f[h];if(i){Live._applyUpdates(i.obj.updates,j);Live.log('seqmatch',c.fbid,'exp',c.expseq,'cur',h);delete f[h];}else break;}}else Live._applyUpdates(c.updates,j);});},_applyUpdates:function(b,a){$A(b).each(function(c){new Function(c).apply(a);});},log:function(){if(Live.logAll){var a=$A(arguments).join(":");new AsyncSignal('/common/scribe_endpoint.php',{c:'live_sequence',m:a}).send();}}};
var LiveTimer={restart:function(a){this.serverTime=a;this.localStartTime=new Date().getTime()/1000;this.updateTimeStamps();},updateTimeStamps:function(){LiveTimer.timestamps=DOM.scry(document.body,'abbr.livetimestamp');LiveTimer.startLoop(20000);},addTimeStamps:function(a){if(!a||!LiveTimer.timestamps)return;var c=DOM.scry(a,'abbr.livetimestamp');for(var b=0;b<c.length;++b)LiveTimer.timestamps.push(c[b]);LiveTimer.startLoop(0);},startLoop:function(a){this.stop();this.timeout=setTimeout(function(){LiveTimer.loop();},a);},stop:function(){clearTimeout(this.timeout);},updateNode:function(a,b){LiveTimer.updateNode=(ua.ie()<7)?function(c,d){c.nextSibling.nodeValue=d;}:function(c,d){c.firstChild.nodeValue=d;};LiveTimer.updateNode(a,b);},loop:function(d){if(d)LiveTimer.updateTimeStamps();var c=Math.floor(new Date().getTime()/1000-LiveTimer.localStartTime);var a=-1;LiveTimer.timestamps&&LiveTimer.timestamps.each(function(g){var f=+new Date(g.getAttribute('data-date'))/1000;var e=LiveTimer.renderRelativeTime(LiveTimer.serverTime+c,f);if(e.text)LiveTimer.updateNode(g,e.text);if(e.next!=-1&&(e.next<a||a==-1))a=e.next;});if(a!=-1){var b=Math.max(20000,a*1000);LiveTimer.timeout=setTimeout(function(){LiveTimer.loop();},b);}},renderRelativeTime:function(c,d){var e={text:"",next:-1};if(c-d>(12*3600)||(new Date(c*1000).getDay()!=new Date(d*1000).getDay()))return e;var f=c-d,b=Math.floor(f/60),a=Math.floor(b/60);if(b<1){e.text=_tx("A few seconds ago");e.next=60-f%60;return e;}if(a<1){if(b==1){e.text=_tx("about a minute ago");}else e.text=_tx("{number} minutes ago",{number:b});e.next=60-f%60;return e;}if(a!=11)e.next=3600-f%3600;if(a==1){e.text=_tx("about an hour ago");return e;}e.text=_tx("{number} hours ago",{number:a});return e;}};
function ufi_add_ft_hidden_node(c){if(c.link_data)return;var a=collect_data_attrib(c,'ft');if(count(a)){var b=$N('input',{type:'hidden',name:'link_data',value:JSON.stringify(a)});c.appendChild(b);}}function ufi_add_all_link_data(){Bootloader.loadComponents('dom-collect',function(){DOM.scry(document.body,'form.commentable_item').forEach(ufi_add_ft_hidden_node);});}