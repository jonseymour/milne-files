/*1314585034,169775814*/

if (window.CavalryLogger) { CavalryLogger.start_js(["Un380"]); }

var ChatQuietLinks={silence:function(b){if(ua.firefox()>=4||ua.chrome())var a=Event.listen(document,'mousemove',function(){this._removeLinkHrefs(b);a.remove();}.bind(this));},_removeLinkHrefs:function(d){var c=DOM.scry(d,'a');for(var b=0;b<c.length;b++){var a=c[b].getAttribute('href');if(!a||a.charAt(0)=='#')c[b].removeAttribute('href');}}};
var OrderedFriendsList=window.OrderedFriendsList||(function(){var a=[];var b={};var c=false;return copy_properties(new Arbiter(),{init:function(d){this.init=bagofholding;a=d;a.forEach(function(f,e){b[f]=e;});c=true;this.inform('initialized',{},Arbiter.BEHAVIOR_PERSISTENT);},contains:function(d){return d in b;},compare:function(d,e){var h=OrderedFriendsList.getRank(d);var i=OrderedFriendsList.getRank(e);if(h!==i)return h-i;var f=((ChatUserInfos[d]||{}).name||'~').toLowerCase();var g=((ChatUserInfos[e]||{}).name||'~').toLowerCase();if(f!==g)return f<g?-1:1;return 0;},getList:function(){return $A(a);},getRank:function(d){return d in b?b[d]:a.length;},isReady:function(){return c;}});})();
define('ChatOnlineFriends',[],function(){var a=function(){};a.prototype={chatFriends:{},chatStatuses:['chatOnline','chatIdle','chatMobile','chatOffline'],_subscribe:function(event,b){this._tokens.push(Arbiter.subscribe(event,b));},clickHandler:function(event){var d=event.getTarget();var c=Parent.byClass(d,'uiListItem');if(c){var b=this.chatFriends[c.id];if(Chat.isOnline()){Chat.openTab(b.user_id,b.name,'friend','online_friends');}else goURI(b.uri);return false;}},onunload:function(){this._tokens.forEach(function(b){Arbiter.unsubscribe(b);});},_setStatus:function(b,c){if(CSS.hasClass(b,c))return;this.chatStatuses.forEach(function(d){CSS.conditionClass(b,d,d==c);});},initTypeahead:function(c,b){c.subscribe('reset',function(){CSS.show(b);});c.subscribe('query',function(d,e){if(e.value){CSS.hide(b);}else CSS.show(b);});},init:function(e,f,b,d,c){this._initShared(e,f,b,c);this._facepile=d.firstChild;this._faceFutures&&this._hideAllFaces();this._faceFutures=[];OrderedFriendsList.subscribe('initialized',function(){this._orderedFriends=OrderedFriendsList.getList();this._hashedFriends=Object.from(this._orderedFriends);this._subscribe(['available-list/initialized','buddylist/availability-changed','chat-options/initialized'],this.update.shield(this));}.bind(this));Event.listen(d,'click',this.clickHandlerClientRendering.bind(this));AvailableList.update();},_initShared:function(d,e,b,c){this.maxElements=d;this._faceTmpl=c;this._tokens=[];onleaveRegister(this.onunload.bind(this));this.initTypeahead(e,DOM.find(b,'div.fbFriendsOnlineFacepile'));},update:function(){var h=ge('chatFriendsOnline');if(h)CSS.conditionClass(h,'isOffline',!Chat.isOnline());if(!Chat.isOnline()||!AvailableList.isReady())return;AvailableList.getAvailableIDs().forEach(function(i){if(!this._hashedFriends[i]){this._orderedFriends.push(i);this._hashedFriends[i]=true;}}.bind(this));var c=0;for(var f=0;f<this._orderedFriends.length;f++){var e=this._orderedFriends[f];var b=AvailableList.get(e);var d=this._faceFutures[f];var g=c<this.maxElements;if(b&&g){if(!d){d=this._makeFace(f);this._faceFutures[f]=d;}c++;}this._updateFace(d,g,this._mapChatStatus(b));}},_mapChatStatus:function(b){switch(b){case AvailableList.OFFLINE:return 'chatOffline';case AvailableList.IDLE:return 'chatIdle';case AvailableList.ACTIVE:return 'chatOnline';case AvailableList.MOBILE:return 'chatMobile';}},_updateFace:function(c,d,b){c&&c(function(e){this._setStatus(e,b);CSS.conditionShow(e,d);}.bind(this));},_makeFace:function(d){var e=null;var b=null;var c=this._orderedFriends[d];ChatUserInfoManager.get(c,function(k){b=this._faceTmpl.render();DataStore.set(b,'friendID',c);var j=XHPTemplate.getNode(b,'img');var l=j.cloneNode(false);l.setAttribute('src',k.thumbSrc);DOM.replace(j,l);var f=XHPTemplate.getNode(b,'anchor');TooltipLink.setTooltipText(f,k.name);e&&e(b);var g=false;for(var i=d+1;i<this._orderedFriends.length&&!g;i++){var h=this._faceFutures[i];var m=h&&h();if(m){this._facepile.insertBefore(b,m);g=true;}}if(!g)this._facepile.appendChild(b);}.bind(this));return function faceFuture(f){if(f)if(b){f(b);}else e=f;return b;};},clickHandlerClientRendering:function(event){var d=event.getTarget();var b=Parent.byClass(d,'uiFacepileItem');if(b){var c=DataStore.get(b,'friendID');if(c&&Chat.isOnline()){ChatUserInfoManager.get(c,function(e){Chat.openTab(c,e.name,'friend','online_friends');});return false;}}},_hideAllFaces:function(){this._faceFutures.forEach(function(b){b&&b(function(c){DOM.remove(c);});});}};return a;});
var ChatSidebar=window.ChatSidebar||(function(){var b;var f=false;var g=false;var i;var h;var k;var n;var o;var a=32;function c(q,p){if(q==='presence/restart'){DOM.setContent(h,p.reason);CSS.addClass(k,'error');}else{CSS.removeClass(k,'error');DOM.empty(h);}j();}function d(){if(!Chat.isOnline()){var p=['<a href="#" onclick="Chat.goOnline(); return false;">',_tx("available"),'</a>'].join('');DOM.setContent(h,HTML(_tx("You are unavailable to chat. Let friends see you as {=available}?",{'=available':p})));CSS.addClass(k,'offline');}else{CSS.removeClass(k,'offline');DOM.empty(h);}j();}function e(){if(!ChatSidebar.isVisible())return;g=false;CSS.hide(k);CSS.removeClass(document.documentElement,'sidebarMode');i.hide();n.getCore().reset();Arbiter.inform('sidebar/hide',ChatSidebar);}function j(){var q=ChatSidebar.isViewportCapable();CSS.conditionClass(document.documentElement,'sidebarCapable',q);if(ChatSidebar.isEnabled())if(q){CSS.setStyle(k,'height',o.y+'px');l();var p=o.y;$A(k.childNodes).forEach(function(s){if(s!==b)p-=Vector2.getElementDimensions(s).y;});CSS.setStyle(b,'height',p+'px');var r=Math.floor((p-8)/a);i.setNumTopFriends(r);n.getData().setMaxResults(r);}else e();}function l(){if(ChatSidebar.isVisible())return;g=true;CSS.show(k);CSS.addClass(document.documentElement,'sidebarMode');i.show();Arbiter.inform('sidebar/show',ChatSidebar);}function m(){chatOptions.setSetting('sidebar_mode',ChatSidebar.isEnabled());new AsyncRequest('/ajax/chat/settings.php').setHandler(bagofholding).setErrorHandler(bagofholding).setData({sidebar_mode:ChatSidebar.isEnabled()}).setAllowCrossPageTransition(true).send();}return {init:function(q,p,r){ChatSidebar.init=bagofholding;k=q;i=p;n=r;b=DOM.find(q,'div.fbChatSidebarBody');h=DOM.find(q,'div.fbChatSidebarMessage div.message');p.setScrollContainer(DOM.find(b,'div.uiScrollableAreaBody'));ChatQuietLinks.silence(q);Event.listen(window,'resize',j);Arbiter.subscribe('chat/visibility-changed',d);r.subscribe(['respond','reset'],function(s,t){if(g)if(t&&t.value&&t.value===r.getCore().getValue()&&r.getView().isVisible()){i.hide();}else i.show();});r.getData().subscribe('beforeQuery',j);Arbiter.subscribe(['presence/restart','presence/shutdown'],c);Arbiter.subscribe('buddylist-nub/initialized',function(s,t){Event.listen(t.getButton(),'click',function(event){ChatSidebar.enable();return !ChatSidebar.isViewportCapable();});});Arbiter.subscribe('chat-options/initialized',function(s,t){f=!!t.getSetting('sidebar_mode');d();Arbiter.inform('sidebar/initialized',ChatSidebar,Arbiter.BEHAVIOR_PERSISTENT);});},disable:function(){if(!ChatSidebar.isEnabled())return;f=false;m();e();},enable:function(){if(ChatSidebar.isEnabled())return;f=true;m();j();!function(){if(ChatSidebar.isVisible())n.getCore().getElement().focus();}.defer();},getRoot:function(){return k;},isEnabled:function(){return f;},isViewportCapable:function(){o=Vector2.getViewportDimensions();return o.x>ChatConfig.get('sidebar.minimum_width');},isVisible:function(){return g;},resize:j,toggle:function(){ChatSidebar.isEnabled()?ChatSidebar.disable():ChatSidebar.enable();}};})();
add_properties('TypeaheadBehaviors',{chatTypeahead:function(c){var a=c.getElement();var b=c.getView().getElement();c.subscribe('focus',function(){c.getData().refreshData();});c.subscribe('blur',function(d){c.getCore().reset();});c.subscribe('respond',function(d,e){if(e.value&&e.value===c.getCore().getValue()){if(!e.results.length){var f=$N('div',{className:'noResults'},_tx("Friend not found."));DOM.setContent(b,f);}CSS.addClass(a,'hasValue');}});c.subscribe('reset',function(){CSS.removeClass(a,'hasValue');});c.subscribe('select',function(d,e){Chat.openTab(e.selected.uid,e.selected.text,e.selected.type,'typeahead');Chat.goOnline();});c.subscribe('highlight',function(d,f){if(f.index>=0){var i=c.getView().getItems()[f.index];if(i){var h=Rect(i);var e=i.offsetParent;var g=h.boundWithin(Rect(e)).getPositionVector();h.getPositionVector().sub(g).scrollElementBy(e);}}});}});
function ChatTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(ChatTypeaheadCore,'TypeaheadCore');ChatTypeaheadCore.prototype={handleTab:bagofholding,keydown:function(event){var a=Event.getKeyCode(event);if(a===KEYS.ESC){this.reset.shield(this).defer();return event.kill();}return this.parent.keydown(event);}};
function ChatTypeaheadDataSource(a){this.parent.construct(this,a);this.persistOnRefresh=a.persistOnRefresh!==false;this.showOfflineUsers=!!a.showOfflineUsers;}Class.extend(ChatTypeaheadDataSource,'DataSource');ChatTypeaheadDataSource.prototype={init:function(){OrderedFriendsList.subscribe('initialized',function(){this.parent.init();var a=Arbiter.subscribe(['available-list/initialized','buddylist/availability-changed'],this._update.shield(this));if(!this.persistOnRefresh)onleaveRegister(function(){Arbiter.unsubscribe(a);});}.bind(this));},bootstrap:function(){this.parent.bootstrap();if(this.showOfflineUsers)if(ChatUserInfoManager.hasAll()){this._update();}else{ChatUserInfoManager.fetchAll();this.inform('activity',{activity:true});var a=ChatUserInfoManager.subscribe('updated',function(){this.inform('activity',{activity:false});this._update();}.bind(this));if(!this.persistOnRefresh)onleaveRegister(function(){ChatUserInfoManager.unsubscribe(a);});}},_update:function(){var c=this.value;this.dirty();var b=keys(ChatUserInfos).filter(function(d){return ChatUserInfos[d].type==='friend';});b.sort(OrderedFriendsList.compare);var a=[];b.forEach(function(e){if(e==Env.user)return;var d=AvailableList.get(e);if(!this.showOfflineUsers&&d===AvailableList.OFFLINE)return;var f=ChatUserInfos[e];a.push({uid:e,text:f.name,tokens:f.additionalName,localized_text:f.name,additional_text:f.additionalName,photo:f.thumbSrc,availability:d,type:f.type});}.bind(this));if(a.length)this.addEntries(a);this.value=c;c&&this.respond(c,this.buildUids(c),true);},refreshData:function(){AvailableList.update();}};
add_properties('TypeaheadRenderers',{chat:function(b,d){var f=htmlize(b.text),e=b.photo,c=[];if(e)c=['<img src="',e,'" alt="" />'];var a='offline';switch(b.availability){case AvailableList.ACTIVE:a='active';break;case AvailableList.IDLE:a='idle';break;case AvailableList.MOBILE:a='mobile';break;}if(PresencePrivacy.get(b.uid)==PresencePrivacy.BLACKLISTED)a='invis';return ['<li class="clearfix ',a,'">',c.join(''),'<span class="text">'+f+'</span>','<i class="'+a+'">','</i>','</li>'];}});