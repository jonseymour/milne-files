/*1314826884,176832698*/

if (window.CavalryLogger) { CavalryLogger.start_js(["LJuhz"]); }

var NotificationCounter=(function(){var a={messages:0,notifications:0,requests:0};return {init:function(b){Arbiter.subscribe('update_title',this._handleUpdate.bind(this));Arbiter.subscribe('jewel/count-updated',this._handleCountUpdate.bind(this));this.counterInFront=b;},getCount:function(){var c=0;for(var d in a){var b=Number(a[d]);if(typeof a[d]=='string'&&isNaN(b))return a[d];if(isNaN(b)||b<0){new JSLogger('jewels').error('bad_count',{jewel:d,count:a[d]});continue;}c+=b;}return c;},updateTitle:function(){var b=DocumentTitle.get();var c=this.getCount();if(c)if(this.counterInFront){b='('+c+') '+b;}else b=b+' ('+c+')';DocumentTitle.set(b,true);},_handleCountUpdate:function(c,b){a[b.jewel]=b.count;this.updateTitle();},_handleUpdate:function(c,b){this.updateTitle();}};})();
function RenderManager(a){copy_properties(this,{_isDirty:false,_obj:a});}copy_properties(RenderManager.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;bind(this,this.doPaint).defer();}},doPaint:function(){this._isDirty=false;this._obj.paint();}});
function CounterDisplay(a,g,h,e,d,b){copy_properties(this,{_name:a,_valueNode:$(g),_wrapperNode:$(h)||null,_statusClass:d,_rm:new RenderManager(this),_arbiterSubscription:null,_count:0});var c=this._valueNode.firstChild;if(c){var f=parseInt(c.nodeValue,10);if(!isNaN(f))this._count=f;}this._statusNode=e?$(e):null;this._subscribeAll();CounterDisplay.instances.push(this);if(!b)onleaveRegister(this._destroy.bind(this),true);}copy_properties(CounterDisplay,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'/'+a,b);},setCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'/'+a,b);}});Class.mixin(CounterDisplay,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){Arbiter.unsubscribe(this._arbiterSubscription);delete this._arbiterSubscription;}CounterDisplay.instances.remove(this);},adjustCount:function(a){this._count=Math.max(0,this._count+a);this._rm.dirty();return this;},setCount:function(a){this._count=Math.max(0,a);this._rm.dirty();return this;},paint:function(){DOM.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)CSS.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)CSS.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var a=[CounterDisplay.EVENT_TYPE_ADJUST+'/'+this._name,CounterDisplay.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=Arbiter.subscribe(a,this._onInform.bind(this),Arbiter.SUBSCRIBE_NEW);},_onInform:function(a,b){b=parseInt(b);if(isNaN(b))return;if(a.indexOf(CounterDisplay.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(b);}else if(a.indexOf(CounterDisplay.EVENT_TYPE_UPDATE)!=-1){this.setCount(b);}else return;return;}});
function MenubarMessageController(b,a){}copy_properties(MenubarMessageController,{ensureInitialized:function(c,b,a){if(MenubarMessageController.initialized||!ge(b))return false;var d=new MenubarMessageController(c,b);MenubarMessageController.instance=d;d.ensureInitialized(c,b,a);MenubarMessageController.initialized=true;}});copy_properties(MenubarMessageController.prototype,{ensureInitialized:function(d,c,a,b){this.menu=ge(c);var e=[CounterDisplay.EVENT_TYPE_ADJUST+'/messages_unread',CounterDisplay.EVENT_TYPE_UPDATE+'/messages_unread'];Arbiter.subscribe(e,this.onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('messages_seen'),function(){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0},Arbiter.BEHAVIOR_STATE);});this._dirty=a;if(b)this.mouseOverListener=Event.listen($(d),'mouseover',this.doRefetch.bind(this));},doRefetch:function(){if(this._dirty){this._dirty=false;this._fetch();}},_fetch:function(){new AsyncRequest().setURI('/ajax/gigaboxx/endpoint/ListThreads.php').setMethod('GET').setReadOnly(true).setHandler(this.onFetchComplete.bind(this)).setData({folder:'[fb]messages',start:0,limit:5,previews:true}).send();},onFetchComplete:function(a){if(this.menu)DOM.setContent(this.menu,HTML(a.payload));},onCounterUpdate:function(){this._dirty=true;},markSeen:function(a){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:a}).send();}});
function JewelX(){}(function(){var b={};function a(){a=bagofholding;Arbiter.subscribe('jewel/count-updated',function(d,e){var f=b[e.jewel];f&&f.update(e);});Arbiter.subscribe('jewel/count-initial',function(d,e){var f=b[e.jewel];f&&f.setInitial(e.count);});Arbiter.subscribe('jewel/reset',function(d,e){var f=b[e.jewel];f&&f.reset();});var c=null;Event.listen(window,'resize',function(event){clearTimeout(c);c=Arbiter.inform.bind(Arbiter,'jewel/resize',event).defer(100,false);});}Class.mixin(JewelX,'Arbiter',{init:function(c,d){b[c]=this;this.name=c;this.root=d;this.countNew=0;this.initialCount=0;Toggler.listen(['show','hide'],this.root,function(f){var e=f==='show';e&&this._logFirstClick();this.hasNew()&&this.markSeen();this.reset();this.inform(e?'opened':'closed');Arbiter.inform(e?'JewelOpened':'JewelClosed');}.bind(this));a();},getRoot:function(){return this.root;},hasNew:function(){return CSS.hasClass(this.root,'hasNew');},isOpen:function(){return CSS.hasClass(this.root,'openToggler');},reset:function(){CSS.removeClass(this.root,'hasNew');},setContent:function(d){var c=DOM.find(this.root,'ul.jewelItemList');DOM.setContent(c,HTML(d));},update:function(d){this.countNew=d.count;var c=DOM.find(this.root,'span.jewelCount span');DOM.setContent(c,this.countNew);var e=isNaN(this.countNew)||this.countNew>0;CSS.conditionClass(this.root,'hasNew',e);this.inform('updated',d);},setInitial:function(c){this.initialCount=c;},markSeen:function(){Arbiter.inform('jewel/count-updated',{jewel:this.name,count:0},Arbiter.BEHAVIOR_STATE);this.inform('marked-seen');},_logFirstClick:function(){this._logFirstClick=bagofholding;user_action.bind(null,this.root,'click',null,'FORCE',{gt:{count:this.countNew,initial:this.initialCount,jewel:this.name}}).defer(100);}});})();
function MessagesJewel(){}MessagesJewel.prototype={init:function(c,b){this.jewel=c;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbMessagesFlyout');this.newCountSpan=ge('newMessageCount');this.folder=b;var a=ge('messagesMarkReadButton');if(a)Event.listen(a,'click',this._markRead.shield(this,true));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/messages/fetched',this._overflowHandler.bind(this));},_markRead:function(a,b){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0});},_markSeenCallback:function(a,b){MenubarMessageController.instance.markSeen(this.folder);},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showMessages',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?_tx("{num} NEW MESSAGE",{num:this.countNew}):_tx("{num} NEW MESSAGES",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}if(this.countNew>0)MenubarMessageController.instance.doRefetch();},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbMessagesItemList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));}};
function RequestsJewel(){}RequestsJewel.prototype={init:function(d,c,b){this.countNew=0;this.jewel=d;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbRequestsFlyout');this.newCountSpan=ge('newRequestCount');this.folder=c;this.doNewMarkRead=b;this._requestList={};this._requestCount=0;var a=ge('requestsMarkReadButton');if(a)Event.listen(a,'click',this._markRead.shield(this));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('closed',this._clearNewItems.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));window.Unibeeper&&Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/handled'),this._removeRequest.bind(this));LinkController.registerHandler(this._handleLink.bind(this),ElementController.ALL);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/add'),this._addRequest.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/remove_old'),this._removeOldRequest.bind(this));return this;},fromDom:function(){DOM.scry(this.jewelFlyout,'.jewelItemList li.objectListItem').each(function(c){var b=c.getAttribute('id');var a=b&&parseInt(this._parseID(b).requester,10);if(a&&!isNaN(a)){this._requestList[a]=b;++this._requestCount;}}.bind(this));this._conditionShowEmptyMessage();},_parseID:function(a){var b=a.match(/^(\d+)_(\d+)/);return (b)?{requester:b[1],type:b[2]}:undefined;},_handleLink:function(b,event){var c=Parent.byClass(b,'jewelItemNew');if(c&&Parent.byClass(c,'fbRequestList')&&Parent.byClass(c,'beeperEnabled')){var a=this._parseID(c.id);a&&this._markSeenCallback(a.requester,a.type);Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});CSS.removeClass(c,'jewelItemNew');}return true;},_addRequest:function(a,b){if(!b||this._requestList[b.obj.from])return;var c=DOM.find(this.jewelFlyout,'.jewelItemList');elem=DOM.prependContent(c,b.obj.markup)[0];CSS.hide(DOM.find(c,'img.loadingIndicator'));var d={jewel:'requests',count:++this.countNew};Arbiter.inform('jewel/count-updated',d);this._requestList[b.obj.from]=elem.id;++this._requestCount;this._conditionShowEmptyMessage();},_removeOldRequest:function(a,b){if(!b)return;var d=this._requestList[b.obj.from];var c=d&&ge(d);if(c){CSS.hasClass(c,'jewelItemNew')&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});if(!CSS.hasClass(c,'jewelItemResponded')){DOM.remove(c);delete this._requestList[d];--this._requestCount;this._conditionShowEmptyMessage();}}},_markRead:function(){this.jewel.markSeen();this._clearNewItems();},_markSeenCallback:function(b,c){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:this.folder}).send();var a=typeof b!='undefined'&&typeof c!='undefined'?{requester:b,type:c}:{};this.doNewMarkRead&&new AsyncSignal('/ajax/requests/mark_read/',a).send();},_removeRequest:function(a,b){var c=b.obj.item_id;if(c){var d=ge(c);var e=d&&CSS.hasClass(d,'jewelItemNew');d?DOM.remove(d):false;e&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});}},_clearNewItems:function(a,b){DOM.scry(this.jewel.root,'li.jewelItemNew').each(function(c){CSS.removeClass(c,'jewelItemNew');});},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showRequests',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?_tx("{num} NEW REQUEST",{num:this.countNew}):_tx("{num} NEW REQUESTS",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_conditionShowEmptyMessage:function(){DOM.scry(this.jewelFlyout,'li.empty').each(function(a){CSS.conditionShow(a,this._requestCount<=0);}.bind(this));},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbRequestsList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));}};
_PERSISTENT_BACKENDS={localstorage:LocalStorage};function LocalStorage(){this._store=window.localStorage;}LocalStorage.available=function(){return window.localStorage?true:false;};copy_properties(LocalStorage.prototype,{keys:function(){var b=[];for(var a=0;a<this._store.length;a++)b.push(this._store.key(a));return b;},get:function(a){return this._store.getItem(a);},set:function(a,b){this._store.setItem(a,b);},remove:function(a){this._store.removeItem(a);},clear:function(){this._store.clear();}});function CacheStorage(d,b){this._key_prefix=b||'_cs_';this._magic_prefix='_@_';if(d=='AUTO')for(var c in _PERSISTENT_BACKENDS){var a=_PERSISTENT_BACKENDS[c];if(a.available()){d=c;break;}}if(d)if(!_PERSISTENT_BACKENDS[d]){this._backend=null;}else this._backend=new _PERSISTENT_BACKENDS[d]();this._memcache={};}copy_properties(CacheStorage.prototype,{keys:function(){var d=[];if(this._backend){var a=this._backend.keys();for(var b=0;b<a.length;b++)if(a[b].substr(0,this._key_prefix.length)==this._key_prefix)d.push(a[b].substr(this._key_prefix.length));return d;}for(var c in this._memcache)d.push(c);return d;},set:function(b,a){this._memcache[b]=a;if(this._backend){if(typeof a=='string'){a=this._magic_prefix+a;}else a=JSON.stringify(a);this._backend.set(this._key_prefix+b,a);}},get:function(b,c){if(this._memcache[b]!==undefined)return this._memcache[b];var d=undefined;if(this._backend){var d=this._backend.get(this._key_prefix+b);if(d!==null){if(d.substr(0,this._magic_prefix.length)==this._magic_prefix){d=d.substr(this._magic_prefix.length);}else d=JSON.parse(d);this._memcache[b]=d;}else d=undefined;}if(d===undefined&&c!==undefined){d=c;this._memcache[b]=d;if(this._backend){if(typeof d=='string'){var a=this._magic_prefix+d;}else var a=JSON.stringify(d);this._backend.set(this._key_prefix+b,a);}}return d;},remove:function(a){delete this._memcache[a];if(this._backend)this._backend.remove(this._key_prefix+a);}});
function PageCache(a,b){if(this===window)return new PageCache(a,b);this._MAX_PAGE_NUM=typeof a=='undefined'?5:a;this._MAX_TTL=typeof b=='undefined'?600000:b;this._storage=new CacheStorage();}copy_properties(PageCache.prototype,{_normalizeURI:function(a){a=new URI(a);if(a.getPath()=='/')a.setPath('/home.php');return a.getUnqualifiedURI().setFragment('').removeQueryData('ref').toString();},addPage:function(c,b){c=this._normalizeURI(c);var a=this._storage.get(c,{});a.normalized_uri=new URI(c);copy_properties(a,b);a.accessTime=a.genTime=(new Date()).getTime();this._clearCache();},updatePage:function(c,a){c=this._normalizeURI(c);var b=this._storage.get(c);if(typeof b==='undefined')return;copy_properties(b,a);this._storage.set(c,b);},isPageInCache:function(b){var a=this._storage.get(this._normalizeURI(b));return (typeof a!=='undefined');},invalidatePage:function(a){a=this._normalizeURI(a);this._storage.remove(a);},getPage:function(b){this._clearCache();b=this._normalizeURI(b);var a=this._storage.get(b);if(typeof a==='undefined')return null;a.accessTime=(new Date()).getTime();return a;},getPageUris:function(){return this._storage.keys();},_clearCache:function(){var b=(new Date()).getTime();var d=null;var f=0;var a=this._storage.keys();for(var c=0;c<a.length;c++){var h=a[c];var e=this._storage.get(h);var g=e.ttl||this._MAX_TTL;if(e.genTime<b-g){this._storage.remove(h);continue;}if(!d||this._storage.get(d).accessTime>e.accessTime)d=h;f++;}if(f>this._MAX_PAGE_NUM&&d)this._storage.remove(d);}});
var Quickling=window.Quickling||{isActive:function(){return Quickling._is_active||false;},isFeatureEnabled:function(a){return Quickling._capabilities&&Quickling._capabilities[a];},init:function(c,b,a){if(Quickling._is_initialized)return;copy_properties(Quickling,{_is_initialized:true,_is_active:true,_session_length:b,_capabilities:a,_is_in_transition:false,_title_interval:false,_ie_cache_title:'',_cache_hit:false,_version:c});Quickling._instrumentTimeoutFunc('setInterval');Quickling._instrumentTimeoutFunc('setTimeout');PageTransitions.registerHandler(Quickling._transitionHandler,1);if(Quickling.isFeatureEnabled('page_cache')){Quickling._cache=new PageCache();Arbiter.subscribe("pre_page_transition",Quickling._onPrePageTransition);Arbiter.subscribe(Arbiter.NEW_NOTIFICATIONS,Quickling._onNotifications);Arbiter.subscribe(AsyncRequest.REPLAYABLE_AJAX,Quickling._onReplayableAjax);Arbiter.subscribe(Arbiter.PAGECACHE_INVALIDATE,Quickling._onCacheInvalidates);}},_onPrePageTransition:function(b,a){if(Quickling.isFeatureEnabled('page_cache')&&(page=Quickling._cache.getPage(a.from))&&!page.incremental_updates){invoke_callbacks(page.onpagecache);page.refresh_pagelets.forEach(function(c){var d=Quickling._getPageletById(c);d&&d.refresh(true);});page.incremental_updates=AsyncRequest.stashBundledRequest();}},_onNotifications:function(b,a){Quickling._cache=new PageCache();},_onCacheInvalidates:function(c,b){if(Quickling.isFeatureEnabled('page_cache')&&b&&b.length)for(var a=0;a<b.length;a++){if(parseInt(b[a],10)!==0)continue;if(Quickling._cache.isPageInCache(PageTransitions.getMostRecentURI()))break;Quickling._cache=new PageCache();return;}},registerPageCacheHook:function(a,c){if(!Quickling._is_initialized||!Quickling._is_active||Quickling._is_in_transition||!Quickling.isFeatureEnabled('page_cache'))return;var b=PageTransitions.getMostRecentURI();var e=Quickling._cache.getPage(b);if(e){if(c)for(var d=0;d<e.replays.length;d++)if(e.replays[d][0]==c){e.replays.splice(d,1);d--;}e.replays.push([c,a]);}},_onReplayableAjax:function(c,b){if((PageTransitions.getNextURI().toString()!=PageTransitions.getMostRecentURI().toString()))return;if(Quickling._is_in_transition)return;var a=Quickling._whitelist_regex;if(!a)a=Quickling._whitelist_regex=new RegExp(env_get('pagecache_whitelist_regex'));if(a.test(URI(b.getURI()).getPath()))return;Quickling.registerPageCacheHook(bind(b,b.replayResponses),b._replayKey);},_startQuicklingTransition:function(){Quickling._is_in_transition=true;},_stopQuicklingTransition:function(){(function(){Quickling._is_in_transition=false;}).defer();},isCacheHit:function(){return Quickling._cache_hit;},goHashOrGoHere:function(d){var c=URI.getRequestURI();var b=c.getFragment();if(b.startsWith('/')){var a=b;}else var a=d;setTimeout(function(){PageTransitions.go(a,true);},0);},isPageActive:function(e){if(e=='#')return false;e=new URI(e);if(e.getDomain()&&e.getDomain()!=URI().getDomain())return false;var b=Quickling.isPageActive.regex;if(!b)b=Quickling.isPageActive.regex=new RegExp(env_get('quickling_inactive_page_regex'));if(e.getPath()=='/l.php'){var c=e.getQueryData().u;if(c){c=URI(unescape(c)).getDomain();if(c&&c!=URI().getDomain())return false;}}var d=e.getPath();var a=e.getQueryData();if(!is_empty(a))d+='?'+URI.implodeQuery(a);if(b.test(d))return false;return true;},_getPageletById:function(a){return window.__UIControllerRegistry&&window.__UIControllerRegistry[a];},_setHTML:function(a,b){if(ua.ie()<=6){a.innerHTML=b;}else DOM.setContent(a,HTML(b).setDeferred(true));},_transitionHandler:function(h){AjaxPipeRequest.setCurrentRequest(null);if(Quickling._isTimeToRefresh())return false;if(!Quickling.isPageActive(h))return false;window.ExitTime=(new Date()).getTime();removeHook('onafterloadhooks');removeHook('onloadhooks');_runHooks('onleavehooks');Arbiter.inform('onload/exit',true);Quickling._startQuicklingTransition();$('content').style.visibility="visible";var e;if(Quickling.isFeatureEnabled('page_cache')&&(e=Quickling._cache.getPage(h))){var d=null;var f=window.ExitTime;var g=null;var a=new Arbiter();a.registerCallback(function(){if(AjaxPipeRequest.getCurrentRequest()!==d)return;if(d)if(d.cavalry){var i=null;if(g)i=g-f;d.cavalry.setTimeStamp('t_domcontent',null,null,i);d.cavalry.setTimeStamp('t_hooks',null,null,i);d.cavalry.setTimeStamp('t_layout',null,null,i);d.cavalry.setTimeStamp('t_onload',null,null,i);}Quickling._cache_hit=true;invoke_callbacks(e.onafterload);invoke_callbacks(e.onafterpagecache);Quickling._cache_hit=false;Quickling._stopQuicklingTransition();},['pagecache_update','tti_pagecache']);d=AsyncRequest.setBundledRequestProperties({stashedRequests:e.incremental_updates,callback:function(){if(d&&d.cavalry)d.cavalry&&d.cavalry.setTimeStamp('t_html');a.inform('pagecache_update',true,Arbiter.BEHAVIOR_EVENT);},onInitialResponse:function(j){var i=j.getPayload();if(i.redirect&&i.force){return false;}else return true;},extra_data:{uri:e.normalized_uri.getQualifiedURI().toString(),version:Quickling._version},start_immediately:true});var c=$('content');c.style.visibility="hidden";AjaxPipeRequest.setCurrentRequest(d);AjaxPipeRequest.clearCanvas('content',false);Bootloader.loadResources(e.css.concat(e.js),null,true);Quickling._changePageTitle(e.title);Quickling._replaceSyndicationLinks(e.syndication_links||[]);var b=e.body_class||'';CSS.setClass(document.body,b);e.html=e.html.replace(/<span class=["']?muffin_tracking_pixel_start['"]?><\/span>.*?<span class=["']?muffin_tracking_pixel_end['"]?><\/span>/ig,'');Quickling._setHTML(c,e.html);if(c&&c.style.height=='1234px')c.style.height='';PageTransitions.transitionComplete(true);Quickling._cache_hit=true;invoke_callbacks(e.jscc);invoke_callbacks(e.onload);Quickling._cache_hit=false;e.replays.forEach(function(i){i[1]();});e.refresh_pagelets.forEach(function(i){var j=document.getElementById(i);if(j)j.innerHTML='';});setTimeout(function(){PageTransitions.restoreScrollPosition();$('content').style.visibility="visible";g=(+new Date());a.inform('tti_pagecache',true,Arbiter.BEHAVIOR_EVENT);},20);}else new QuickPipeRequest(h).setCanvasId('content').send();return true;},_changePageTitle:function(a){a=a||'Facebook';DocumentTitle.set(a);if(ua.ie()){Quickling._ie_cache_title=a;if(!Quickling._title_interval)Quickling._title_interval=window.setInterval(function(){var b=Quickling._ie_cache_title;var c=DocumentTitle.get();if(b!=c)DocumentTitle.set(b);},5000,false);}},_replaceSyndicationLinks:function(d){var c=document.getElementsByTagName('link');for(var b=0;b<c.length;++b){if(c[b].rel!='alternate')continue;DOM.remove(c[b]);}if(d.length){var a=DOM.find(document,'head');a&&DOM.appendContent(a,HTML(d[0]));}},cacheResponse:function(g,a,c,f){var e=g.payload;c=c?c:PageTransitions.getNextURI();Quickling._cache.addPage(c,{title:e.title,syndication:e.syndication||[],body_class:e.body_class,html:$("content").innerHTML,js:e.js||[],css:e.css||[],jscc:e.jscc?[e.jscc]:[],onload:e.onload||[],onafterload:e.onafterload||[],refresh_pagelets:e.refresh_pagelets||[],onpagecache:e.onpagecache||[],onafterpagecache:e.onafterpagecache||[],ttl:e.page_cache_ttl,replays:[]});if(f){var d=f.getAllCachedPagelets();for(var b in d)Quickling.cacheAndExecResponse(d[b],c,true);}if(a){invoke_callbacks(e.onload);onafterloadRegister(function(){invoke_callbacks(e.onafterload);});}},cacheAndExecResponse:function(c,b,d){var a=Quickling._cache.getPage(b);if(a){if(c.html)a.html=c.html;c.jscc&&a.jscc.push(c.jscc);a.js=a.js.concat(c.js||[]);a.css=a.css.concat(c.css||[]);a.onload=a.onload.concat(c.onload||[]);a.onafterload=a.onafterload.concat(c.onafterload||[]);a.onpagecache=a.onpagecache.concat(c.onpagecache||[]);a.onafterpagecache=a.onafterpagecache.concat(c.onafterpagecache||[]);a.refresh_pagelets=a.refresh_pagelets.concat(c.refresh_pagelets||[]);}if(!d){invoke_callbacks(c.onload);onafterloadRegister(function(){invoke_callbacks(c.onafterload);});}},_isTimeToRefresh:function(){Quickling._load_count=(Quickling._load_count||0)+1;return Quickling._load_count>=Quickling._session_length;},_instrumentTimeoutFunc:function(a){window[a+'_native']=(function(c){var b=function b(e,d){return c(e,d);};return b;})(window[a]);window[a]=function _setTimeout(d,c,b){var e=window[a+'_native'](d,c);if(c>0)if(b!==false)onleaveRegister(function(){clearInterval(e);});return e;};}};function QuickPipeRequest(b){var a={version:Quickling._version};this.parent.construct(this,b,{quickling:a});}Class.extend(QuickPipeRequest,'AjaxPipeRequest');copy_properties(QuickPipeRequest.prototype,{_preBootloadFirstResponse:function(b){var a=b.getPayload();if(Quickling.isFeatureEnabled('page_cache')&&a.page_cache_ttl)this._onPageDisplayed=bind(null,Quickling.cacheResponse,b,false,PageTransitions.getNextURI());DOMScroll.scrollTo(new Vector2(0,0,'document'),false);return true;},_fireDomContentCallback:function(){this._request.cavalry&&this._request.cavalry.setTimeStamp('t_domcontent');Quickling._stopQuicklingTransition();PageTransitions.transitionComplete();this._onPageDisplayed&&this._onPageDisplayed(this.pipe);this.parent._fireDomContentCallback();},_fireOnloadCallback:function(){if(this._request.cavalry){this._request.cavalry.setTimeStamp('t_hooks');this._request.cavalry.setTimeStamp('t_layout');this._request.cavalry.setTimeStamp('t_onload');}this.parent._fireOnloadCallback();},_redirect:function(a){if(a.redirect){if(a.force||!Quickling.isPageActive(a.redirect)){go_or_replace(window.location,URI(a.redirect).removeQueryData(['quickling','ajaxpipe']),true);}else PageTransitions.go(a.redirect,true);return true;}else return false;},_versionCheck:function(a){if(a.version!=Quickling._version){go_or_replace(window.location,URI(a.uri).removeQueryData(['quickling','ajaxpipe']),true);return false;}else return true;},_processFirstResponse:function(c){var b=c.getPayload();Quickling._changePageTitle(b.title);Quickling._replaceSyndicationLinks(b.syndication||[]);var a=b.body_class||'';CSS.setClass(document.body,a);if(b.hasOnbeforeshow)$('content').style.visibility='hidden';}});function onpagecacheRegister(a,b){b=(b===undefined?'':String(b));Quickling.registerPageCacheHook(a,b);}
var MessagingEvents=window.MessagingEvents||(function(){onloadRegister(function(){var b={};MessagingEvents.subscribe('mark-as-read',function(c,d){(d.tids||d.chat_ids||[]).forEach(function(f){f=''+f;if(!(f in b)){b[f]=true;var g=function(){MessagingEvents.unsubscribe(h);clearTimeout(e);delete b[f];};var h=MessagingEvents.subscribe('read',function(i,j){if((j.tids||[]).contains(f)||(j.chat_ids||[]).contains(f))g();});var e=g.defer(60000);}});});var a=function(c){if(!is_empty(b))return;for(var d in c)MessagingEvents.inform('count/'+d,c[d]);};Arbiter.subscribe('presence/message:messaging',function(c,e){var f=copy_properties(e.obj);var event=f.event||'';delete f.type;delete f.event;MessagingEvents.inform(event,f);if('unread_counts' in f){var d=f.unread_counts;a({unread:d.inbox,other_unseen:d.other});}});Arbiter.subscribe('presence/message:inbox',function(c,d){var e=copy_properties(d.obj);delete e.type;a(e);});});return new Arbiter();})();
var MessagingConst={APP_ID:313785040330,XD_MESSAGE:{SANDBOX_READY:'sandbox_ready',SET_CONTENT:'set_content',HTML_SIZE:'html_size',REFRESH_SIZE:'refresh_size'},SHINGLE_SCROLL_TRIGGER:5,EVENTS:{MESSAGE_SENT:'messaging/message_sent'}};
function MessagingJewelMenubarController(b,a){this.parent.construct(this);this._content=ge(a);this._open=false;Arbiter.subscribe([MessagingConst.EVENTS.MESSAGE_SENT,'chat/message-sent'],this._onSend.bind(this));Toggler.listen(['show','hide'],$(b),this._onToggle.bind(this));this._init();}Class.extend(MessagingJewelMenubarController,'MenubarMessageController');copy_properties(MessagingJewelMenubarController,{ensureInitialized:function(d,c,a,b){if(MessagingJewelMenubarController.initialized||!ge(c))return false;var e=new MessagingJewelMenubarController(d,c);MessagingJewelMenubarController.instance=e;MenubarMessageController.instance=e;e.ensureInitialized(d,c,a,b);MessagingJewelMenubarController.initialized=true;}});copy_properties(MessagingJewelMenubarController.prototype,{_init:function(){this.initializeEvents();},initializeEvents:function(){var a=null;Event.listen(this._content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&a!=b)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});},_fetch:function(){new AsyncRequest().setURI('/ajax/messaging/async.php').setMethod('GET').setData({action:'threadlist',seen:false,preview:true}).setReadOnly(true).setHandler(function(){Arbiter.inform.bind(Arbiter,'jewel/messages/fetched').defer(100);}).send();},_onSend:function(){this._dirty=true;},onCounterUpdate:function(){this.parent.onCounterUpdate();if(this._open)this.doRefetch();},_onToggle:function(b,a){this._open=(b=="show");if(this._open)this.doRefetch();},markSeen:function(){new AsyncRequest().setURI('/ajax/messaging/async.php').setMethod('GET').setData({action:'markSeen'}).setReadOnly(true).setHandler(bagofholding).send();}});
function NotificationList(a){this.alertIds=[];this.alertsObj={};this.unreadCount=0;this.contentRoot=a;this.noItemsElement=null;this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';}copy_properties(NotificationList,{ITEM_UNREAD_CLASS:'jewelItemNew',MARK_READ_TYPE:'mark_read',UNREAD_COUNT_CHANGE_TYPE:'unread_count_change',getIdFromDom:function(a){return parseInt(a.getAttribute('id').replace('notification_',''),10);},localizeUrls:function(a){DOM.scry(a,'a').each(function(b){URI(b.href).isFacebookURI()&&(b.href=URI(b.href).getUnqualifiedURI().getQualifiedURI().setSubdomain(URI(b.href).getSubdomain()).toString());});}});Class.mixin(NotificationList,'Arbiter',{reset:function(){for(var a in this.alertsObj)this.remove(a);},fromDom:function(){var e=this.ITEM_TAG+'.'+this.ITEM_CLASS;var c=DOM.scry(this.contentRoot,e);for(var d=c.length-1;d>=0;--d){var b=c[d];var a=NotificationList.getIdFromDom(b);this.insert(a,null);}},insert:function(b,c,d){b=parseInt(b,10);if(this.alertsObj[b])if(!(d&&c)){return false;}else this.remove(b);c&&DOM.prependContent(this.contentRoot,HTML(c));this.alertIds.unshift(b);var a=this.alertsObj[b]=$('notification_'+b),e=CSS.hasClass(a,NotificationList.ITEM_UNREAD_CLASS);NotificationList.localizeUrls(a);if(1==this.size())hide(this.NO_ITEMS_ID);DataStore.set(a,'unread',e);if(e){this.unreadCount++;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);}return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=ge(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=$N(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},_tx("No new notifications."));DOM.appendContent(this.contentRoot,this.noItemsElement);}CSS.show(this.NO_ITEMS_ID);},remove:function(b){var a=this.alertsObj[b];if(!this.alertsObj[b])return false;this.markRead([b]);DOM.remove(a);delete this.alertsObj[b];this.alertIds.splice(this.alertIds.indexOf(b),1);if(this.isEmpty())this.showNoNotifications();return true;},getUnreadIds:function(a){var c=[];a=a||this.alertIds;for(var b=0;b<a.length;b++)if(this.isUnreadId(a[b]))c.push(a[b]);return c;},isUnreadId:function(a){var b=this.alertsObj[a];return (b&&DataStore.get(b,'unread'));},markRead:function(a){a=a?a.filter(this.isUnreadId.bind(this)):this.getUnreadIds();for(var c=0;c<a.length;c++){var b=this.alertsObj[a[c]];if(b){this.inform(NotificationList.MARK_READ_TYPE,b);DataStore.set(b,'unread',false);}}this.unreadCount-=a.length;a.length&&this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);},insertMany:function(d,e){var f=0;if('object'==typeof d&&!is_empty(d)){if(is_empty(e)){e=[];for(var b in d)e.push(b);e.sort(function(g,h){return h-g;});}for(var a=e.length-1;a>=0;--a){var c=e[a];if(this.insert(c,d[c],true))f++;}}if(0===f&&this.isEmpty()){this.showNoNotifications();}else hide(this.NO_ITEMS_ID);return f;},isEmpty:function(){return 0==this.size();},size:function(){return this.alertIds.length;}});function Notifications(a){this.count=a.count||0;this.countNew=a.countNew||0;this.updateTime=a.updateTime||new Date().getTime();this.user=Env.user;this.cache_version=a.cacheVersion||0;this.allowDesktopNotifications=a.allowDesktopNotifications||false;this.latest_notif_time=a.latestNotif||0;this.latest_read_notif_time=a.latestReadNotif||0;this.update_period=a.updatePeriod||60000;this.notifReceivedType=a.notifReceivedType||'notification';this.counterInFront=a.counterInFront||false;this.wrapperID=a.wrapperID||'notificationsWrapper';this.contentID=a.contentID||'jewelNotifs';this.timeElement='small.time';this._init();}Notifications.BEEPS_EXPIRED='beeper/beeps_expired';Notifications.prototype={_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.needMarkRead=false;this.currentFetchRequest=null;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.jewelFlyout=ge('fbNotificationsFlyout');this.loadingIndicator=ge(this.contentID+'_loading_indicator');this.countSpan=ge('presence_notifications_count');NotificationCounter.init(this.counterInFront);this.alertList=new NotificationList(this.content);this._updateCount();window.MinNotifications&&MinNotifications.fetched()&&(this.fetch=bagofholding);Arbiter.subscribe(PresenceMessage.getArbiterMessageType(this.notifReceivedType),this._handleNotificationMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notifications_read'),this._handleNotificationsReadMsg.bind(this));MessagingEvents.subscribe('count/unread',this._updateInboxUnreadCount.bind(this));MessagingEvents.subscribe('count/unseen',this._updateInboxUnseenCount.bind(this));MessagingEvents.subscribe('count/other_unseen',this._updateInboxOtherUnseenCount.bind(this));this._poller=new Poller(this.update_period,this._update.bind(this),true);if(this.wrapper)this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');Arbiter.inform('jewel/count-initial',{jewel:'notifications',count:this.countNew},Arbiter.BEHAVIOR_STATE);this.initializeEvents();this.fromDom();},fromDom:function(){this.alertList.fromDom();},initializeEvents:function(){var a=null;Event.listen(this.content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&b!=a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});Event.listen(this.wrapper,'mouseover',this.onMouseOver.bind(this));Toggler.listen('show',this.wrapper,this.onClick.bind(this));},onMouseOver:function(){this.fetch();},onClick:function(){this.fetch();this.markRead(true);},signalMarkRead:function(a){a=a||[];if(a.length===0&&this.currentFetchRequest){this.needMarkRead=true;return;}data={};for(var b=0;b<a.length;++b)data['alert_ids['+b+']']=a[b];new AsyncSignal('/ajax/notifications/mark_read.php',data).send();},markRead:function(b,a){if(this.countNew===0)return;b&&this.signalMarkRead(a);this.alertList.markRead(a);this._updateCount();},_updateErrorHandler:function(a){},_updateURI:'/ajax/presence/update.php',_update:function(a){a.setHandler(this._handleUpdate.bind(this)).setOption('suppressErrorAlerts',true).setErrorHandler(this._updateErrorHandler.bind(this)).setData({user:this.user,notif_latest:this.latest_notif_time,notif_latest_read:this.latest_read_notif_time}).setURI(this._updateURI).setAllowCrossPageTransition(true);},_updateInboxOtherUnseenCount:function(a,b){CounterDisplay.setCount('other_unseen',b);},_updateInboxUnreadCount:function(a,b){CounterDisplay.setCount('messages_unread',b);},_updateInboxUnseenCount:function(a,b){CounterDisplay.setCount('messages_unseen',b);Arbiter.inform('jewel/count-updated',{jewel:'messages',count:b},Arbiter.BEHAVIOR_STATE);},_handleUpdate:function(b){var a=b.payload.notifications;if(!a.no_change){if(this.count!=a.count)this.count=a.count;this.updateTime=b.payload.time;this.latest_notif_time=a.latest_notif;this.latest_read_notif_time=a.latest_read_notif;this._updateDisplayDelayed();this.alertList.insertMany(a.markup_map,a.order);Arbiter.inform(Arbiter.NEW_NOTIFICATIONS,a);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(Notifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)Arbiter.unsubscribe(this.beepsExpiredToken);},_updateCount:function(){Arbiter.inform('jewel/count-updated',{jewel:'notifications',count:this.countNew},Arbiter.BEHAVIOR_STATE);},fetch:function(){var a=URI('/ajax/notifications/get.php');if(this.currentFetchRequest)return true;a.setQueryData({time:this.latest_notif_time,user:this.user,version:this.cache_version,locale:Env.locale});this.currentFetchRequest=new AsyncRequest().setURI(a).setStatusElement(this.loadingIndicator).setMethod('GET').setReadOnly(true).setTimeoutHandler(30000,this.fetchErrorHandler.bind(this)).setHandler(this.fetchHandler.bind(this)).setErrorHandler(this.fetchErrorHandler.bind(this)).setAllowCrossPageTransition(true);!this.currentFetchRequest.send()&&this.fetchErrorHandler();return true;},fetchErrorHandler:function(a){this.currentFetchRequest=null;},fetchHandler:function(b){var a=b.getPayload();this.alertList.insertMany(a.markup_map,a.order);this.loadingIndicator&&CSS.hide(this.loadingIndicator);this.loadingIndicator=null;this.currentFetchRequest=null;this.fetch=bagofholding;if(this.needMarkRead){this.needMarkRead=false;this.signalMarkRead();}},_mergeNotification:function(b,c,d){var a=!this.alertList.isUnreadId(b);this.alertList.insert(b,c,true);this.latest_notif_time=0;if(a){this.count++;this._updateCount();}if(this.isTabOpen())this._merged_mouseover_handler=Event.listen(this.content,'mouseover',(function(){this._merged_mouseover_handler.remove();this.markRead(true);}).bind(this));},_handleNotificationMsg:function(d,a){var b=a.obj;if(typeof this.useDesktopNotifications=='undefined'){var c;this.useDesktopNotifications=this.allowDesktopNotifications&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0;}if(this.useDesktopNotifications)Bootloader.loadComponents('desktop-notifications',function(){DesktopNotifications.addNotification(b.alert_id);});if(b.markup){this._mergeNotification(b.alert_id,b.markup,b.unread);}else this._poller.requestNow();},_handleNotificationsReadMsg:function(c,a){var b=a.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(false,b.alert_ids);this.markRead(false,b.alert_ids);},isTabOpen:function(){return this.wrapper&&CSS.hasClass(this.wrapper,'openToggler');}};
function OriginalNotifications(a){this.parent.construct(this,a);}Class.extend(OriginalNotifications,'Notifications');copy_properties(OriginalNotifications.prototype,{_init:function(){this.parent._init();this.alertList.subscribe(NotificationList.MARK_READ_TYPE,this._animateMarkRead.bind(this));this.alertList.subscribe(NotificationList.UNREAD_COUNT_CHANGE_TYPE,function(){this.countNew=this.alertList.unreadCount;this._updateCount();}.bind(this));Arbiter.subscribe('jewel/resize',this._hideOverflow.bind(this));},fetchHandler:function(c){this.parent.fetchHandler(c);var b=c.getPayload();var d=b.generated;var a=Math.round((new Date()).getTime()/1000);if(a-d>15)d=a;Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(d);LiveTimer.startLoop(0);});this._hideOverflow();},_mergeNotification:function(a,b,c){this.parent._mergeNotification(a,b,c);var d=this.alertList.alertsObj[a];if(d)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(d);});},_animateMarkRead:function(a,b){animation(b).duration(5000).checkpoint().from('backgroundColor','#EFF1F7').to('backgroundColor','#FFFFFF').duration(2250).ondone(CSS.removeClass.bind(null,b,NotificationList.ITEM_UNREAD_CLASS)).go();},onClick:function(){this.parent.onClick();this._hideOverflow();},_updateCount:function(){this.parent._updateCount();this._hideOverflow();},_hideOverflow:function(){var a=DOM.find(this.jewelFlyout,'.jewelFooter'),d=DOM.scry($('fbNotificationsList'),'.notification');if(!CSS.hasClass(document.body,'fixedPageHead')||!d.length)return;var b=Vector2.getViewportDimensions().y-Vector2.getElementPosition(d[0],'viewport').y-Vector2.getElementDimensions(a).y,c=0;for(;c<d.length&&b>0;++c){CSS.show(d[c]);b-=Vector2.getElementDimensions(d[c]).y;}b<0&&--c;for(;c<d.length;++c)CSS.hide(d[c]);}});
function SearchDataSource(b){this._token=b.token||'';this._lazyonload=b.lazyonload===false?false:true;this._leanOnAllTypes=b.leanOnAllTypes;this._extraTypes=b.extraTypes;var a=b.maxResults||8;this.parent.construct(this,b);this._numResults={min:3,max:a};}Class.extend(SearchDataSource,'DataSource');SearchDataSource.prototype={init:function(){this.parent.init();this._leanPayload=null;this._bootstrapRequestsPending=0;this._criticalOnly=true;this._updateMaxResults();Event.listen(window,'resize',this._updateMaxResults.bind(this));},dirty:function(){this.parent.dirty();this._fetchOnUseRequests=[];},asyncErrorHandler:function(a){if(window.Dialog&&Dialog.getCurrent()==null&&a.getError()==1400003)AsyncResponse.verboseErrorHandler(a);},fetch:function(b,a,c){c=c||{};c.fetch_start=(+new Date());this.parent.fetch(b,a,c);},fetchHandler:function(f,c){var e=f.getPayload();var g=copy_properties({fetch_end:(+new Date())},c);var b=g.value?Arbiter.BEHAVIOR_EVENT:Arbiter.BEHAVIOR_PERSISTENT;this.inform('endpointStats',g,b);if(c.type=='lean'){this._leanPayload=e;this._processLean();}else{this.parent.fetchHandler(f,c);if(c.bootstrap&&!e.no_data&&this._bootstrapRequestsPending>0){if(e.num_remaining_pieces){c.remaining_pieces=e.num_remaining_pieces;for(var d=0;d<e.num_remaining_pieces;++d){var a=copy_properties({},f.getRequest().getData());a.piece_idx=d;this.fetch(this.bootstrapEndpoint,a,c);}}else{--c.remaining_pieces;if(!c.remaining_pieces){c.bootstrap=false;--this._bootstrapRequestsPending;}!this._bootstrapRequestsPending&&this._bootstrapPostProcess();}this.value&&this.respond(this.value,this.buildUids(this.value));}if(e.stale||e.no_data||e.token!==this._token){var a=copy_properties({},f.getRequest().getData());if(a.stale_ok||a.lazy){a.stale_ok=0;a.lazy=0;a.token=this._token;this._fetchOnUse(a,c);}}}},_bootstrapPostProcess:function(){var a={time:(+new Date())};this.inform('bootstrapped',a,Arbiter.BEHAVIOR_PERSISTENT);this._processLean();},_processLean:function(){if(this._leanPayload){var b;var a=this._leanPayload.entries;for(var c in a){b=this.getEntry(c);b&&(b.index=a[c]);}this._leanPayload=null;}},_updateMaxResults:function(){var a=window.innerHeight||document.documentElement.clientHeight;this.setMaxResults(Math.max(this._numResults.min,Math.min(this._numResults.max,Math.ceil(2+((a-370)/56)))));},mergeUids:function(a,c,b,e){var d=function(f,g){var h=this.getEntry(f);var i=this.getEntry(g);if((h.extended_match||false)!==(i.extended_match||false))return h.extended_match?1:-1;if(h.index!==i.index)return h.index-i.index;if(h.text.length!==i.text.length)return h.text.length-i.text.length;if(h.text!==i.text)return h.text<i.text?-1:1;return h.uid<i.uid?-1:1;}.bind(this);this._checkExtendedMatch(e,a);this._checkExtendedMatch(e,c);return a.sort(d).concat(c,b);},_checkExtendedMatch:function(d,c){for(var a=0;a<c.length;++a){var b=this.getEntry(c[a]);b.extended_match=b.tokens&&!TypeaheadUtil.isQueryMatch(d,b.text);}},_multifetch:function(e,b){var d=copy_properties(b,this.bootstrapData);d.stale_ok=1;for(var f=0;f<e.length;++f){var a=copy_properties({filter:e[f]},d);var c={bootstrap:true,remaining_pieces:1,type:e.length===1?e[0]:'other'};this.fetch(this.bootstrapEndpoint,a,c);++this._bootstrapRequestsPending;}},_fetchOnUse:function(a,b){for(var c in this.bootstrapData)!a.hasOwnProperty(c)&&(a[c]=this.bootstrapData[c]);if(this._criticalOnly){this._fetchOnUseRequests.push({args:a,ctx:b});}else this.fetch(this.bootstrapEndpoint,a,b);},_fetchLean:function(){var a={filter:['user'],no_cache:1};if(this._leanOnAllTypes)a={no_cache:1};a.options=$A(a.options);a.options.push('lean');this._fetchOnUse(a,{type:'lean'});},bootstrap:function(a){if(!a){this._criticalOnly=false;this._flushFetchOnUseRequests();}if(this._bootstrapped)return;if(this.bootstrapData.filter){this.fetch(this.bootstrapEndpoint,this.bootstrapData);}else{var b={filter:['event'],no_cache:1};this._fetchOnUse(b,{type:'event'});var d=['app','page','group'];d=d.concat(this._extraTypes||[]);d=[['user'],d];var c=this._criticalOnly&&this._lazyonload?{lazy:1}:{};this._multifetch(d,c);}this._fetchLean();this._bootstrapped=true;},_flushFetchOnUseRequests:function(){var c=this._fetchOnUseRequests.length;for(var b=0;b<c;++b){var a=this._fetchOnUseRequests[b];this.fetch(this.bootstrapEndpoint,a.args,a.ctx);}this._fetchOnUseRequests=[];},onLoad:function(a,b){this.inform('onload',{time:(+new Date())},Arbiter.BEHAVIOR_PERSISTENT);if(a)this.bootstrap.bind(this,b).defer();}};
function SearchTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(SearchTypeaheadCore,'TypeaheadCore');SearchTypeaheadCore.prototype={init:function(a,f,d){this.parent.init(a,f,d);var b=Parent.byTag(d,'form'),c=this.reset.bind(this);if(b){var e=DOM.find(b,'input.search_sid_input');Event.listen(b,'submit',function(){if(this.data&&this.data.queryData)e.value=this.data.queryData.sid;c.defer();}.bind(this),Event.Priority.URGENT);}},select:function(){this.reset();this.element.focus();(function(){this.element.blur();}).bind(this).defer();},handleTab:function(event){var a=this.view.getQuerySuggestion(this.value);if(a){Input.setValue(this.element,a);this.checkValue();event.kill();}else this.parent.handleTab(event);}};
function SearchTypeaheadRecorder(a){this.init(a);this.initEvents();}SearchTypeaheadRecorder.prototype={init:function(a){this.core=a.getCore();this.data=a.getData();this.view=a.getView();this.element=this.core.getElement();this.initTime=this.time();this._onloadTime=0;this.initStartTime=$('search_first_focus').value;this.bootstrapStats={bootstrapped:0};this._reset();},_reset:function(){this.stats={};this.avgStats={};this.appendStats={};this._backspacing=false;var a=Math.random();this.data.setQueryData({sid:a});this.view.setSid(a);this.recordStat('sid',a);},initEvents:function(){this.core.subscribe('focus',function(event){if(!this.stats['session_start_time'])this.recordStat('session_start_time',this.time());}.bind(this));this.core.subscribe('blur',function(event){this.recordStat('session_end_time',this.time());this.submit();}.bind(this));this.view.subscribe('select',function(a,b){this.recordSelectInfo(b);}.bind(this));this.view.subscribe('render',function(a,b){this.recordRender(b);}.bind(this));this.data.subscribe('activity',function(a,b){this.recordStat('pending_request',b.activity);}.bind(this));this.data.subscribe('beforeQuery',function(a,b){if(!b.value)return;if(!this.stats.first_query_time)this.recordStat('first_query_time',this.time());this.query=b.value;this.recordCountStat('num_queries');}.bind(this));this.data.subscribe('queryEndpoint',function(a,b){this.recordCountStat('num_search_ajax_requests');this.recordAvgStat('endpoint_query_length',b.value.length);}.bind(this));this.data.subscribe('onload',function(a,b){this._onloadTime=b.time;}.bind(this));this.data.subscribe('bootstrapped',function(a,b){this.bootstrapStats.endTime=b.time;this.bootstrapStats.bootstrapped=1;}.bind(this));this.data.subscribe('endpointStats',function(a,c){var b=c.fetch_end-c.fetch_start;if(c.value){this.recordAvgStat('search_endpoint_ms_from_js',b);}else this.bootstrapStats[c.type]=b;}.bind(this));this.data.subscribe('query',function(a,b){this.recordAvgStat('num_results_from_cache',b.results.length);}.bind(this));Event.listen(this.element,'keydown',function(event){if(Event.getKeyCode(event)==KEYS.BACKSPACE){if(!this._backspacing){this._backspacing=true;this.recordAppendStat('before_backspace_queries',this.query);}}else this._backspacing=false;}.bind(this));},recordStat:function(a,b){this.stats[a]=b;},recordCountStat:function(a){var b=this.stats[a];this.stats[a]=b?b+1:1;},recordAvgStat:function(a,b){if(this.avgStats[a]){this.avgStats[a][0]+=b;++this.avgStats[a][1];}else this.avgStats[a]=[b,1];},recordAppendStat:function(a,b){if(!this.appendStats.hasOwnProperty(a))this.appendStats[a]=[];this.appendStats[a].push(b);},recordRender:function(a){this.results=a.filter(function(b){return b.type!='calltoaction'&&b.type!='header';});if(this.results.length>0&&!this.stats.first_result_time)this.recordStat('first_result_time',this.time());},recordSelectInfo:function(c){var f=c.selected;var b=c.index-f.groupIndex-1;var d={href:f.path};var a=f.dataGT?{gt:JSON.parse(f.dataGT)}:{};user_action(d,'click',null,null,a);if(f.uid=='search'){this.recordStat('selected_search',1);}else{var g=f.rankType||f.render_type||f.type;var e=(g=='friend'?'user':g);this.recordStat('selected_'+e,1);this.recordStat('selected_position',b);this.recordStat('selected_type',g);this.recordStat('selected_name_length',f.text.length);this.recordStat('selected_id',f.uid);this.recordStat('selected_degree',f.bootstrapped?1:2);this.recordStat('selected_extended_match',f.extended_match);}this.recordStat('selected_with_mouse',c.clicked?1:0);},_dataToSubmit:function(){this.recordStat('candidate_results',this.buildResults());this.recordStat('query',this.query);this.recordStat('init_time',this.initTime);if(this.initStartTime){this.recordStat('init_start_time',this.initStartTime);this.recordStat('onload_time',this._onloadTime);this.initStartTime=0;}this.recordStat('bootstrapped',this.bootstrapStats.bootstrapped);if(this.bootstrapStats.endTime){this.recordStat('bootstrapped_time',this.bootstrapStats.endTime);this.recordStat('user_bootstrap_ms',this.bootstrapStats.user);this.recordStat('other_bootstrap_ms',this.bootstrapStats.other);this.bootstrapStats.endTime=0;}this.recordStat('max_results',this.data.numResults);var b=this.stats;for(var d in this.avgStats){var c=this.avgStats[d];b[d]=c[0]/c[1];}for(var a in this.appendStats)b[a]=JSON.stringify(this.appendStats[a]);return b;},buildResults:function(){var a=(this.results||[]).map(function(d,c){var e=d.rankType||d.render_type||d.type;var b=d.bootstrapped?1:0;if(typeof d.groupIndex=='number')return [d.groupIndex,d.indexInGroup,d.uid,e,b];return [0,c,d.uid,e,b];});return JSON.stringify(a);},submit:function(){var a=this._dataToSubmit();if(count(a)>0)new AsyncRequest().setURI('/ajax/typeahead/record_metrics.php').setMethod('POST').setData({stats:a}).setOption('handleErrorAfterUnload',true).setErrorHandler(function(b){a.retry=true;new AsyncRequest().setURI('/ajax/typeahead/record_metrics.php').setMethod('POST').setData({stats:a}).setOption('asynchronous',false).send();}).send();this._reset();},time:function(){return (new Date()).getTime();}};
function SearchTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(SearchTypeaheadView,'TypeaheadView');SearchTypeaheadView.prototype={popupState:'closed',queryData:{init:'quick'},render:function(e,c,d,a){var b=c.length;c=this.buildBuckets(c);if(e&&!a)c.push(this.buildSeeMore(e,b));if(b>0){this.setPopupState('opened');}else this.setPopupState('closed');this.parent.render(e,c,d);},getEndpoint:function(c){var b=Parent.byTag(this.element,'form');var a=Form.getAttribute(b,'action');return URI(a).addQueryData(this.searchPageQueryData(c))+'';},highlight:function(a,b){if(a==-1&&this.index!==0)a=this.index;if(a>=0&&a<this.items.length&&this.results[a].type=='header')a=a+1;this.parent.highlight(a,b);},setPopupState:function(a){if(a==='opened'&&this.popupState==='closed'){Arbiter.inform("SearchTypeaheadOpened");}else if(a==='closed'&&this.popupState==='opened')Arbiter.inform("SearchTypeaheadClosed");this.popupState=a;},reset:function(a){this.setPopupState('closed');this.parent.reset(a);},show:function(){if(this.element&&this.element.innerHTML)this.setPopupState('opened');this.parent.show();},hide:function(){this.setPopupState('closed');this.parent.hide();},buildBuckets:function(f){var b=[];var h={};for(var d=0;d<f.length;++d){var c=f[d];var g=c.render_type||c.type;if(!h.hasOwnProperty(g)){h[g]=b.length;b.push([this.buildBucketHeader(g)]);}c.classNames=g;c.groupIndex=h[g];c.indexInGroup=b[c.groupIndex].length-1;b[c.groupIndex].push(c);}var a=[];for(var e=0;e<b.length;++e)a=a.concat(b[e]);return a;},buildSeeMore:function(d,b){var a='<span class="seeMore">'+(b>0?_tx("See more results for {query}",{query:htmlize(d)}):_tx("See results for {query}",{query:htmlize(d)}))+'<span class="arrow"></span></span>';if(b>0)a+='<span class="subtext">'+(b==1?_tx("Displaying top result"):_tx("Displaying top {number} results",{number:b}))+'</span>';var c=this.getEndpoint(d);return {uid:'search',text:d,type:'calltoaction',path:c,markup:a};},buildBucketHeader:function(a){return this.typeObjects[a];},renderer:function(c,f){var k=c.markup||htmlize(c.text);var i=htmlize(c.subtext);var a=htmlize(c.category);var g=c.photo;var d=c.is_external;var e='',j='';var b=' class="'+(c.classNames||c.type)+'"';var h=htmlize(c.rColumn);if(c.path){var l=c.path;if(!(/^https?\:\/\//).test(l))l=Env.www_base+l.substr(1);l+=(l.indexOf('?')>0?'&':'?')+'ref=ts';e=' href="'+l+'"';}if(d)j=' target="_blank"';if(a&&d)a+='<span class="arrow"></span>';if(c.type==='query')k=k.toString().replace('&lt;blank&gt;','________').replace(/\{Ent\}/g,'<span class="facebarEnt">').replace(/\{\/Ent\}/g,'</span>').replace(/\{Simple\}/g,'<span class="facebarSimple">').replace(/\{\/Simple\}/g,'</span>');return ['<li',b,'>','<a',e,j,' rel="ignore">',(g?('<img src="'+g+'" alt="" class="photo"/>'):''),(h?('<span class="rColumn">'+h+'</span>'):''),(k?(c.type==='query'?('<span class="facebarText">'+k+'</span>'):('<span class="text">'+k+'</span>')):''),(a?('<span class="category">'+a+'</span>'):''),(i?('<span class="subtext">'+i+'</span>'):''),'</a>','</li>'];},searchPageQueryData:function(b){var a=copy_properties({q:b},this.queryData||{});return a;},select:function(b){var e=this.results[this.index];if(!e||e.type=='header')return;var d=this.index,c=this.items[d],a=DOM.find(c,'a');this.parent.select(b);if(a&&a.href)if(a.target=='_blank'){window.open(a.href);}else goURI(a.href);},buildMarkup:function(a){return '<div class="search">'+this.parent.buildMarkup(a)+'</div>';},setSid:function(a){this.queryData.tas=a;},getQuerySuggestion:function(c){var a=this.results[this.index];var b=a&&a.type!='header'?a.text.toLowerCase():'';return b==c.toLowerCase()?'':b;},getDefaultIndex:function(c){var a=(this.autoSelect&&!this.disableAutoSelect);var b=c.length===0?-1:(c[0].type=='header'?1:0);return this.index<0&&!a?-1:b;},prev:function(){if(this.results[this.index-1]&&this.results[this.index-1].type=='header')this.index--;return this.parent.prev();},next:function(){if(this.results[this.index+1]&&this.results[this.index+1].type=='header')this.index++;return this.parent.next();}};
add_properties('TypeaheadBehaviors',{searchRecorderBasic:function(a){a.subscribe('init',function(b,c){new SearchTypeaheadRecorder(a);});}});
add_properties('TypeaheadBehaviors',{showLoadingIndicator:function(a){a.subscribe('activity',function(b,c){CSS.conditionClass(a.getElement(),'typeaheadLoading',c.activity);});}});
add_properties('TypeaheadRenderers',{basic:function(b,d){var f=b.markup||htmlize(b.text);var e=htmlize(b.subtext);var c=b.icon;var a='';if(b.type)a=' class="'+b.type+'"';return ['<li',a,'>',(c?'<img src="'+c+'" alt=""/>':''),(f?'<span class="text">'+f+'</span>':''),(e?'<span class="subtext">'+e+'</span>':''),'</li>'];}});